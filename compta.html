<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compta Express - Configuration | iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23FF6B35'/%3E%3Cstop offset='1' stop-color='%23FF8B5E'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='50' y='70' font-family='Arial' font-size='60' font-weight='800' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    h1, h2, h3, h4, h5, h6 { font-family: 'Space Grotesk', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #0a0a0a 0%, #0f0a0d 25%, #0a0f0f 50%, #0d0f0a 75%, #0a0a0a 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.25; animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -250px; right: -150px; }
    .orb-2 { width: 400px; height: 400px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -200px; left: -150px; animation-delay: -7s; }
    .orb-3 { width: 250px; height: 250px; background: linear-gradient(135deg, #35FFB8, #5EFFD4); top: 40%; left: 40%; opacity: 0.15; animation-delay: -3s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }
    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
    .glass-card { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); transition: all 0.4s ease; }
    .glass-card:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.4s; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); }
    .logo-i:hover { transform: scale(1.15) rotate(-8deg); box-shadow: 0 0 40px rgba(255,107,53,0.6); }
    .sidebar { background: rgba(255, 255, 255, 0.01); backdrop-filter: blur(20px); width: 280px; min-height: calc(100vh - 70px); padding: 24px; position: fixed; left: 0; top: 70px; z-index: 40; }
    .step-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; margin-bottom: 8px; transition: all 0.3s ease; cursor: pointer; }
    .step-item:hover:not(.upcoming):not(.active) { background: rgba(255, 255, 255, 0.03); }
    .step-item.active { background: rgba(255, 107, 53, 0.08); cursor: default; }
    .step-item.completed { opacity: 0.6; cursor: pointer; }
    .step-item.completed:hover { opacity: 0.8; background: rgba(255, 255, 255, 0.03); }
    .step-item.upcoming { cursor: not-allowed; opacity: 0.3; pointer-events: none; }
    .step-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.08); }
    .step-item.active .step-number { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); }
    .step-item.completed .step-number { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; }
    .step-label { font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.5); }
    .step-item.active .step-label { color: white; }
    .main-content { margin-left: 280px; padding: 40px; max-width: 900px; position: relative; z-index: 10; }
    .step-content { display: none; animation: fadeIn 0.4s ease; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .upload-zone { border: 2px dashed rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 60px 40px; text-align: center; transition: all 0.4s ease; cursor: pointer; background: rgba(255, 255, 255, 0.01); }
    .upload-zone:hover, .upload-zone.dragover { border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 107, 53, 0.03); }
    .chat-container { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 24px; overflow: hidden; max-width: 700px; }
    .chat-header { padding: 20px 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.04); display: flex; align-items: center; gap: 12px; }
    .chat-header-avatar { width: 42px; height: 42px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .chat-messages { padding: 24px; min-height: 300px; max-height: 500px; overflow-y: auto; }
    .chat-msg { margin-bottom: 20px; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .chat-msg-bot { display: flex; gap: 12px; align-items: flex-start; }
    .chat-msg-user { display: flex; gap: 12px; flex-direction: row-reverse; align-items: flex-start; }
    .chat-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; }
    .chat-avatar-bot { background: linear-gradient(135deg, #FF6B35, #FF8B5E); }
    .chat-avatar-user { background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 107, 53, 0.25); color: rgba(255, 139, 94, 0.8); }
    .chat-bubble { padding: 16px 20px; border-radius: 20px; max-width: 85%; line-height: 1.7; font-size: 15px; }
    .chat-bubble-bot { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.06); border-bottom-left-radius: 4px; }
    .chat-bubble-bot strong { color: #FF8B5E; }
    .chat-bubble-user { background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 107, 53, 0.08)); border: 1px solid rgba(255, 107, 53, 0.2); border-bottom-right-radius: 4px; }
    .chat-input-container { padding: 20px 24px; border-top: 1px solid rgba(255, 255, 255, 0.04); display: flex; gap: 12px; }
    .chat-input { flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 14px; padding: 16px 20px; color: white; font-size: 15px; }
    .chat-input:focus { outline: none; border-color: rgba(255, 107, 53, 0.4); }
    .chat-input::placeholder { color: rgba(255, 255, 255, 0.25); }
    .chat-send { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 28px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .chat-send:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .loading-indicator { display: flex; align-items: center; gap: 12px; padding: 14px 20px; background: rgba(255, 255, 255, 0.04); border-radius: 20px; width: fit-content; border-bottom-left-radius: 4px; }
    .loading-bar-wrapper { width: 100px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; }
    .loading-bar-fill { height: 100%; background: linear-gradient(90deg, transparent 0%, #FF6B35 20%, #FF8B5E 50%, #FF6B35 80%, transparent 100%); background-size: 200% 100%; animation: slideBar 1.2s linear infinite; width: 100%; }
    @keyframes slideBar { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    .close-btn { position: fixed; top: 24px; right: 24px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 100; transition: all 0.3s ease; }
    .close-btn:hover { background: rgba(255, 255, 255, 0.08); transform: rotate(90deg); }
    .btn-glow { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); width: 100%; font-size: 15px; text-decoration: none; display: inline-block; text-align: center; }
    .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .btn-glow:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-telegram { background: linear-gradient(135deg, #0088cc, #00aaff); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; width: 100%; font-size: 15px; text-decoration: none; }
    .btn-telegram:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 136, 204, 0.5); }
    .check-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #4ade80); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: popIn 0.5s ease; }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    .btn-logout { background: transparent; border: none; padding: 8px; border-radius: 8px; transition: all 0.2s; color: rgba(255,255,255,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-logout:hover { background: rgba(239,68,68,0.1); color: #ef4444; }
    .welcome-overlay { position: fixed; inset: 0; background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(30px); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
    .welcome-overlay.active { opacity: 1; pointer-events: all; }
    .welcome-logo { width: 100px; height: 100px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 28px; display: flex; align-items: center; justify-content: center; font-size: 52px; font-weight: 800; margin-bottom: 32px; animation: welcomePulse 2s ease-in-out infinite; box-shadow: 0 20px 60px rgba(255, 107, 53, 0.4); }
    @keyframes welcomePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .welcome-title { font-size: 32px; font-weight: 700; margin-bottom: 12px; text-align: center; }
    .welcome-subtitle { font-size: 16px; color: rgba(255, 255, 255, 0.5); margin-bottom: 40px; text-align: center; }
    .welcome-dots { display: flex; gap: 12px; }
    .welcome-dot { width: 12px; height: 12px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 50%; animation: welcomeBounce 1.4s ease-in-out infinite; }
    .welcome-dot:nth-child(2) { animation-delay: 0.2s; }
    .welcome-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes welcomeBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .global-loader { position: fixed; inset: 0; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10001; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .global-loader.active { opacity: 1; pointer-events: all; }
    .loader-spinner { width: 60px; height: 60px; border: 4px solid rgba(255, 107, 53, 0.2); border-top-color: #FF6B35; border-radius: 50%; animation: spinLoader 0.8s linear infinite; margin-bottom: 24px; }
    @keyframes spinLoader { to { transform: rotate(360deg); } }
    .loader-text { font-size: 16px; color: rgba(255, 255, 255, 0.6); }
    /* Modal overlay - ne couvre PAS le header/sidebar */
    .sheets-overlay { position: fixed; top: 70px; left: 280px; right: 0; bottom: 0; background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(20px); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .sheets-overlay.active { opacity: 1; pointer-events: all; }
    .sheets-content { max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; background: rgba(20, 20, 20, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 32px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
    @media (max-width: 768px) { .sheets-overlay { left: 0; top: 70px; } }
    .sheets-header { text-align: center; margin-bottom: 32px; }
    .sheets-header h2 { font-size: 28px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .sheets-header p { color: rgba(255, 255, 255, 0.5); font-size: 16px; }

    /* Search bar for sheets */
    .sheets-search { position: relative; margin-bottom: 24px; }
    .sheets-search input { width: 100%; padding: 16px 20px 16px 52px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; color: white; font-size: 15px; transition: all 0.3s ease; }
    .sheets-search input:focus { outline: none; border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 255, 255, 0.06); }
    .sheets-search input::placeholder { color: rgba(255, 255, 255, 0.3); }
    .sheets-search svg { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.4); pointer-events: none; }

    /* Folder tabs for sheets */
    .sheets-folders { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
    .sheets-folder { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; font-size: 14px; color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.3s ease; }
    .sheets-folder:hover { background: rgba(255, 255, 255, 0.08); color: white; }
    .sheets-folder.active { background: rgba(255, 107, 53, 0.15); border-color: rgba(255, 107, 53, 0.3); color: #FF8B5E; }
    .sheets-folder svg { width: 16px; height: 16px; }

    /* Section title */
    .sheets-section-title { font-size: 12px; font-weight: 600; color: rgba(255, 255, 255, 0.4); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; padding-left: 4px; }

    .sheets-grid { display: grid; gap: 12px; margin-bottom: 24px; }
    .sheet-card { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 20px 24px; display: flex; align-items: center; gap: 20px; cursor: pointer; transition: all 0.3s; }
    .sheet-card:hover { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 107, 53, 0.4); transform: translateX(8px); }
    .sheet-card-icon { width: 52px; height: 52px; background: rgba(15, 157, 88, 0.15); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .sheet-card-icon svg { width: 28px; height: 28px; color: #0f9d58; }
    .sheet-card-info { flex: 1; min-width: 0; }
    .sheet-card-info h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sheet-card-info p { font-size: 13px; color: rgba(255, 255, 255, 0.4); display: flex; align-items: center; gap: 6px; }
    .sheet-card-info p svg { width: 14px; height: 14px; }
    .sheet-card-arrow { color: rgba(255, 255, 255, 0.3); transition: all 0.3s; }
    .sheet-card:hover .sheet-card-arrow { color: #FF6B35; transform: translateX(4px); }

    /* Empty state */
    .sheets-empty { text-align: center; padding: 48px 24px; color: rgba(255, 255, 255, 0.4); }
    .sheets-empty svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    .sheets-empty h4 { font-size: 18px; font-weight: 600; color: white; margin-bottom: 8px; }

    .btn-refresh { width: 100%; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 14px; color: white; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-refresh:hover { background: rgba(255, 255, 255, 0.08); }
    .btn-back { width: 100%; background: transparent; border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px; border-radius: 14px; color: rgba(255, 255, 255, 0.6); cursor: pointer; margin-top: 12px; transition: all 0.3s; }
    .btn-back:hover { background: rgba(255, 255, 255, 0.04); color: white; }
    .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 16px 32px; border-radius: 16px; font-weight: 600; box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4); z-index: 10002; opacity: 0; transition: all 0.4s; }
    .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
    .btn-google-sheets { width: 100%; background: white; color: #3c4043; border: none; border-radius: 14px; padding: 16px 24px; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-google-sheets:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2); }
    .btn-google-sheets.connected { background: linear-gradient(135deg, #0f9d58, #0a7e3e); color: white; }
    @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; padding: 24px; } }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
  <div class="welcome-overlay" id="welcome-overlay">
    <div class="welcome-logo">i</div>
    <h1 class="welcome-title" id="welcome-title">Bienvenue ! üëã</h1>
    <p class="welcome-subtitle" id="welcome-subtitle">Pr√©paration de ton espace...</p>
    <div class="welcome-dots"><div class="welcome-dot"></div><div class="welcome-dot"></div><div class="welcome-dot"></div></div>
  </div>
  <div class="global-loader" id="global-loader">
    <div class="loader-spinner"></div>
    <p class="loader-text" id="loader-text">Chargement...</p>
  </div>
  <div class="sheets-overlay" id="sheets-overlay">
    <div class="sheets-content">
      <div class="sheets-header">
        <h2>
          <svg width="32" height="32" viewBox="0 0 24 24" fill="#0f9d58"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg>
          Mes Google Sheets
        </h2>
        <p>Selectionne le fichier ou le bot ecrira tes donnees</p>
      </div>

      <!-- Search bar -->
      <div class="sheets-search">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input type="text" id="sheets-search-input" placeholder="Rechercher un fichier..." oninput="filterSheetsList(this.value)">
      </div>

      <!-- Folder tabs -->
      <div class="sheets-folders">
        <div class="sheets-folder active" onclick="filterByFolder('all', this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
          Tous
        </div>
        <div class="sheets-folder" onclick="filterByFolder('recent', this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
          Recents
        </div>
        <div class="sheets-folder" onclick="filterByFolder('shared', this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          Partages
        </div>
      </div>

      <!-- Section title -->
      <div class="sheets-section-title">Fichiers disponibles</div>

      <!-- Sheets list -->
      <div class="sheets-grid" id="sheets-grid"></div>

      <button class="btn-refresh" onclick="refreshSheets()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        Rafraichir la liste
      </button>
      <button class="btn-back" onclick="closeSheetsOverlay()">‚Üê Retour</button>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3"><div class="logo-i">i</div><span class="font-semibold text-lg">iArmy</span></a>
      <div id="auth-buttons"></div>
    </div>
  </nav>
  <div class="flex min-h-screen" style="padding-top: 70px;">
    <aside class="sidebar">
      <div class="mb-6"><span class="text-xs text-white/30 uppercase tracking-wider">Configuration</span></div>
      <div id="steps-nav">
        <div class="step-item active"><div class="step-number">1</div><span class="step-label">Ton fichier</span></div>
        <div class="step-item upcoming"><div class="step-number">2</div><span class="step-label">On discute</span></div>
        <div class="step-item upcoming"><div class="step-number">3</div><span class="step-label">Telegram</span></div>
      </div>
    </aside>
    <main class="main-content">
      <a href="index.html" class="close-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></a>
      <div class="step-content active" id="step-1">
        <div class="mb-2"><span class="text-white/30 text-sm">√âtape 1/3</span></div>
        <h1 class="text-3xl font-bold mb-3">Connecte ton fichier</h1>
        <p class="text-white/40 mb-10">Choisis ton mode de travail</p>
        <div class="glass-card p-8 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500/20 to-green-500/5 flex items-center justify-content text-2xl">
              <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><rect x="4" y="4" width="20" height="20" rx="2" fill="#0F9D58"/><path d="M9 11h3v10H9V11zm4 0h3v10h-3V11zm4 0h3v10h-3V11z" fill="white"/></svg>
            </div>
            <div><h3 class="text-xl font-semibold">Google Sheets</h3><span class="text-xs text-green-400 font-medium">‚≠ê Recommand√©</span></div>
          </div>
          <p class="text-white/60 mb-6 leading-relaxed">Connexion directe + √©criture automatique en temps r√©el</p>
          <button id="btn-google-sheets" class="btn-google-sheets" onclick="handleGoogleSheetsClick()">
            <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/><path fill="#34A853" d="M6.3 14.7l6.6 4.8C14.1 16.2 18.7 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.1 2 9.3 6.2 6.3 14.7z"/><path fill="#FBBC05" d="M24 46c5.5 0 10.3-2 14.1-5.3l-6.5-5.5C29.5 37 26.9 38 24 38c-6.1 0-11.2-3.9-13.1-9.3l-6.6 5.1C7.3 41.4 15.1 46 24 46z"/><path fill="#EA4335" d="M46.5 20H24v8.5h11.8c-.8 2.4-2.3 4.5-4.3 6l6.5 5.5C41.8 36.5 46 30.9 46 24c0-1.3-.1-2.6-.5-4z"/></svg>
            <span id="btn-google-sheets-text">Se connecter avec Google</span>
          </button>
        </div>
        <div class="text-center text-white/30 text-sm font-medium mb-6">OU</div>
        <div class="glass-card p-8">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500/20 to-orange-500/5 flex items-center justify-content text-2xl">üìÅ</div>
            <h3 class="text-xl font-semibold">Upload Excel</h3>
          </div>
          <p class="text-white/60 mb-6 leading-relaxed">J'analyse ton fichier existant</p>
          <div class="upload-zone" id="upload-zone">
            <div class="text-5xl mb-4">üìä</div>
            <p class="text-lg font-medium mb-2">Glisse ton fichier ici</p>
            <p class="text-white/40 text-sm mb-4">ou clique pour parcourir</p>
            <div class="flex justify-center gap-2">
              <span class="px-3 py-1 rounded-lg bg-white/5 text-white/50 text-xs font-medium">.xlsx</span>
              <span class="px-3 py-1 rounded-lg bg-white/5 text-white/50 text-xs font-medium">.xls</span>
            </div>
          </div>
          <input type="file" id="file-input" accept=".xlsx,.xls,.csv" class="hidden">
        </div>
        <div class="mt-8 flex items-center justify-center gap-2 text-white/30 text-sm">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
          <span>Tes donn√©es restent confidentielles</span>
        </div>
      </div>
      <div class="step-content" id="step-2">
        <div class="mb-2"><span class="text-white/30 text-sm">√âtape 2/3</span></div>
        <h1 class="text-3xl font-bold mb-3">Parlons de ton fichier</h1>
        <p class="text-white/40 mb-8">Je vais te poser quelques questions pour bien comprendre.</p>
        <div class="chat-container">
          <div class="chat-header"><div class="chat-header-avatar">i</div><div><h3 class="font-semibold">iArmy</h3><p class="text-sm text-white/30">Analyse ton fichier...</p></div></div>
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Ta r√©ponse...">
            <button class="chat-send" id="chat-send-btn">Envoyer</button>
          </div>
        </div>
      </div>
      <div class="step-content" id="step-3">
        <div class="text-center mb-8">
          <div class="check-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
          <h1 class="text-3xl font-bold mb-2">Presque fini ! üéâ</h1>
          <p class="text-white/40">Connecte ton robot Telegram</p>
        </div>
        <div id="telegram-initial" class="glass-card p-8 max-w-lg mx-auto text-center">
          <div class="mb-6">
            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-500/5 flex items-center justify-content text-4xl mb-4">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="#0088cc"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.96 1.25-5.54 3.66-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.37-.49 1.02-.74 3.99-1.74 6.65-2.89 7.99-3.45 3.8-1.6 4.59-1.88 5.1-1.89.11 0 .37.03.54.17.14.12.18.28.2.45-.01.06.01.24 0 .38z"/></svg>
            </div>
            <h3 class="text-xl font-semibold mb-2">Connecte-toi en 1 clic</h3>
            <p class="text-white/50 mb-6">Le bot s'ouvrira automatiquement</p>
          </div>
          <button id="connect-telegram-btn" onclick="connectTelegram()" class="btn-telegram w-full">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.96 1.25-5.54 3.66-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.37-.49 1.02-.74 3.99-1.74 6.65-2.89 7.99-3.45 3.8-1.6 4.59-1.88 5.1-1.89.11 0 .37.03.54.17.14.12.18.28.2.45-.01.06.01.24 0 .38z"/></svg>
            Connecter Telegram
          </button>
          <p class="text-xs text-white/30 mt-4">üîí Connexion s√©curis√©e par token unique</p>
        </div>
        <div id="telegram-connecting" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="welcome-dots mb-6" style="justify-content: center;"><div class="welcome-dot"></div><div class="welcome-dot"></div><div class="welcome-dot"></div></div>
          <h3 class="text-xl font-semibold mb-2">En attente de connexion...</h3>
          <p class="text-white/50 mb-4">Clique sur "D√©marrer" dans Telegram</p>
          <a id="telegram-link-fallback" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">üëâ Ouvrir manuellement</a>
        </div>
        <div id="telegram-connected" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="check-icon mx-auto"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
          <h3 class="text-2xl font-bold mb-2">Telegram connect√© ! üéâ</h3>
          <p class="text-white/50 mb-6">Tu peux maintenant utiliser ton robot</p>
          <a href="compte.html" class="btn-glow">Aller √† mon espace</a>
        </div>
      </div>
    </main>
  </div>
  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODY1MTIsImV4cCI6MjA4MzQ2MjUxMn0.1W2OaRb0sApMvrG_28AoV2zUFAzrptzpwbR1c65tOPo';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const GOOGLE_CLIENT_ID = '550060390462-snigimufjktpnf13ip48cv5ioork1ur0.apps.googleusercontent.com';
    
    let currentUser = null, userProvider = null, hasGoogleSheetsAccess = false, excelData = null, chatHistory = [], finalConfig = null, isWaitingForAI = false, connectionCheckInterval = null;
    const HEADER_KEYWORDS = ['cb', 'esp', 'tr', 'date', 'jour', 'recette', 'total', 'd√©pense', 'depense', 'esp√®ce', 'espece', 'carte', 'ticket', 'ch√®que', 'cheque', 'virement', 'vente', 'ca', 'tva', 'ht', 'ttc', 'montant'];

    function showWelcome(firstName) { document.getElementById('welcome-title').textContent = 'Bienvenue ' + firstName + ' ! üëã'; document.getElementById('welcome-subtitle').textContent = 'Pr√©paration de ton espace...'; document.getElementById('welcome-overlay').classList.add('active'); }
    function hideWelcome() { document.getElementById('welcome-overlay').classList.remove('active'); }
    function showLoader(text) { document.getElementById('loader-text').textContent = text; document.getElementById('global-loader').classList.add('active'); }
    function hideLoader() { document.getElementById('global-loader').classList.remove('active'); }
    function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('active'); setTimeout(function() { toast.classList.remove('active'); }, 3000); }
    function formatDate(dateString) { const date = new Date(dateString); const diff = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24)); if (diff === 0) return "aujourd'hui"; if (diff === 1) return "hier"; if (diff < 7) return 'il y a ' + diff + ' jours'; return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }); }

    async function initComptaPage() {
      console.log('[COMPTA] üöÄ Init');
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { window.location.href = 'index.html'; return; }
      currentUser = session.user;
      userProvider = session.user.app_metadata?.provider || 'email';
      console.log('[COMPTA] ‚úÖ Connect√©:', currentUser.email);
      const firstName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.user_metadata?.name?.split(' ')[0] || currentUser.email?.split('@')[0] || 'toi';
      showWelcome(firstName);
      await updateNavBar();
      await checkGoogleSheetsAccess();
      updateGoogleSheetsButton();
      setTimeout(function() { hideWelcome(); }, 1500);
      setupUploadZone();
    }

    async function checkGoogleSheetsAccess() {
      const { data: credentials } = await supabaseClient.from('google_credentials').select('refresh_token').eq('user_id', currentUser.id).single();
      hasGoogleSheetsAccess = !!(credentials && credentials.refresh_token);
      console.log('[COMPTA]', hasGoogleSheetsAccess ? '‚úÖ Google Sheets autoris√©' : '‚ùå Pas encore autoris√©');
    }

    function updateGoogleSheetsButton() {
      const btn = document.getElementById('btn-google-sheets');
      if (hasGoogleSheetsAccess) { btn.classList.add('connected'); btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg><span>Choisir mon fichier</span>'; }
      else if (userProvider === 'google') { btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="#0f9d58"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg><span>Autoriser l\'acc√®s √† Google Sheets</span>'; }
      else { btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/><path fill="#34A853" d="M6.3 14.7l6.6 4.8C14.1 16.2 18.7 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.1 2 9.3 6.2 6.3 14.7z"/><path fill="#FBBC05" d="M24 46c5.5 0 10.3-2 14.1-5.3l-6.5-5.5C29.5 37 26.9 38 24 38c-6.1 0-11.2-3.9-13.1-9.3l-6.6 5.1C7.3 41.4 15.1 46 24 46z"/><path fill="#EA4335" d="M46.5 20H24v8.5h11.8c-.8 2.4-2.3 4.5-4.3 6l6.5 5.5C41.8 36.5 46 30.9 46 24c0-1.3-.1-2.6-.5-4z"/></svg><span>Se connecter avec Google</span>'; }
    }

    async function handleGoogleSheetsClick() { if (hasGoogleSheetsAccess) await openSheetsPicker(); else authorizeGoogleSheets(); }

    function authorizeGoogleSheets() {
      var REDIRECT_URI = window.location.origin + window.location.pathname;
      var SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly';
      var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=' + GOOGLE_CLIENT_ID + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) + '&response_type=code&scope=' + encodeURIComponent(SCOPES) + '&access_type=offline&prompt=consent&state=sheets_auth';
      if (currentUser?.email) authUrl += '&login_hint=' + encodeURIComponent(currentUser.email);
      window.location.href = authUrl;
    }

    async function handleSheetsCallback() {
      var urlParams = new URLSearchParams(window.location.search);
      var code = urlParams.get('code'), state = urlParams.get('state');
      if (!code || state !== 'sheets_auth') return false;
      console.log('[COMPTA] üîÑ Processing Sheets callback...');
      showLoader('Connexion √† Google Sheets...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) throw new Error('Session expir√©e');
        var response = await fetch(SUPABASE_URL + '/functions/v1/google-sheets-auth', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY }, body: JSON.stringify({ code: code, redirect_uri: window.location.origin + window.location.pathname }) });
        var result = await response.json();
        if (!result.success) throw new Error(result.error || '√âchec');
        console.log('[COMPTA] ‚úÖ Sheets connect√© !');
        window.history.replaceState({}, document.title, window.location.pathname);
        hasGoogleSheetsAccess = true;
        hideLoader();
        showToast('‚úÖ Google Sheets connect√© !');
        if (result.sheets?.length > 0) showSheetsOverlay(result.sheets); else showNoSheetsMessage();
        updateGoogleSheetsButton();
        return true;
      } catch (error) { console.error('[COMPTA] ‚ùå', error); hideLoader(); alert('Erreur: ' + error.message); window.history.replaceState({}, document.title, window.location.pathname); return false; }
    }

    async function openSheetsPicker() {
      showLoader('Chargement de tes fichiers...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        var apiUrl = SUPABASE_URL + '/functions/v1/list-google-sheets';
        console.log('[SHEETS] ====== FETCH START ======');
        console.log('[SHEETS] URL:', apiUrl);
        console.log('[SHEETS] Token:', session.access_token ? 'OK (length: ' + session.access_token.length + ')' : 'MISSING');
        var response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY } });
        console.log('[SHEETS] Response status:', response.status);
        var result = await response.json();
        console.log('[SHEETS] API Response:', result);
        console.log('[SHEETS] Total files received:', result.sheets?.length || 0);
        console.log('[SHEETS] ====== FETCH END ======');

        // Debug: chercher "recette 25"
        if (result.sheets) {
          var recette = result.sheets.find(function(s) { return s.name.toLowerCase().includes('recette'); });
          console.log('[SHEETS] Files containing "recette":', result.sheets.filter(function(s) { return s.name.toLowerCase().includes('recette'); }));

          // Log first 20 files
          console.log('[SHEETS] First 20 files:', result.sheets.slice(0, 20).map(function(s) { return s.name; }));
        }

        hideLoader();
        if (!result.success) throw new Error(result.error);
        if (result.sheets?.length > 0) showSheetsOverlay(result.sheets); else showNoSheetsMessage();
      } catch (error) { console.error('[SHEETS] Error:', error); hideLoader(); alert('Erreur: ' + error.message); }
    }

    var allSheets = []; // Store all sheets for filtering
    var currentFilter = 'all';
    var showAllFiles = false;
    var MAX_FILES = 10;

    function showSheetsOverlay(sheets) {
      console.log('[SHEETS] showSheetsOverlay called with', sheets.length, 'sheets');
      // Sort by most recent first
      allSheets = sheets.slice().sort(function(a, b) {
        return new Date(b.modifiedTime) - new Date(a.modifiedTime);
      });
      console.log('[SHEETS] allSheets stored:', allSheets.length);
      currentFilter = 'all';
      showAllFiles = false;
      document.getElementById('sheets-search-input').value = '';
      // Reset folder tabs
      document.querySelectorAll('.sheets-folder').forEach(function(f, i) { f.classList.toggle('active', i === 0); });
      var filtered = getFilteredSheets();
      console.log('[SHEETS] getFilteredSheets returned:', filtered.length);
      renderSheetsList(filtered);
      document.getElementById('sheets-overlay').classList.add('active');
    }

    function getFilteredSheets() {
      console.log('[SHEETS] getFilteredSheets - currentFilter:', currentFilter, 'allSheets:', allSheets.length);
      var filtered = allSheets;
      if (currentFilter === 'recent') {
        // Already sorted by date, just return all (limit handled by renderSheetsList)
        filtered = allSheets;
      } else if (currentFilter === 'shared') {
        filtered = allSheets.filter(function(sheet) { return sheet.shared === true; });
      }
      console.log('[SHEETS] getFilteredSheets returning:', filtered.length);
      return filtered;
    }

    function renderSheetsList(sheets) {
      console.log('[SHEETS] renderSheetsList called with', sheets.length, 'sheets, showAllFiles:', showAllFiles);
      var grid = document.getElementById('sheets-grid');
      if (sheets.length === 0) {
        grid.innerHTML = '<div class="sheets-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg><h4>Aucun fichier trouve</h4><p>Essayez une autre recherche</p></div>';
        return;
      }
      // Limit to MAX_FILES unless showAllFiles is true
      var displaySheets = showAllFiles ? sheets : sheets.slice(0, MAX_FILES);
      var hasMore = sheets.length > MAX_FILES && !showAllFiles;
      console.log('[SHEETS] Displaying', displaySheets.length, 'sheets, hasMore:', hasMore);

      var html = displaySheets.map(function(sheet) {
        return '<div class="sheet-card" onclick="selectSheet({id:\'' + sheet.id + '\',name:\'' + sheet.name.replace(/'/g, "\\'") + '\'})">' +
          '<div class="sheet-card-icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg></div>' +
          '<div class="sheet-card-info"><h3>' + sheet.name + '</h3><p><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' + formatDate(sheet.modifiedTime) + '</p></div>' +
          '<svg class="sheet-card-arrow" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>';
      }).join('');

      if (hasMore) {
        html += '<div onclick="showMoreFiles()" style="text-align: center; padding: 16px; color: rgba(255,255,255,0.5); cursor: pointer; border: 1px dashed rgba(255,255,255,0.15); border-radius: 16px; margin-top: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor=\'rgba(255,107,53,0.4)\';this.style.color=\'#FF8B5E\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.15)\';this.style.color=\'rgba(255,255,255,0.5)\'">Voir ' + (sheets.length - MAX_FILES) + ' fichiers de plus...</div>';
      }
      grid.innerHTML = html;
    }

    function showMoreFiles() {
      showAllFiles = true;
      renderSheetsList(getFilteredSheets());
    }

    function filterSheetsList(query) {
      var q = query.toLowerCase();
      showAllFiles = false;
      if (!q) {
        renderSheetsList(getFilteredSheets());
        return;
      }
      var filtered = allSheets.filter(function(sheet) {
        return sheet.name.toLowerCase().includes(q);
      });
      renderSheetsList(filtered);
    }

    function filterByFolder(folder, element) {
      console.log('[SHEETS] filterByFolder called:', folder);
      // Update active state
      document.querySelectorAll('.sheets-folder').forEach(function(f) { f.classList.remove('active'); });
      element.classList.add('active');
      currentFilter = folder;
      showAllFiles = false;
      document.getElementById('sheets-search-input').value = '';
      var filtered = getFilteredSheets();
      console.log('[SHEETS] After filter, rendering', filtered.length, 'sheets');
      renderSheetsList(filtered);
    }

    function showNoSheetsMessage() {
      allSheets = [];
      document.getElementById('sheets-grid').innerHTML = '<div class="sheets-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg><h4>Aucun fichier trouve</h4><p>Cree un Google Sheet et reviens ici</p></div><a href="https://sheets.google.com/create" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #0f9d58, #0a7e3e); padding: 14px 24px; border-radius: 12px; color: white; text-decoration: none; font-weight: 600; margin-top: 16px; justify-content: center; width: 100%;">+ Creer un Google Sheet</a>';
      document.getElementById('sheets-overlay').classList.add('active');
    }
    function closeSheetsOverlay() { document.getElementById('sheets-overlay').classList.remove('active'); }
    async function refreshSheets() {
      // Force refresh from Google API
      console.log('[SHEETS] ====== REFRESH START ======');
      showLoader('Actualisation des fichiers...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        var apiUrl = SUPABASE_URL + '/functions/v1/list-google-sheets';
        console.log('[SHEETS] URL:', apiUrl);
        var response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY,
            'Cache-Control': 'no-cache'
          },
          body: JSON.stringify({ forceRefresh: true })
        });
        console.log('[SHEETS] Response status:', response.status);
        var result = await response.json();
        console.log('[SHEETS] Refresh response:', result);
        console.log('[SHEETS] Refresh got', result.sheets?.length || 0, 'sheets');
        console.log('[SHEETS] ====== REFRESH END ======');

        // Debug: chercher "recette"
        if (result.sheets) {
          console.log('[SHEETS] Files containing "recette":', result.sheets.filter(function(s) { return s.name.toLowerCase().includes('recette'); }));
        }

        hideLoader();
        if (!result.success) throw new Error(result.error);
        if (result.sheets?.length > 0) {
          showSheetsOverlay(result.sheets);
          showToast('Liste actualisee ! (' + result.sheets.length + ' fichiers)');
        } else {
          showNoSheetsMessage();
        }
      } catch (error) {
        console.error('[SHEETS] Refresh error:', error);
        hideLoader();
        alert('Erreur: ' + error.message);
      }
    }

    async function selectSheet(sheet) {
      console.log('[COMPTA] üìÑ Sheet s√©lectionn√©:', sheet.name);
      closeSheetsOverlay();
      showLoader('Analyse de "' + sheet.name + '"...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        await supabaseClient.from('google_credentials').update({ sheet_id: sheet.id, sheet_name: sheet.name }).eq('user_id', session.user.id);
        var response = await fetch(SUPABASE_URL + '/functions/v1/read-google-sheet', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY }, body: JSON.stringify({ sheetId: sheet.id }) });
        var result = await response.json();
        if (!result.success) throw new Error(result.error);
        excelData = result.excelData;
        console.log('[COMPTA] üìä Donn√©es Sheet:', excelData);
        hideLoader();
        showToast('‚úÖ "' + sheet.name + '" charg√© !');
        goToStep(2);
        await startAnalysis();
      } catch (error) { console.error('[COMPTA] ‚ùå', error); hideLoader(); alert('Erreur: ' + error.message); }
    }

    async function updateNavBar() {
      var authButtons = document.getElementById('auth-buttons');
      if (!currentUser) { authButtons.innerHTML = '<a href="index.html">Retour</a>'; return; }
      var userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.user_metadata?.name?.split(' ')[0] || currentUser.email?.split('@')[0] || 'User';
      var userAvatar = currentUser.user_metadata?.avatar_url || 'https://ui-avatars.com/api/?name=' + userName + '&background=FF6B35&color=fff';
      authButtons.innerHTML = '<div style="display: flex; align-items: center; gap: 8px;"><a href="compte.html" style="display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: white;"><img src="' + userAvatar + '" style="width: 28px; height: 28px; border-radius: 50%;"><span style="font-weight: 500; font-size: 14px;">' + userName + '</span></a><button onclick="signOut()" class="btn-logout" title="Deconnexion"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button></div>';
    }
    async function signOut() { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

    function setupUploadZone() {
      var uploadZone = document.getElementById('upload-zone'), fileInput = document.getElementById('file-input');
      if (uploadZone && fileInput) {
        uploadZone.addEventListener('click', function() { fileInput.click(); });
        uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragover'); });
        uploadZone.addEventListener('drop', function(e) { e.preventDefault(); uploadZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', function(e) { if (e.target.files[0]) handleFile(e.target.files[0]); });
      }
      document.getElementById('chat-input')?.addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });
      document.getElementById('chat-send-btn')?.addEventListener('click', sendMessage);
    }
    
    function detectHeaderRow(rows) { var bestRow = null, bestScore = 0; rows.forEach(function(row) { if (row.row === '...') return; var score = 0; row.cells.forEach(function(cell) { var val = String(cell.val).toLowerCase(); HEADER_KEYWORDS.forEach(function(kw) { if (val.includes(kw)) score++; }); }); if (score > bestScore) { bestScore = score; bestRow = row; } }); return bestRow; }
    
    async function handleFile(file) {
      var ext = '.' + file.name.split('.').pop().toLowerCase();
      if (!['.xlsx', '.xls', '.csv'].includes(ext)) { alert('Format non support√©'); return; }
      goToStep(2);
      var reader = new FileReader();
      reader.onload = async function(e) {
        try {
          var data = new Uint8Array(e.target.result);
          var workbook = XLSX.read(data, { type: 'array', cellFormula: true });
          excelData = { fileName: file.name, sheets: [], isGoogleSheet: false };
          workbook.SheetNames.forEach(function(sheetName, sheetIndex) {
            var sheet = workbook.Sheets[sheetName];
            if (!sheet['!ref']) return;
            var range = XLSX.utils.decode_range(sheet['!ref']);
            if (sheetIndex > 0) { excelData.sheets.push({ name: sheetName, allRows: [], rowCount: range.e.r, colCount: range.e.c + 1, formulas: {}, detectedHeaders: null }); return; }
            var allRows = [], maxCol = Math.min(range.e.c, 20);
            var readRow = function(row) { var rowData = []; for (var col = 0; col <= maxCol; col++) { var cellAddress = XLSX.utils.encode_cell({ r: row, c: col }); var cell = sheet[cellAddress]; var colLetter = col < 26 ? String.fromCharCode(65 + col) : 'A' + String.fromCharCode(65 + col - 26); if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') { rowData.push({ col: colLetter, val: typeof cell.v === 'number' ? (cell.v % 1 === 0 ? cell.v : cell.v.toFixed(2)) : String(cell.v).substring(0, 30) }); } } return rowData; };
            for (var row = 0; row <= Math.min(15, range.e.r); row++) { var rowData = readRow(row); if (rowData.length > 0) allRows.push({ row: row + 1, cells: rowData }); }
            if (range.e.r > 20) { allRows.push({ row: '...', cells: [{ col: '-', val: '(lignes masqu√©es)' }] }); for (var row2 = Math.max(16, range.e.r - 10); row2 <= range.e.r; row2++) { var rowData2 = readRow(row2); if (rowData2.length > 0) allRows.push({ row: row2 + 1, cells: rowData2 }); } }
            var headerRow = detectHeaderRow(allRows);
            var detectedHeaders = headerRow ? { rowNumber: headerRow.row, columns: headerRow.cells.map(function(c) { return { letter: c.col, name: c.val }; }) } : null;
            var formulas = {}; var formulaCount = 0;
            for (var cellRef in sheet) { if (cellRef[0] !== '!' && sheet[cellRef].f && formulaCount < 20) { formulas[cellRef] = sheet[cellRef].f; formulaCount++; } }
            excelData.sheets.push({ name: sheetName, allRows: allRows, rowCount: range.e.r, colCount: range.e.c + 1, formulas: formulas, detectedHeaders: detectedHeaders });
          });
          await startAnalysis();
        } catch (err) { console.error(err); addBotMessage("Hmm, j'ai eu un probl√®me. Tu peux r√©essayer ?"); }
      };
      reader.readAsArrayBuffer(file);
    }

    function addBotMessage(text) { var container = document.getElementById('chat-messages'); document.getElementById('typing-indicator')?.remove(); var msgDiv = document.createElement('div'); msgDiv.className = 'chat-msg chat-msg-bot'; msgDiv.innerHTML = '<div class="chat-avatar chat-avatar-bot">i</div><div class="chat-bubble chat-bubble-bot">' + text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + '</div>'; container.appendChild(msgDiv); container.scrollTop = container.scrollHeight; chatHistory.push({ role: 'assistant', content: text }); }
    function addUserMessage(text) { var container = document.getElementById('chat-messages'); var msgDiv = document.createElement('div'); msgDiv.className = 'chat-msg chat-msg-user'; msgDiv.innerHTML = '<div class="chat-avatar chat-avatar-user"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="chat-bubble chat-bubble-user">' + text + '</div>'; container.appendChild(msgDiv); container.scrollTop = container.scrollHeight; chatHistory.push({ role: 'user', content: text }); }
    function showTyping() { var container = document.getElementById('chat-messages'); var typingDiv = document.createElement('div'); typingDiv.className = 'chat-msg chat-msg-bot'; typingDiv.id = 'typing-indicator'; typingDiv.innerHTML = '<div class="chat-avatar chat-avatar-bot">i</div><div class="loading-indicator"><div class="loading-bar-wrapper"><div class="loading-bar-fill"></div></div><div style="margin-left: 8px;"><span style="font-size:13px;color:rgba(255,255,255,0.4)">Analyse...</span></div></div>'; container.appendChild(typingDiv); container.scrollTop = container.scrollHeight; }
    
    async function callAPI(mode) { var response = await fetch(SUPABASE_URL + '/functions/v1/clever-processor', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY, 'apikey': SUPABASE_ANON_KEY }, body: JSON.stringify({ excelData: excelData, chatHistory: chatHistory, mode: mode }) }); var result = await response.json(); if (result.error) throw new Error(result.error); return result.response; }
    
    async function startAnalysis() { showTyping(); isWaitingForAI = true; try { var response = await callAPI('analyze'); addBotMessage(response); } catch (err) { console.error(err); addBotMessage("J'ai eu un souci. Tu peux me d√©crire comment tu fais ta compta ?"); } isWaitingForAI = false; }
    
    async function sendMessage() {
      var input = document.getElementById('chat-input'), text = input.value.trim();
      if (!text || isWaitingForAI) return;
      input.value = '';
      addUserMessage(text);
      showTyping();
      isWaitingForAI = true;
      try {
        var response = await callAPI('chat');
        var cleanResponse = response.trim();
        if (cleanResponse.includes('```json')) cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          finalConfig = JSON.parse(jsonMatch[0]);
          await supabaseClient.from('user_configs').upsert({ user_id: currentUser.id, excel_config: finalConfig, sheet_id: excelData?.sheetId || null }, { onConflict: 'user_id' });
          var colonnes = finalConfig.colonnes_a_remplir?.map(function(c) { return c.nom; }).join(', ') || 'CB, ESP, TR, D√©penses';
          addBotMessage('‚úÖ Parfait ! J\'ai tout compris !\n\nüìä Colonnes d√©tect√©es : ' + colonnes + '\n\nDerni√®re √©tape : connecte Telegram ! üöÄ');
          setTimeout(function() { goToStep(3); }, 1500);
        } else { addBotMessage(response); }
      } catch (err) { console.error(err); addBotMessage("D√©sol√©, j'ai eu un probl√®me. Tu peux r√©p√©ter ?"); }
      isWaitingForAI = false;
    }

    function goToStep(step) { document.querySelectorAll('.step-item').forEach(function(item, i) { item.classList.remove('active', 'completed', 'upcoming'); if (i < step - 1) item.classList.add('completed'); else if (i === step - 1) item.classList.add('active'); else item.classList.add('upcoming'); }); document.querySelectorAll('.step-content').forEach(function(c) { c.classList.remove('active'); }); document.getElementById('step-' + step).classList.add('active'); if (step === 3) checkExistingTelegramConnection(); }

    async function connectTelegram() {
      var btn = document.getElementById('connect-telegram-btn');
      btn.disabled = true; btn.textContent = 'G√©n√©ration du lien...';
      try {
        var token = crypto.randomUUID(), expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
        var { error } = await supabaseClient.from('connection_tokens').insert({ user_id: currentUser.id, token: token, expires_at: expiresAt.toISOString(), used: false });
        if (error) throw error;
        var telegramLink = 'https://t.me/IArmyBOT?start=' + token;
        document.getElementById('telegram-initial').style.display = 'none';
        document.getElementById('telegram-connecting').style.display = 'block';
        document.getElementById('telegram-link-fallback').href = telegramLink;
        window.open(telegramLink, '_blank');
        startConnectionCheck();
      } catch (err) { alert('Erreur : ' + err.message); btn.disabled = false; btn.textContent = 'Connecter Telegram'; }
    }
    
    function startConnectionCheck() { connectionCheckInterval = setInterval(async function() { try { var { data } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', currentUser.id).maybeSingle(); if (data?.telegram_user_id) { clearInterval(connectionCheckInterval); showTelegramConnected(); } } catch (err) {} }, 3000); }
    function showTelegramConnected() { document.getElementById('telegram-connecting').style.display = 'none'; document.getElementById('telegram-connected').style.display = 'block'; }
    async function checkExistingTelegramConnection() { if (!currentUser) return; try { var { data } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', currentUser.id).maybeSingle(); if (data?.telegram_user_id) { document.getElementById('telegram-initial').style.display = 'none'; showTelegramConnected(); } } catch (err) {} }

    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[COMPTA] üì± Page charg√©e');
      var urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('code') && urlParams.get('state') === 'sheets_auth') { console.log('[COMPTA] üîÑ Callback OAuth Sheets'); await handleSheetsCallback(); }
      await initComptaPage();
    });
  </script>
</body>
</html>
