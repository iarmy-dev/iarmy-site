<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compta Express - Configuration | iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23FF6B35'/%3E%3Cstop offset='1' stop-color='%23FF8B5E'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='50' y='70' font-family='Arial' font-size='60' font-weight='800' fill='white' text-anchor='middle'%3Ei%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    h1, h2, h3, h4, h5, h6 { font-family: 'Space Grotesk', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #0a0a0a 0%, #0f0a0d 25%, #0a0f0f 50%, #0d0f0a 75%, #0a0a0a 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.25; animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -250px; right: -150px; }
    .orb-2 { width: 400px; height: 400px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -200px; left: -150px; animation-delay: -7s; }
    .orb-3 { width: 250px; height: 250px; background: linear-gradient(135deg, #35FFB8, #5EFFD4); top: 40%; left: 40%; opacity: 0.15; animation-delay: -3s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }
    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.04); }
    .glass-card { background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); transition: all 0.4s ease; }
    .glass-card:hover { background: rgba(255, 255, 255, 0.06); border-color: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.4s; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); }
    .logo-i:hover { transform: scale(1.15) rotate(-8deg); box-shadow: 0 0 40px rgba(255,107,53,0.6); }
    .sidebar { background: rgba(255, 255, 255, 0.01); backdrop-filter: blur(20px); width: 280px; min-height: calc(100vh - 70px); padding: 24px; position: fixed; left: 0; top: 70px; z-index: 40; }
    .step-item { display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; margin-bottom: 8px; transition: all 0.3s ease; cursor: pointer; }
    .step-item:hover:not(.upcoming):not(.active) { background: rgba(255, 255, 255, 0.03); }
    .step-item.active { background: rgba(255, 107, 53, 0.08); cursor: default; }
    .step-item.completed { opacity: 0.6; cursor: pointer; }
    .step-item.completed:hover { opacity: 0.8; background: rgba(255, 255, 255, 0.03); }
    .step-item.upcoming { cursor: not-allowed; opacity: 0.3; pointer-events: none; }
    .step-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; background: rgba(255, 255, 255, 0.03); border: 2px solid rgba(255, 255, 255, 0.08); }
    .step-item.active .step-number { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-color: transparent; box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); }
    .step-item.completed .step-number { background: linear-gradient(135deg, #22c55e, #4ade80); border-color: transparent; }
    .step-label { font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.5); }
    .step-item.active .step-label { color: white; }
    .main-content { margin-left: 280px; padding: 40px; max-width: 900px; position: relative; z-index: 10; }
    .step-content { display: none; animation: fadeIn 0.4s ease; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .upload-zone { border: 2px dashed rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 60px 40px; text-align: center; transition: all 0.4s ease; cursor: pointer; background: rgba(255, 255, 255, 0.01); }
    .upload-zone:hover, .upload-zone.dragover { border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 107, 53, 0.03); }
    #drop-area.dragover { border-color: rgba(255, 107, 53, 0.5) !important; background: rgba(255, 107, 53, 0.08) !important; }
    #drop-area.dragover svg { stroke: #FF6B35; }
    #drop-area.dragover p { color: #FF8B5E; }
    /* Template column states */
    .template-col { user-select: none; transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s, box-shadow 0.2s, background 0.2s, border-color 0.2s; position: relative; }
    .template-col.editing { background: rgba(255, 107, 53, 0.15) !important; border-color: rgba(255, 107, 53, 0.4) !important; cursor: text !important; box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2); }
    .template-col.editing .drag-handle { opacity: 0.2 !important; }
    .template-col .col-name { cursor: text; }
    .template-col:active:not(.editing) { cursor: grabbing; }
    /* Drag states */
    .template-col.dragging { opacity: 0.4; transform: scale(0.98); }
    .template-col.just-dropped { animation: dropBounce 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .template-col.just-added { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes dropBounce { 0% { transform: scale(0.95); opacity: 0.6; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
    @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    /* Drop indicator - ligne subtile entre les colonnes */
    .drop-indicator { width: 2px; height: 24px; background: rgba(255, 255, 255, 0.5); border-radius: 1px; flex-shrink: 0; animation: indicatorFade 1.2s ease-in-out infinite; }
    @keyframes indicatorFade { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    /* Drag ghost - √©l√©ment flottant qui suit la souris */
    .drag-ghost { position: fixed; pointer-events: none; z-index: 10000; padding: 6px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; font-size: 12px; color: white; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transform: rotate(2deg); backdrop-filter: blur(8px); }
    #template-columns { min-height: 36px; padding: 4px; margin: -4px; border-radius: 12px; transition: background 0.2s; }
    #template-columns.drag-active { background: rgba(255, 255, 255, 0.02); }
    .chat-container { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 24px; overflow: hidden; max-width: 700px; }
    .chat-header { padding: 20px 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.04); display: flex; align-items: center; gap: 12px; }
    .chat-header-avatar { width: 42px; height: 42px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .chat-messages { padding: 24px; min-height: 300px; max-height: 500px; overflow-y: auto; }
    .chat-msg { margin-bottom: 20px; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .chat-msg-bot { display: flex; gap: 12px; align-items: flex-start; }
    .chat-msg-user { display: flex; gap: 12px; flex-direction: row-reverse; align-items: flex-start; }
    .chat-avatar { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; }
    .chat-avatar-bot { background: linear-gradient(135deg, #FF6B35, #FF8B5E); }
    .chat-avatar-user { background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 107, 53, 0.25); color: rgba(255, 139, 94, 0.8); }
    .chat-bubble { padding: 16px 20px; border-radius: 20px; max-width: 85%; line-height: 1.7; font-size: 15px; }
    .chat-bubble-bot { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.06); border-bottom-left-radius: 4px; }
    .chat-bubble-bot strong { color: #FF8B5E; }
    .chat-bubble-user { background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(255, 107, 53, 0.08)); border: 1px solid rgba(255, 107, 53, 0.2); border-bottom-right-radius: 4px; }
    .chat-input-container { padding: 20px 24px; border-top: 1px solid rgba(255, 255, 255, 0.04); display: flex; gap: 12px; }
    .chat-input { flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 14px; padding: 16px 20px; color: white; font-size: 15px; }
    .chat-input:focus { outline: none; border-color: rgba(255, 107, 53, 0.4); }
    .chat-input::placeholder { color: rgba(255, 255, 255, 0.25); }
    .chat-send { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 28px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .chat-send:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .loading-indicator { display: flex; align-items: center; gap: 12px; padding: 14px 20px; background: rgba(255, 255, 255, 0.04); border-radius: 20px; width: fit-content; border-bottom-left-radius: 4px; }
    .loading-bar-wrapper { width: 100px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; }
    .loading-bar-fill { height: 100%; background: linear-gradient(90deg, transparent 0%, #FF6B35 20%, #FF8B5E 50%, #FF6B35 80%, transparent 100%); background-size: 200% 100%; animation: slideBar 1.2s linear infinite; width: 100%; }
    @keyframes slideBar { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    .close-btn { position: fixed; top: 24px; right: 24px; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 100; transition: all 0.3s ease; }
    .close-btn:hover { background: rgba(255, 255, 255, 0.08); transform: rotate(90deg); }
    .btn-glow { background: linear-gradient(135deg, #FF6B35, #FF8B5E); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.25); width: 100%; font-size: 15px; text-decoration: none; display: inline-block; text-align: center; }
    .btn-glow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4); }
    .btn-glow:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-telegram { background: linear-gradient(135deg, #0088cc, #00aaff); border: none; border-radius: 14px; padding: 16px 32px; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; width: 100%; font-size: 15px; text-decoration: none; }
    .btn-telegram:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 136, 204, 0.5); }
    .check-icon { width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #4ade80); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; animation: popIn 0.5s ease; }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    .btn-logout { background: transparent; border: none; padding: 8px; border-radius: 8px; transition: all 0.2s; color: rgba(255,255,255,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-logout:hover { background: rgba(239,68,68,0.1); color: #ef4444; }
    .welcome-overlay { position: fixed; inset: 0; background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(30px); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
    .welcome-overlay.active { opacity: 1; pointer-events: all; }
    .welcome-logo { width: 100px; height: 100px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 28px; display: flex; align-items: center; justify-content: center; font-size: 52px; font-weight: 800; margin-bottom: 32px; animation: welcomePulse 2s ease-in-out infinite; box-shadow: 0 20px 60px rgba(255, 107, 53, 0.4); }
    @keyframes welcomePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .welcome-title { font-size: 32px; font-weight: 700; margin-bottom: 12px; text-align: center; }
    .welcome-subtitle { font-size: 16px; color: rgba(255, 255, 255, 0.5); margin-bottom: 40px; text-align: center; }
    .welcome-dots { display: flex; gap: 12px; }
    .welcome-dot { width: 12px; height: 12px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 50%; animation: welcomeBounce 1.4s ease-in-out infinite; }
    .welcome-dot:nth-child(2) { animation-delay: 0.2s; }
    .welcome-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes welcomeBounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
    .global-loader { position: fixed; inset: 0; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10001; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .global-loader.active { opacity: 1; pointer-events: all; }
    .loader-container { background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 32px 40px; min-width: 320px; max-width: 400px; }
    .loader-filename { font-size: 15px; color: #FF6B35; font-weight: 600; margin-bottom: 24px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .loader-steps { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .loader-step { display: flex; align-items: center; gap: 14px; }
    .loader-step-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.3s ease; flex-shrink: 0; }
    .loader-step.pending .loader-step-icon { background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.3); }
    .loader-step.active .loader-step-icon { background: rgba(255, 107, 53, 0.15); border: 2px solid #FF6B35; color: #FF6B35; animation: pulseStep 1.5s ease-in-out infinite; }
    .loader-step.done .loader-step-icon { background: rgba(34, 197, 94, 0.2); border: 2px solid #22C55E; color: #22C55E; }
    .loader-step-text { font-size: 14px; color: rgba(255, 255, 255, 0.4); transition: color 0.3s; }
    .loader-step.active .loader-step-text { color: rgba(255, 255, 255, 0.9); }
    .loader-step.done .loader-step-text { color: rgba(255, 255, 255, 0.6); }
    @keyframes pulseStep { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(255, 107, 53, 0); } }
    @keyframes pulseArrow { 0%, 100% { opacity: 0.5; transform: translateX(0); } 50% { opacity: 1; transform: translateX(4px); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader-progress { height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; }
    /* Analyse step loader */
    .analyse-step { display: flex; align-items: center; gap: 12px; }
    .analyse-step-icon { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; transition: all 0.3s ease; flex-shrink: 0; }
    .analyse-step.pending .analyse-step-icon { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.25); }
    .analyse-step.active .analyse-step-icon { background: rgba(255, 107, 53, 0.15); border: 2px solid #FF6B35; color: #FF6B35; animation: pulseStep 1.5s ease-in-out infinite; }
    .analyse-step.done .analyse-step-icon { background: rgba(34, 197, 94, 0.2); border: 2px solid #22C55E; color: #22C55E; }
    .analyse-step-text { font-size: 13px; color: rgba(255, 255, 255, 0.35); transition: color 0.3s; }
    .analyse-step.active .analyse-step-text { color: rgba(255, 255, 255, 0.9); font-weight: 500; }
    .analyse-step.done .analyse-step-text { color: rgba(255, 255, 255, 0.5); }
    .loader-progress-bar { height: 100%; background: linear-gradient(90deg, #FF6B35, #FF8F6B); border-radius: 2px; transition: width 0.5s ease; width: 0%; }
    /* Modal overlay - ne couvre PAS le header/sidebar */
    .sheets-overlay { position: fixed; top: 70px; left: 280px; right: 0; bottom: 0; background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(20px); z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .sheets-overlay.active { opacity: 1; pointer-events: all; }
    .sheets-content { max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; background: rgba(20, 20, 20, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 32px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
    @media (max-width: 768px) { .sheets-overlay { left: 0; top: 70px; } }
    .sheets-header { text-align: center; margin-bottom: 32px; }
    .sheets-header h2 { font-size: 28px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .sheets-header p { color: rgba(255, 255, 255, 0.5); font-size: 16px; }

    /* Search bar for sheets */
    .sheets-search { position: relative; margin-bottom: 24px; }
    .sheets-search input { width: 100%; padding: 16px 20px 16px 52px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; color: white; font-size: 15px; transition: all 0.3s ease; }
    .sheets-search input:focus { outline: none; border-color: rgba(255, 107, 53, 0.4); background: rgba(255, 255, 255, 0.06); }
    .sheets-search input::placeholder { color: rgba(255, 255, 255, 0.3); }
    .sheets-search svg { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.4); pointer-events: none; }

    /* Folder tabs for sheets */
    .sheets-folders { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
    .sheets-folder { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; font-size: 14px; color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.3s ease; }
    .sheets-folder:hover { background: rgba(255, 255, 255, 0.08); color: white; }
    .sheets-folder.active { background: rgba(255, 107, 53, 0.15); border-color: rgba(255, 107, 53, 0.3); color: #FF8B5E; }
    .sheets-folder svg { width: 16px; height: 16px; }

    /* Section title */
    .sheets-section-title { font-size: 12px; font-weight: 600; color: rgba(255, 255, 255, 0.4); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; padding-left: 4px; }
    .sheets-file-count { display: inline; }
    @media (max-width: 768px) { .sheets-file-count { display: none; } }

    /* Suggested files section */
    .sheets-suggested { margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(255, 107, 53, 0.08), rgba(255, 107, 53, 0.02)); border: 1px solid rgba(255, 107, 53, 0.2); border-radius: 16px; }
    .sheets-suggested-title { font-size: 13px; font-weight: 600; color: #FF8B5E; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .sheets-suggested .sheet-card { background: rgba(255, 107, 53, 0.06); border-color: rgba(255, 107, 53, 0.15); }
    .sheets-suggested .sheet-card:hover { background: rgba(255, 107, 53, 0.12); border-color: rgba(255, 107, 53, 0.4); }

    .sheets-grid { display: grid; gap: 12px; margin-bottom: 24px; }
    .sheet-card { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 20px 24px; display: flex; align-items: center; gap: 20px; cursor: pointer; transition: all 0.3s; }
    .sheet-card:hover { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 107, 53, 0.4); transform: translateX(8px); }
    .sheet-card-icon { width: 52px; height: 52px; background: rgba(15, 157, 88, 0.15); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .sheet-card-icon svg { width: 28px; height: 28px; color: #0f9d58; }
    .sheet-card-info { flex: 1; min-width: 0; }
    .sheet-card-info h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sheet-card-info p { font-size: 13px; color: rgba(255, 255, 255, 0.4); display: flex; align-items: center; gap: 6px; }
    .sheet-card-info p svg { width: 14px; height: 14px; }
    .sheet-card-arrow { color: rgba(255, 255, 255, 0.3); transition: all 0.3s; }
    .sheet-card:hover .sheet-card-arrow { color: #FF6B35; transform: translateX(4px); }

    /* Empty state */
    .sheets-empty { text-align: center; padding: 48px 24px; color: rgba(255, 255, 255, 0.4); }
    .sheets-empty svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    .sheets-empty h4 { font-size: 18px; font-weight: 600; color: white; margin-bottom: 8px; }

    .btn-refresh { width: 100%; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 14px; color: white; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-refresh:hover { background: rgba(255, 255, 255, 0.08); }
    .btn-back { width: 100%; background: transparent; border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px; border-radius: 14px; color: rgba(255, 255, 255, 0.6); cursor: pointer; margin-top: 12px; transition: all 0.3s; }
    .btn-back:hover { background: rgba(255, 255, 255, 0.04); color: white; }
    .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 16px 32px; border-radius: 16px; font-weight: 600; box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4); z-index: 10002; opacity: 0; transition: all 0.4s; }
    .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
    .btn-google-sheets { width: 100%; background: white; color: #3c4043; border: none; border-radius: 14px; padding: 16px 24px; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .btn-google-sheets:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2); }
    .btn-google-sheets.connected { background: linear-gradient(135deg, #0f9d58, #0a7e3e); color: white; }
    @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; padding: 24px; } }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
  <div class="welcome-overlay" id="welcome-overlay">
    <div class="welcome-logo">i</div>
    <h1 class="welcome-title" id="welcome-title">Bienvenue ! üëã</h1>
    <p class="welcome-subtitle" id="welcome-subtitle">Pr√©paration de ton espace...</p>
    <div class="welcome-dots"><div class="welcome-dot"></div><div class="welcome-dot"></div><div class="welcome-dot"></div></div>
  </div>
  <div class="global-loader" id="global-loader">
    <div class="loader-container">
      <div class="loader-filename" id="loader-filename"></div>
      <div class="loader-steps" id="loader-steps"></div>
      <div class="loader-progress"><div class="loader-progress-bar" id="loader-progress"></div></div>
    </div>
  </div>
  <div class="sheets-overlay" id="sheets-overlay">
    <div class="sheets-content" style="position: relative;">
      <!-- Bouton fermer -->
      <button onclick="closeSheetsOverlay()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; color: rgba(255,255,255,0.5);" onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='white';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.color='rgba(255,255,255,0.5)';">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <div class="sheets-header">
        <h2>
          <svg width="32" height="32" viewBox="0 0 24 24" fill="#0f9d58"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg>
          Mes Google Sheets
        </h2>
        <p>Selectionne le fichier ou le bot ecrira tes donnees</p>
      </div>

      <!-- Search bar -->
      <div class="sheets-search">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input type="text" id="sheets-search-input" placeholder="Rechercher un fichier..." oninput="filterSheetsList(this.value)">
      </div>

      <!-- Folder tabs -->
      <div class="sheets-folders">
        <div class="sheets-folder active" onclick="filterByFolder('all', this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
          Tous
        </div>
        <div class="sheets-folder" onclick="filterByFolder('recent', this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
          Recents
        </div>
        <div class="sheets-folder" onclick="filterByFolder('shared', this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          Partages
        </div>
      </div>

      <!-- Suggested files (dynamic) -->
      <div class="sheets-suggested" id="sheets-suggested" style="display: none;">
        <div class="sheets-suggested-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          Ca ressemble a ta compta
        </div>
        <div class="sheets-grid" id="sheets-suggested-grid"></div>
      </div>

      <!-- Section title -->
      <div class="sheets-section-title" id="sheets-section-title">Autres fichiers <span class="sheets-file-count" id="sheets-file-count"></span></div>

      <!-- Sheets list -->
      <div class="sheets-grid" id="sheets-grid"></div>

      <button class="btn-refresh" onclick="refreshSheets()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        Rafraichir la liste
      </button>
      <button class="btn-back" onclick="closeSheetsOverlay()">‚Üê Retour</button>
    </div>
  </div>
  <div class="toast" id="toast"></div>
  <!-- Verification Warning Modal -->
  <div class="sheets-overlay" id="verify-overlay" style="z-index: 60;">
    <div class="sheets-content" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="width: 64px; height: 64px; background: rgba(251, 191, 36, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px;">‚ö†Ô∏è</div>
        <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 8px;">Diff√©rence d√©tect√©e</h2>
        <p style="color: rgba(255,255,255,0.5); font-size: 14px;">La conversion a r√©ussi mais on a d√©tect√© des diff√©rences.</p>
      </div>
      <div id="verify-differences" style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 24px; font-size: 14px; color: rgba(255,255,255,0.7);"></div>
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <button id="verify-compare-btn" onclick="openCompareFiles()" style="flex: 1; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px; color: white; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg>
          Comparer les fichiers
        </button>
      </div>
      <button id="verify-continue-btn" onclick="continueAfterVerify()" class="btn-glow" style="width: 100%;">
        Continuer quand m√™me ‚Üí
      </button>
      <button onclick="closeVerifyOverlay()" style="width: 100%; background: transparent; border: none; padding: 14px; color: rgba(255,255,255,0.4); cursor: pointer; margin-top: 12px; font-size: 14px;">Annuler</button>
    </div>
  </div>
  <!-- Connect Google Modal - shown when user validates without Google access -->
  <div class="sheets-overlay" id="connect-google-overlay" style="z-index: 60;">
    <div class="sheets-content" style="max-width: 480px;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="width: 72px; height: 72px; background: linear-gradient(135deg, rgba(15, 157, 88, 0.2), rgba(66, 133, 244, 0.2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 36px;">üìä</div>
        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">Ton fichier est pr√™t !</h2>
        <p style="color: rgba(255,255,255,0.6); font-size: 15px; line-height: 1.6;">Pour que le bot Telegram puisse √©crire dedans, ton fichier doit √™tre sur Google Sheets.</p>
      </div>
      <div style="background: rgba(15, 157, 88, 0.08); border: 1px solid rgba(15, 157, 88, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
          <div style="width: 28px; height: 28px; background: rgba(15, 157, 88, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px;">‚úì</div>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">On s'occupe de tout</div>
            <div style="color: rgba(255,255,255,0.5); font-size: 13px;">Ton Excel sera converti automatiquement en Google Sheet</div>
          </div>
        </div>
        <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
          <div style="width: 28px; height: 28px; background: rgba(15, 157, 88, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px;">‚úì</div>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">Ton fichier original reste intact</div>
            <div style="color: rgba(255,255,255,0.5); font-size: 13px;">On cr√©e une copie Google Sheet, tu gardes ton Excel</div>
          </div>
        </div>
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <div style="width: 28px; height: 28px; background: rgba(15, 157, 88, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px;">‚úì</div>
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">Tout se fait en ligne</div>
            <div style="color: rgba(255,255,255,0.5); font-size: 13px;">Acc√®de √† ta compta depuis n'importe o√π</div>
          </div>
        </div>
      </div>
      <button onclick="connectGoogleAndContinue()" class="btn-glow" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/><path fill="#34A853" d="M6.3 14.7l6.6 4.8C14.1 16.2 18.7 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.1 2 9.3 6.2 6.3 14.7z"/><path fill="#FBBC05" d="M24 46c5.5 0 10.3-2 14.1-5.3l-6.5-5.5C29.5 37 26.9 38 24 38c-6.1 0-11.2-3.9-13.1-9.3l-6.6 5.1C7.3 41.4 15.1 46 24 46z"/><path fill="#EA4335" d="M46.5 20H24v8.5h11.8c-.8 2.4-2.3 4.5-4.3 6l6.5 5.5C41.8 36.5 46 30.9 46 24c0-1.3-.1-2.6-.5-4z"/></svg>
        Connecter Google Sheets
      </button>
      <button onclick="closeConnectGoogleOverlay()" style="width: 100%; background: transparent; border: none; padding: 14px; color: rgba(255,255,255,0.4); cursor: pointer; margin-top: 12px; font-size: 14px;">Annuler</button>
    </div>
  </div>
  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3"><div class="logo-i">i</div><span class="font-semibold text-lg">iArmy</span></a>
      <div id="auth-buttons"></div>
    </div>
  </nav>
  <div class="flex min-h-screen" style="padding-top: 70px;">
    <aside class="sidebar">
      <div class="mb-6">
        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px;">Module</div>
        <div style="font-size: 18px; font-weight: 700; color: white; margin-top: 4px;">Compta Express</div>
      </div>
      <div id="steps-nav">
        <div class="step-item active" id="step-nav-1"><div class="step-number">1</div><span class="step-label">Connexion Google</span></div>
        <div class="step-item upcoming" id="step-nav-2"><div class="step-number">2</div><span class="step-label">Ton fichier</span></div>
        <div class="step-item upcoming" id="step-nav-3"><div class="step-number">3</div><span class="step-label">Configuration</span></div>
        <div class="step-item upcoming" id="step-nav-4"><div class="step-number">4</div><span class="step-label">Telegram</span></div>
      </div>
    </aside>
    <main class="main-content">
      <a href="index.html" class="close-btn"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></a>
      <!-- √âTAPE 1a: Autoriser Google Sheets (si pas encore fait) -->
      <div class="step-content active" id="step-auth">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 1/4</span></div>
        <h1 class="text-3xl font-bold mb-3">Connecte Google Sheets</h1>
        <p class="text-white/40 mb-8">Pour que le bot puisse ecrire dans ton fichier</p>

        <div class="glass-card p-8 max-w-lg mx-auto">
          <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-green-500/20 to-green-500/5 flex items-center justify-center mb-6">
            <svg width="40" height="40" viewBox="0 0 28 28" fill="none"><rect x="4" y="4" width="20" height="20" rx="2" fill="#0F9D58"/><path d="M9 11h3v10H9V11zm4 0h3v10h-3V11zm4 0h3v10h-3V11z" fill="white"/></svg>
          </div>

          <div class="space-y-4 mb-8">
            <div class="flex items-start gap-3 text-left">
              <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5 text-green-400 text-sm">1</div>
              <div>
                <p class="text-white/80">Le bot ecrit directement dans ton Google Sheet</p>
              </div>
            </div>
            <div class="flex items-start gap-3 text-left">
              <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5 text-green-400 text-sm">2</div>
              <div>
                <p class="text-white/80">Tes donnees restent privees, sur TON compte</p>
              </div>
            </div>
            <div class="flex items-start gap-3 text-left">
              <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5 text-green-400 text-sm">3</div>
              <div>
                <p class="text-white/80">Tu peux revoquer l'acces quand tu veux</p>
              </div>
            </div>
          </div>

          <button onclick="authorizeGoogleSheets()" class="btn-glow w-full" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/><path fill="#34A853" d="M6.3 14.7l6.6 4.8C14.1 16.2 18.7 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.1 2 9.3 6.2 6.3 14.7z"/><path fill="#FBBC05" d="M24 46c5.5 0 10.3-2 14.1-5.3l-6.5-5.5C29.5 37 26.9 38 24 38c-6.1 0-11.2-3.9-13.1-9.3l-6.6 5.1C7.3 41.4 15.1 46 24 46z"/><path fill="#EA4335" d="M46.5 20H24v8.5h11.8c-.8 2.4-2.3 4.5-4.3 6l6.5 5.5C41.8 36.5 46 30.9 46 24c0-1.3-.1-2.6-.5-4z"/></svg>
            Autoriser Google Sheets
          </button>
        </div>
      </div>

      <!-- √âTAPE 2: Choix du fichier (apr√®s auth Google) -->
      <div class="step-content" id="step-choice">
        <div class="mb-2"><span class="text-white/30 text-sm">Etape 2/4</span></div>
        <h1 class="text-3xl font-bold mb-3">Comment veux-tu commencer ?</h1>
        <p class="text-white/40 mb-8">Choisis l'option qui te convient</p>

        <!-- Option 1: Fichier vierge (RECOMMAND√â) -->
        <div class="glass-card p-8 mb-5 max-w-lg mx-auto" style="border: 1px solid rgba(255, 107, 53, 0.3); background: linear-gradient(135deg, rgba(255, 107, 53, 0.08), rgba(255, 107, 53, 0.02));">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500/30 to-orange-500/10 flex items-center justify-center text-2xl">+</div>
            <div>
              <h3 class="text-xl font-semibold">Partir de zero</h3>
              <span class="inline-block mt-1 px-2 py-0.5 rounded-full text-xs font-semibold bg-orange-500/20 text-orange-400 border border-orange-500/30">RECOMMANDE</span>
            </div>
          </div>
          <p class="text-white/50 mb-3 text-sm leading-relaxed">On te cree un Google Sheet avec tes colonnes :</p>

          <!-- Colonnes interactives : drag pour r√©ordonner, double-clic pour modifier, √ó pour supprimer -->
          <div class="flex flex-wrap gap-2 mb-3" id="template-columns" ondragover="dragColOver(event)" ondrop="dragColEnd(event)">
            <span class="template-col group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 transition-all hover:border-white/20 cursor-grab active:cursor-grabbing" draggable="true" ondragstart="dragColStart(event)" ondragover="dragColOver(event)" ondragend="dragColEnd(event)">
              <svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              <span class="col-name" ondblclick="editColName(this)">Date</span>
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
            <span class="template-col group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 transition-all hover:border-white/20 cursor-grab active:cursor-grabbing" draggable="true" ondragstart="dragColStart(event)" ondragover="dragColOver(event)" ondragend="dragColEnd(event)">
              <svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              <span class="col-name" ondblclick="editColName(this)">CB</span>
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
            <span class="template-col group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 transition-all hover:border-white/20 cursor-grab active:cursor-grabbing" draggable="true" ondragstart="dragColStart(event)" ondragover="dragColOver(event)" ondragend="dragColEnd(event)">
              <svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              <span class="col-name" ondblclick="editColName(this)">Especes</span>
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
            <span class="template-col group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 transition-all hover:border-white/20 cursor-grab active:cursor-grabbing" draggable="true" ondragstart="dragColStart(event)" ondragover="dragColOver(event)" ondragend="dragColEnd(event)">
              <svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              <span class="col-name" ondblclick="editColName(this)">Ticket Resto</span>
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
            <span class="template-col group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 transition-all hover:border-white/20 cursor-grab active:cursor-grabbing" draggable="true" ondragstart="dragColStart(event)" ondragover="dragColOver(event)" ondragend="dragColEnd(event)">
              <svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              <span class="col-name" ondblclick="editColName(this)">Depenses</span>
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
            <span class="template-col group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 transition-all hover:border-white/20 cursor-grab active:cursor-grabbing" draggable="true" ondragstart="dragColStart(event)" ondragover="dragColOver(event)" ondragend="dragColEnd(event)">
              <svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg>
              <span class="col-name" ondblclick="editColName(this)">Notes</span>
              <button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
            <!-- Input pour ajouter colonne (cach√© par d√©faut) -->
            <div id="add-col-input" class="hidden">
              <input type="text" id="new-col-name" class="px-3 py-1.5 rounded-lg text-xs bg-white/10 border border-orange-500/50 text-white outline-none w-24" placeholder="Nom..." maxlength="20" onkeydown="handleNewColKey(event)" onblur="cancelAddCol()">
            </div>
            <!-- Bouton ajouter colonne -->
            <button id="add-col-btn" onclick="showAddColInput()" class="px-3 py-1.5 rounded-lg text-xs border border-dashed border-white/20 text-white/40 hover:border-orange-500/50 hover:text-orange-400 hover:bg-orange-500/5 transition-all flex items-center gap-1">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Ajouter
            </button>
          </div>

          <p class="text-white/30 text-xs mb-5 flex items-center gap-1">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            Glisse pour reordonner, double-clic pour modifier
          </p>
          <button onclick="createEmptyTemplate()" class="btn-glow w-full">
            Creer mon fichier
          </button>
        </div>

        <!-- Option 2: J'ai d√©j√† un fichier -->
        <div class="glass-card p-6 max-w-lg mx-auto" id="import-dropzone">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500/20 to-blue-500/5 flex items-center justify-center text-xl">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div><h3 class="text-lg font-semibold">J'ai deja un fichier</h3></div>
          </div>

          <!-- Google Drive button (prioritaire) -->
          <button onclick="openSheetsPicker()" class="w-full bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl py-4 px-4 text-sm font-medium transition-all flex items-center gap-3 mb-4">
            <svg width="28" height="28" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
              <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
              <path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"/>
              <path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l5.852 11.5z" fill="#ea4335"/>
              <path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"/>
              <path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"/>
              <path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 28h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
            </svg>
            <div class="text-left">
              <div class="font-medium">Choisir depuis Google Drive</div>
              <div class="text-xs text-white/40">Selectionne un fichier deja en ligne</div>
            </div>
          </button>

          <!-- Or separator -->
          <div class="flex items-center gap-3 mb-4">
            <div class="flex-1 h-px bg-white/10"></div>
            <span class="text-white/30 text-xs">ou</span>
            <div class="flex-1 h-px bg-white/10"></div>
          </div>

          <!-- Drop zone area (secondaire) - Plus grande pour faciliter le drag & drop -->
          <div id="drop-area" class="border-2 border-dashed border-white/15 rounded-xl py-8 px-6 text-center transition-all cursor-pointer hover:border-white/30 hover:bg-white/[0.03]" onclick="document.getElementById('file-input').click()">
            <div class="flex flex-col items-center justify-center gap-3">
              <div class="w-14 h-14 rounded-full bg-white/5 flex items-center justify-center mb-1">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="text-white/40">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </div>
              <div class="text-center">
                <p class="text-white/60 text-sm font-medium">Glisse ton fichier Excel ici</p>
                <p class="text-white/30 text-xs mt-1">ou clique pour parcourir</p>
              </div>
            </div>
          </div>

          <input type="file" id="file-input" accept=".xlsx,.xls,.csv" class="hidden">
        </div>

        <div class="mt-6 flex items-center justify-center gap-2 text-white/30 text-xs">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
          <span>Tes donnees restent confidentielles</span>
        </div>
      </div>
      <!-- STEP 3: Config Editor (direct, pas d'overlay) -->
      <div class="step-content" id="step-analyse">

        <!-- Header -->
        <div style="text-align: center; margin-bottom: 32px;">
          <div class="mb-2"><span class="text-white/30 text-sm">√âtape 3/4</span></div>
          <h1 class="text-3xl font-bold mb-2">Configure ton assistant</h1>
        </div>

        <!-- Loading state avec √©tapes d√©taill√©es -->
        <div id="config-loading" style="max-width: 500px; margin: 0 auto; padding: 40px 20px;">
          <!-- Nom du fichier avec badge √©l√©gant -->
          <div style="text-align: center; margin-bottom: 28px;">
            <div style="display: inline-flex; align-items: center; gap: 10px; padding: 10px 20px; background: rgba(255,107,53,0.1); border: 1px solid rgba(255,107,53,0.2); border-radius: 12px;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#FF6B35" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              <span id="loading-filename" style="color: #FF8B5E; font-weight: 600; font-size: 14px; max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">recette 25.xlsx</span>
            </div>
          </div>

          <!-- √âtapes de chargement -->
          <div id="loading-steps" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
            <div class="loading-step" id="load-step-0" style="display: flex; align-items: center; gap: 14px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
              <div class="step-icon" style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.3);">1</div>
              <span class="step-text" style="font-size: 14px; color: rgba(255,255,255,0.4);">Lecture du fichier</span>
            </div>
            <div class="loading-step" id="load-step-1" style="display: flex; align-items: center; gap: 14px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
              <div class="step-icon" style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.3);">2</div>
              <span class="step-text" style="font-size: 14px; color: rgba(255,255,255,0.4);">Upload vers Google Drive</span>
            </div>
            <div class="loading-step" id="load-step-2" style="display: flex; align-items: center; gap: 14px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
              <div class="step-icon" style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.3);">3</div>
              <span class="step-text" style="font-size: 14px; color: rgba(255,255,255,0.4);">Conversion en Google Sheet</span>
            </div>
            <div class="loading-step" id="load-step-3" style="display: flex; align-items: center; gap: 14px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">
              <div class="step-icon" style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.3);">4</div>
              <span class="step-text" style="font-size: 14px; color: rgba(255,255,255,0.4);">D√©tection des colonnes</span>
            </div>
          </div>

          <!-- Barre de progression -->
          <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 4px; overflow: hidden;">
            <div id="loading-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #FF6B35, #FF8B5E); transition: width 0.3s ease;"></div>
          </div>
        </div>

        <!-- Config Editor (hidden until loaded) -->
        <div id="config-editor-main" style="display: none; max-width: 1100px; margin: 0 auto;">

          <!-- Main content: Phone + Excel c√¥te √† c√¥te -->
          <div style="display: grid; grid-template-columns: 280px 1fr; gap: 32px; margin-bottom: 28px; align-items: start;">

            <!-- GAUCHE: iPhone avec Telegram -->
            <div style="position: relative;">
              <!-- iPhone Frame -->
              <div style="background: #1a1a1a; border-radius: 40px; padding: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.4), inset 0 0 0 2px #333;">
                <!-- Notch -->
                <div style="position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 80px; height: 24px; background: #1a1a1a; border-radius: 0 0 14px 14px; z-index: 10;"></div>

                <!-- Screen -->
                <div style="background: #0e1621; border-radius: 32px; overflow: hidden; min-height: 420px;">
                  <!-- Telegram Header -->
                  <div style="background: #17212b; padding: 40px 12px 12px 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">i</div>
                    <div>
                      <div style="font-weight: 600; font-size: 14px;">iArmy Bot</div>
                      <div style="font-size: 11px; color: #6ab3f3;">en ligne</div>
                    </div>
                  </div>

                  <!-- Chat Area -->
                  <div style="padding: 16px; min-height: 280px; display: flex; flex-direction: column; justify-content: flex-end;">
                    <!-- User Message Bubble -->
                    <div style="align-self: flex-end; max-width: 85%;">
                      <div style="background: #2b5278; border-radius: 16px 16px 4px 16px; padding: 10px 14px;">
                        <div id="preview-message-content" style="font-size: 13px; line-height: 1.5; white-space: pre-line; color: white;">CB 1000
ESP 500
TR 50
DEP 100</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.4); text-align: right; margin-top: 4px;">14:32 ‚úì‚úì</div>
                      </div>
                    </div>

                    <!-- Bot Response -->
                    <div style="align-self: flex-start; max-width: 85%; margin-top: 12px;">
                      <div style="background: #182533; border-radius: 16px 16px 16px 4px; padding: 10px 14px;">
                        <div style="font-size: 12px; color: #22C55E;">‚úì Donn√©es enregistr√©es !</div>
                      </div>
                    </div>
                  </div>

                  <!-- Input Bar -->
                  <div style="padding: 8px 12px; background: #17212b; display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; background: #242f3d; border-radius: 20px; padding: 8px 14px; font-size: 12px; color: rgba(255,255,255,0.4);">Message...</div>
                    <div style="width: 32px; height: 32px; background: #2b5278; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Label sous le t√©l√©phone -->
              <div style="text-align: center; margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.4);">
                üì± Ton message Telegram
              </div>
            </div>

            <!-- DROITE: Mini Excel complet -->
            <div style="flex: 1;">
              <!-- Excel Frame -->
              <div style="background: #1e1e1e; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
                <!-- Excel Header Bar -->
                <div style="background: #217346; padding: 8px 12px; display: flex; align-items: center; gap: 8px;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M21.17 3.25Q21.5 3.25 21.76 3.5 22 3.74 22 4.08V19.92Q22 20.26 21.76 20.5 21.5 20.75 21.17 20.75H7.83Q7.5 20.75 7.24 20.5 7 20.26 7 19.92V17H2.83Q2.5 17 2.24 16.76 2 16.5 2 16.17V7.83Q2 7.5 2.24 7.24 2.5 7 2.83 7H7V4.08Q7 3.74 7.24 3.5 7.5 3.25 7.83 3.25M7 13.06L8.18 15.28H9.97L8 12.06L9.93 8.89H8.22L7.13 10.9L7.09 10.96L7.06 11.03Q6.8 10.5 6.5 9.96 6.25 9.43 5.97 8.89H4.16L6.05 12.08L4 15.28H5.78M13.88 19.5V17H8.25V19.5M13.88 15.75V12.63H12V15.75M13.88 11.38V8.25H12V11.38M13.88 7V4.5H8.25V7M20.75 19.5V17H15.13V19.5M20.75 15.75V12.63H15.13V15.75M20.75 11.38V8.25H15.13V11.38M20.75 7V4.5H15.13V7Z"/></svg>
                  <span id="excel-filename" style="font-size: 12px; font-weight: 500; color: white;">recette 25.xlsx</span>
                  <div style="margin-left: auto; display: flex; gap: 4px;">
                    <div style="width: 10px; height: 10px; background: #ff5f57; border-radius: 50%;"></div>
                    <div style="width: 10px; height: 10px; background: #ffbd2e; border-radius: 50%;"></div>
                    <div style="width: 10px; height: 10px; background: #28ca42; border-radius: 50%;"></div>
                  </div>
                </div>

                <!-- Excel Grid Container -->
                <div id="excel-grid-container" style="overflow-x: auto; max-height: 320px; overflow-y: auto;">
                  <!-- Le tableau sera g√©n√©r√© dynamiquement par buildExcelPreview() -->
                  <table id="excel-preview-table" style="width: 100%; border-collapse: collapse; font-size: 11px; min-width: 500px;">
                  </table>
                </div>

                <!-- Excel Footer avec onglets -->
                <div style="background: #2d2d2d; padding: 6px 12px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #404040;">
                  <div id="excel-sheet-tab" style="background: #217346; padding: 4px 12px; border-radius: 4px 4px 0 0; font-size: 11px; color: white; margin-bottom: -6px; font-weight: 500;">janv</div>
                  <div style="background: #3d3d3d; padding: 4px 10px; border-radius: 4px 4px 0 0; font-size: 10px; color: #888; margin-bottom: -6px;">+ autres</div>
                  <a id="open-sheet-link" href="#" target="_blank" style="margin-left: auto; font-size: 10px; color: #6ab3f3; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                    Ouvrir dans Google Sheets ‚Üó
                  </a>
                </div>
              </div>

              <!-- Indicateur de zone si colonnes formules d√©tect√©es -->
              <div id="excel-zone-indicator" style="display: none; margin-top: 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 10px; padding: 10px 14px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 14px;">üìä</span>
                  <div style="flex: 1;">
                    <div style="font-size: 12px; font-weight: 600; color: #22C55E;">2 zones d√©tect√©es</div>
                    <div class="zone-desc" style="font-size: 11px; color: rgba(255,255,255,0.5);">Zone calculs (prot√©g√©e) + Zone saisie manuelle</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Explication -->
          <div style="text-align: center; padding: 20px 0 16px 0; color: rgba(255,255,255,0.5); font-size: 14px;">
            üëÜ Quand tu envoies un message Telegram, les valeurs s'√©crivent automatiquement dans ton tableau
          </div>

          <!-- Boutons principaux -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="toggleConfigPanel()" id="btn-modify-config" style="flex: 1; padding: 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.15); border-radius: 14px; color: rgba(255,255,255,0.8); font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span style="font-size: 18px;">‚öôÔ∏è</span> Modifier
            </button>
            <button onclick="saveConfigEditor()" style="flex: 2; padding: 16px; background: linear-gradient(135deg, #22C55E, #16A34A); border: none; border-radius: 14px; color: white; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3); transition: all 0.2s;">
              ‚úì C'est parfait ! Continuer ‚Üí
            </button>
          </div>

          <!-- Panel de configuration (cach√© par d√©faut) - LIQUID GLASS -->
          <div id="config-panel" style="display: none; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);">

            <!-- Configuration des mots-cl√©s - GLASS EFFECT -->
            <div class="glass-config-section" style="background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.3s ease;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="font-size: 13px; color: rgba(255,255,255,0.6); font-weight: 500; letter-spacing: 0.5px;">Mots-cl√©s</span>
                <button onclick="addConfigRow()" class="glass-btn-add" style="padding: 6px 14px; background: rgba(255,107,53,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,107,53,0.2); border-radius: 8px; color: rgba(255,107,53,0.8); cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255,107,53,0.1);" onmouseover="this.style.background='rgba(255,107,53,0.2)';this.style.boxShadow='0 4px 16px rgba(255,107,53,0.2)';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255,107,53,0.1)';this.style.boxShadow='0 2px 8px rgba(255,107,53,0.1)';this.style.transform='translateY(0)'">
                  + nouveau
                </button>
              </div>

              <div id="config-editor-rows" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Les rows seront g√©n√©r√©es dynamiquement -->
              </div>
            </div>

            <!-- Section r√®gles de calcul - GLASS EFFECT -->
            <div class="glass-config-section" style="background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.3s ease;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <span style="font-size: 13px; color: rgba(255,255,255,0.6); font-weight: 500; letter-spacing: 0.5px;">R√®gles</span>
                <button onclick="addCustomRule()" class="glass-btn-add" style="padding: 6px 14px; background: rgba(255,107,53,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,107,53,0.2); border-radius: 8px; color: rgba(255,107,53,0.8); cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255,107,53,0.1);" onmouseover="this.style.background='rgba(255,107,53,0.2)';this.style.boxShadow='0 4px 16px rgba(255,107,53,0.2)';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(255,107,53,0.1)';this.style.boxShadow='0 2px 8px rgba(255,107,53,0.1)';this.style.transform='translateY(0)'">
                  + nouvelle
                </button>
              </div>

              <div id="custom-rules-container" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Les r√®gles seront g√©n√©r√©es dynamiquement -->
              </div>

              <!-- Message si pas de r√®gles -->
              <div id="no-rules-message" style="color: rgba(255,255,255,0.35); font-size: 11px; padding: 12px; text-align: center; font-style: italic;">
                Combine des valeurs (ex: DEP + ESP ‚Üí ESP)
              </div>
            </div>

            <!-- Boutons bas du panel - GLASS -->
            <div style="display: flex; gap: 12px; padding-top: 6px;">
              <button onclick="closeConfigEditor()" style="padding: 12px 18px; background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; color: rgba(255,255,255,0.5); font-size: 12px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(0,0,0,0.2);" onmouseover="this.style.background='rgba(255,255,255,0.06)';this.style.color='rgba(255,255,255,0.8)';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.03)';this.style.color='rgba(255,255,255,0.5)';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(0,0,0,0.2)'">
                ‚Üê Autre fichier
              </button>
              <button onclick="toggleConfigPanel()" style="margin-left: auto; padding: 12px 20px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.08)); backdrop-filter: blur(10px); border: 1px solid rgba(34,197,94,0.25); border-radius: 12px; color: #4ade80; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(34,197,94,0.15);" onmouseover="this.style.background='linear-gradient(135deg, rgba(34,197,94,0.25), rgba(34,197,94,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(34,197,94,0.25)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.08))';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(34,197,94,0.15)'">
                Fermer ‚úì
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 4: Telegram -->
      <div class="step-content" id="step-telegram">
        <div class="text-center mb-8">
          <div class="check-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
          <h1 class="text-3xl font-bold mb-2">Presque fini ! üéâ</h1>
          <p class="text-white/40">Connecte ton robot Telegram</p>
        </div>
        <div id="telegram-initial" class="glass-card p-8 max-w-lg mx-auto text-center">
          <div class="mb-6">
            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-500/5 flex items-center justify-center text-4xl mb-4">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="#0088cc"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.96 1.25-5.54 3.66-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.37-.49 1.02-.74 3.99-1.74 6.65-2.89 7.99-3.45 3.8-1.6 4.59-1.88 5.1-1.89.11 0 .37.03.54.17.14.12.18.28.2.45-.01.06.01.24 0 .38z"/></svg>
            </div>
            <h3 class="text-xl font-semibold mb-2">Connecte-toi en 1 clic</h3>
            <p class="text-white/50 mb-6">Le bot s'ouvrira automatiquement</p>
          </div>
          <button id="connect-telegram-btn" onclick="connectTelegram()" class="btn-telegram w-full">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.02-1.96 1.25-5.54 3.66-.52.36-1 .53-1.42.52-.47-.01-1.37-.26-2.03-.48-.82-.27-1.47-.42-1.42-.88.03-.24.37-.49 1.02-.74 3.99-1.74 6.65-2.89 7.99-3.45 3.8-1.6 4.59-1.88 5.1-1.89.11 0 .37.03.54.17.14.12.18.28.2.45-.01.06.01.24 0 .38z"/></svg>
            Connecter Telegram
          </button>
          <p class="text-xs text-white/30 mt-4">üîí Connexion s√©curis√©e par token unique</p>
        </div>
        <div id="telegram-connecting" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="welcome-dots mb-6" style="justify-content: center;"><div class="welcome-dot"></div><div class="welcome-dot"></div><div class="welcome-dot"></div></div>
          <h3 class="text-xl font-semibold mb-2">En attente de connexion...</h3>
          <p class="text-white/50 mb-4">Clique sur "D√©marrer" dans Telegram</p>
          <a id="telegram-link-fallback" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">üëâ Ouvrir manuellement</a>
        </div>
        <div id="telegram-connected" class="glass-card p-8 max-w-lg mx-auto text-center" style="display: none;">
          <div class="check-icon mx-auto"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
          <h3 class="text-2xl font-bold mb-2">Telegram connect√© ! üéâ</h3>
          <p class="text-white/50 mb-6">Tu peux maintenant utiliser ton robot</p>
          <a href="compte.html" class="btn-glow">Aller √† mon espace</a>
        </div>
      </div>
    </main>
  </div>
  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODY1MTIsImV4cCI6MjA4MzQ2MjUxMn0.1W2OaRb0sApMvrG_28AoV2zUFAzrptzpwbR1c65tOPo';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const GOOGLE_CLIENT_ID = '550060390462-snigimufjktpnf13ip48cv5ioork1ur0.apps.googleusercontent.com';
    
    let currentUser = null, userProvider = null, hasGoogleSheetsAccess = false, excelData = null, chatHistory = [], finalConfig = null, isWaitingForAI = false, connectionCheckInterval = null, pendingLocalFile = null;
    const HEADER_KEYWORDS = ['cb', 'esp', 'tr', 'date', 'jour', 'recette', 'total', 'd√©pense', 'depense', 'esp√®ce', 'espece', 'carte', 'ticket', 'ch√®que', 'cheque', 'virement', 'vente', 'ca', 'tva', 'ht', 'ttc', 'montant'];

    function showWelcome(firstName) { document.getElementById('welcome-title').textContent = 'Bienvenue ' + firstName + ' ! üëã'; document.getElementById('welcome-subtitle').textContent = 'Pr√©paration de ton espace...'; document.getElementById('welcome-overlay').classList.add('active'); }
    function hideWelcome() { document.getElementById('welcome-overlay').classList.remove('active'); }

    // Loader avec √©tapes visuelles
    var loaderSteps = [];
    var loaderCurrentStep = 0;

    function initLoader(filename, steps) {
      loaderSteps = steps;
      loaderCurrentStep = 0;
      document.getElementById('loader-filename').textContent = filename;
      var stepsHtml = steps.map(function(step, i) {
        return '<div class="loader-step pending" id="loader-step-' + i + '">' +
          '<div class="loader-step-icon">' + (i + 1) + '</div>' +
          '<span class="loader-step-text">' + step + '</span></div>';
      }).join('');
      document.getElementById('loader-steps').innerHTML = stepsHtml;
      document.getElementById('loader-progress').style.width = '0%';
      document.getElementById('global-loader').classList.add('active');
      updateLoaderStep(0);
    }

    function updateLoaderStep(stepIndex) {
      loaderCurrentStep = stepIndex;
      for (var i = 0; i < loaderSteps.length; i++) {
        var stepEl = document.getElementById('loader-step-' + i);
        if (!stepEl) continue;
        stepEl.classList.remove('pending', 'active', 'done');
        if (i < stepIndex) {
          stepEl.classList.add('done');
          stepEl.querySelector('.loader-step-icon').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
        } else if (i === stepIndex) {
          stepEl.classList.add('active');
          stepEl.querySelector('.loader-step-icon').textContent = (i + 1);
        } else {
          stepEl.classList.add('pending');
          stepEl.querySelector('.loader-step-icon').textContent = (i + 1);
        }
      }
      var progress = loaderSteps.length > 1 ? (stepIndex / (loaderSteps.length - 1)) * 100 : 0;
      document.getElementById('loader-progress').style.width = progress + '%';
    }

    function showLoader(text) {
      // Fallback simple pour les appels legacy
      initLoader('', [text]);
    }

    function hideLoader() { document.getElementById('global-loader').classList.remove('active'); }
    function showToast(message, duration) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('active'); setTimeout(function() { toast.classList.remove('active'); }, duration || 3000); }

    // === STEP 3 LOADING FUNCTIONS (remplace le global loader) ===
    var step3LoadingSteps = [];
    var step3CurrentStep = 0;

    function initStep3Loading(filename, steps) {
      step3LoadingSteps = steps || ['Lecture du fichier', 'Upload vers Google Drive', 'Conversion en Google Sheet', 'D√©tection des colonnes'];
      step3CurrentStep = 0;

      // Set filename
      var filenameEl = document.getElementById('loading-filename');
      if (filenameEl) filenameEl.textContent = filename || '';

      // Build or reset steps HTML
      var stepsContainer = document.getElementById('loading-steps');
      if (stepsContainer) {
        stepsContainer.innerHTML = step3LoadingSteps.map(function(step, i) {
          return '<div class="loading-step" id="load-step-' + i + '" style="display: flex; align-items: center; gap: 14px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);">' +
            '<div class="step-icon" style="width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.3);">' + (i + 1) + '</div>' +
            '<span class="step-text" style="font-size: 14px; color: rgba(255,255,255,0.4);">' + step + '</span>' +
            '</div>';
        }).join('');
      }

      // Reset progress bar
      var progressBar = document.getElementById('loading-progress-bar');
      if (progressBar) progressBar.style.width = '0%';

      // Show loading, hide editor
      document.getElementById('config-loading').style.display = 'block';
      document.getElementById('config-editor-main').style.display = 'none';

      // Activate first step
      updateStep3Loading(0);
    }

    function updateStep3Loading(stepIndex) {
      step3CurrentStep = stepIndex;
      for (var i = 0; i < step3LoadingSteps.length; i++) {
        var stepEl = document.getElementById('load-step-' + i);
        if (!stepEl) continue;
        var iconEl = stepEl.querySelector('.step-icon');
        var textEl = stepEl.querySelector('.step-text');

        if (i < stepIndex) {
          // Done
          stepEl.style.background = 'rgba(34, 197, 94, 0.1)';
          stepEl.style.borderColor = 'rgba(34, 197, 94, 0.3)';
          iconEl.style.background = '#22c55e';
          iconEl.style.borderColor = '#22c55e';
          iconEl.style.color = 'white';
          iconEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
          textEl.style.color = '#22c55e';
        } else if (i === stepIndex) {
          // Active
          stepEl.style.background = 'rgba(255, 107, 53, 0.1)';
          stepEl.style.borderColor = 'rgba(255, 107, 53, 0.3)';
          iconEl.style.background = '#FF6B35';
          iconEl.style.borderColor = '#FF6B35';
          iconEl.style.color = 'white';
          iconEl.innerHTML = '<div class="loading-spinner" style="width: 14px; height: 14px; border: 2px solid transparent; border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>';
          textEl.style.color = '#FF6B35';
        } else {
          // Pending
          stepEl.style.background = 'rgba(255,255,255,0.03)';
          stepEl.style.borderColor = 'rgba(255,255,255,0.06)';
          iconEl.style.background = 'rgba(255,255,255,0.05)';
          iconEl.style.borderColor = 'rgba(255,255,255,0.1)';
          iconEl.style.color = 'rgba(255,255,255,0.3)';
          iconEl.textContent = (i + 1);
          textEl.style.color = 'rgba(255,255,255,0.4)';
        }
      }
      // Update progress bar
      var progress = step3LoadingSteps.length > 1 ? (stepIndex / (step3LoadingSteps.length - 1)) * 100 : 0;
      var progressBar = document.getElementById('loading-progress-bar');
      if (progressBar) progressBar.style.width = progress + '%';
    }

    function completeStep3Loading() {
      // Mark all steps as done
      for (var i = 0; i < step3LoadingSteps.length; i++) {
        var stepEl = document.getElementById('load-step-' + i);
        if (!stepEl) continue;
        var iconEl = stepEl.querySelector('.step-icon');
        var textEl = stepEl.querySelector('.step-text');

        stepEl.style.background = 'rgba(34, 197, 94, 0.1)';
        stepEl.style.borderColor = 'rgba(34, 197, 94, 0.3)';
        iconEl.style.background = '#22c55e';
        iconEl.style.borderColor = '#22c55e';
        iconEl.style.color = 'white';
        iconEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
        textEl.style.color = '#22c55e';
      }
      // Progress bar to 100%
      var progressBar = document.getElementById('loading-progress-bar');
      if (progressBar) progressBar.style.width = '100%';
    }

    // Convert ArrayBuffer to Base64 using native Blob/FileReader (fast, no stack overflow)
    function arrayBufferToBase64(buffer) {
      console.log('[BASE64] Starting conversion, buffer size:', buffer.byteLength);
      return new Promise(function(resolve, reject) {
        var blob = new Blob([buffer]);
        console.log('[BASE64] Blob created, size:', blob.size);
        var reader = new FileReader();
        reader.onload = function() {
          console.log('[BASE64] FileReader onload triggered');
          // Result is "data:application/octet-stream;base64,XXXXX"
          var dataUrl = reader.result;
          console.log('[BASE64] DataURL length:', dataUrl.length);
          var base64 = dataUrl.split(',')[1];
          console.log('[BASE64] Base64 extracted, length:', base64.length);
          resolve(base64);
        };
        reader.onerror = function(e) {
          console.error('[BASE64] FileReader error:', e);
          reject(e);
        };
        reader.readAsDataURL(blob);
      });
    }

    // IndexedDB helpers for storing large files (no size limit like localStorage)
    const DB_NAME = 'iArmyCompta';
    const DB_STORE = 'pendingFiles';
    function openDB() {
      return new Promise(function(resolve, reject) {
        var request = indexedDB.open(DB_NAME, 1);
        request.onerror = function() { reject(request.error); };
        request.onsuccess = function() { resolve(request.result); };
        request.onupgradeneeded = function(e) {
          var db = e.target.result;
          if (!db.objectStoreNames.contains(DB_STORE)) {
            db.createObjectStore(DB_STORE, { keyPath: 'id' });
          }
        };
      });
    }
    async function storeInDB(data) {
      var db = await openDB();
      return new Promise(function(resolve, reject) {
        var tx = db.transaction(DB_STORE, 'readwrite');
        var store = tx.objectStore(DB_STORE);
        var request = store.put({ id: 'pendingConfig', ...data });
        request.onsuccess = function() { resolve(); };
        request.onerror = function() { reject(request.error); };
      });
    }
    async function getFromDB() {
      var db = await openDB();
      return new Promise(function(resolve, reject) {
        var tx = db.transaction(DB_STORE, 'readonly');
        var store = tx.objectStore(DB_STORE);
        var request = store.get('pendingConfig');
        request.onsuccess = function() { resolve(request.result); };
        request.onerror = function() { reject(request.error); };
      });
    }
    async function clearFromDB() {
      var db = await openDB();
      return new Promise(function(resolve, reject) {
        var tx = db.transaction(DB_STORE, 'readwrite');
        var store = tx.objectStore(DB_STORE);
        var request = store.delete('pendingConfig');
        request.onsuccess = function() { resolve(); };
        request.onerror = function() { reject(request.error); };
      });
    }

    function formatDate(dateString) { const date = new Date(dateString); const diff = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24)); if (diff === 0) return "aujourd'hui"; if (diff === 1) return "hier"; if (diff < 7) return 'il y a ' + diff + ' jours'; return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }); }

    async function initComptaPage() {
      console.log('[COMPTA] Init');
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { window.location.href = 'index.html'; return; }
      currentUser = session.user;
      userProvider = session.user.app_metadata?.provider || 'email';
      console.log('[COMPTA] Connecte:', currentUser.email);

      // Welcome uniquement a la premiere connexion
      var welcomeKey = 'iarmy_welcomed_' + currentUser.id;
      if (!localStorage.getItem(welcomeKey)) {
        var firstName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.user_metadata?.name?.split(' ')[0] || currentUser.email?.split('@')[0] || 'toi';
        showWelcome(firstName);
        localStorage.setItem(welcomeKey, '1');
        setTimeout(hideWelcome, 1500);
      }

      await updateNavBar();
      await checkGoogleSheetsAccess();

      // Afficher le bon ecran selon l'etat Google Sheets
      if (hasGoogleSheetsAccess) {
        showStepChoice();
      } else {
        // Step 1 = Connexion Google (pas encore fait)
        updateSidebarStep(1);
      }

      setupUploadZone();
    }

    function showStepChoice() {
      document.querySelectorAll('.step-content').forEach(function(c) { c.classList.remove('active'); });
      document.getElementById('step-choice').classList.add('active');
      updateSidebarStep(2); // √âtape 2 = Ton fichier (apr√®s Google connect√©)
    }

    async function checkGoogleSheetsAccess() {
      const { data: credentials } = await supabaseClient.from('google_credentials').select('refresh_token').eq('user_id', currentUser.id).single();
      hasGoogleSheetsAccess = !!(credentials && credentials.refresh_token);
      console.log('[COMPTA]', hasGoogleSheetsAccess ? '‚úÖ Google Sheets autoris√©' : '‚ùå Pas encore autoris√©');
    }

    function updateGoogleSheetsButton() {
      const btn = document.getElementById('btn-google-sheets');
      if (hasGoogleSheetsAccess) { btn.classList.add('connected'); btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg><span>Choisir mon fichier</span>'; }
      else if (userProvider === 'google') { btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="#0f9d58"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg><span>Autoriser l\'acc√®s √† Google Sheets</span>'; }
      else { btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/><path fill="#34A853" d="M6.3 14.7l6.6 4.8C14.1 16.2 18.7 13 24 13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.1 2 9.3 6.2 6.3 14.7z"/><path fill="#FBBC05" d="M24 46c5.5 0 10.3-2 14.1-5.3l-6.5-5.5C29.5 37 26.9 38 24 38c-6.1 0-11.2-3.9-13.1-9.3l-6.6 5.1C7.3 41.4 15.1 46 24 46z"/><path fill="#EA4335" d="M46.5 20H24v8.5h11.8c-.8 2.4-2.3 4.5-4.3 6l6.5 5.5C41.8 36.5 46 30.9 46 24c0-1.3-.1-2.6-.5-4z"/></svg><span>Se connecter avec Google</span>'; }
    }

    async function handleGoogleSheetsClick() { if (hasGoogleSheetsAccess) await openSheetsPicker(); else authorizeGoogleSheets(); }

    function authorizeGoogleSheets() {
      var REDIRECT_URI = window.location.origin + window.location.pathname;
      var SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive';
      var authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=' + GOOGLE_CLIENT_ID + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) + '&response_type=code&scope=' + encodeURIComponent(SCOPES) + '&access_type=offline&prompt=consent&state=sheets_auth';
      if (currentUser?.email) authUrl += '&login_hint=' + encodeURIComponent(currentUser.email);
      window.location.href = authUrl;
    }

    async function handleSheetsCallback() {
      var urlParams = new URLSearchParams(window.location.search);
      var code = urlParams.get('code'), state = urlParams.get('state');
      if (!code || state !== 'sheets_auth') return false;
      console.log('[COMPTA] üîÑ Processing Sheets callback...');
      showLoader('Connexion √† Google Sheets...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) throw new Error('Session expir√©e');
        var response = await fetch(SUPABASE_URL + '/functions/v1/google-sheets-auth', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY }, body: JSON.stringify({ code: code, redirect_uri: window.location.origin + window.location.pathname }) });
        var result = await response.json();
        if (!result.success) throw new Error(result.error || '√âchec');
        console.log('[COMPTA] ‚úÖ Sheets connect√© !');
        window.history.replaceState({}, document.title, window.location.pathname);
        hasGoogleSheetsAccess = true;
        hideLoader();
        showToast('‚úÖ Google Sheets connect√© !');
        updateGoogleSheetsButton();

        // Check if we have a pending config to process (user was validating when they connected)
        var pendingData = await getFromDB();
        if (pendingData) {
          console.log('[COMPTA] üìã Pending config found after auth, processing...');
          await clearFromDB();

          // Check if this is the empty template flow
          if (pendingData.isEmptyTemplateFlow) {
            console.log('[COMPTA] üÜï Empty template flow detected, creating template...');
            isEmptyTemplateFlow = true;
            await createEmptyTemplate();
            return true;
          }

          // Restore state
          pendingConfig = pendingData.config;
          excelData = pendingData.excelData;

          // If we have stored file buffer, upload it automatically
          if (pendingData.fileBuffer) {
            console.log('[COMPTA] üì§ Uploading stored file...');
            // Convert ArrayBuffer to base64 using native method (no stack overflow)
            var base64 = await arrayBufferToBase64(pendingData.fileBuffer);
            await uploadStoredFile(base64, pendingData.fileName, pendingData.fileMimeType);
          } else {
            // No file to upload, just save the config
            await saveConfigAndContinue();
          }
          return true;
        }

        // Normal flow - show choice screen
        showStepChoice();
        return true;
      } catch (error) { console.error('[COMPTA] ‚ùå', error); hideLoader(); alert('Erreur: ' + error.message); window.history.replaceState({}, document.title, window.location.pathname); return false; }
    }

    async function openSheetsPicker() {
      showLoader('Chargement de tes fichiers...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        var apiUrl = SUPABASE_URL + '/functions/v1/list-google-sheets';
        console.log('[SHEETS] ====== FETCH START ======');
        console.log('[SHEETS] URL:', apiUrl);
        console.log('[SHEETS] Token:', session.access_token ? 'OK (length: ' + session.access_token.length + ')' : 'MISSING');
        var response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ limit: 50 })
        });
        console.log('[SHEETS] Response status:', response.status);
        var result = await response.json();
        console.log('[SHEETS] API Response:', result);
        console.log('[SHEETS] Total files received:', result.sheets?.length || 0);
        console.log('[SHEETS] ====== FETCH END ======');

        hideLoader();
        if (!result.success) throw new Error(result.error);
        if (result.sheets?.length > 0) showSheetsOverlay(result.sheets); else showNoSheetsMessage();
      } catch (error) { console.error('[SHEETS] Error:', error); hideLoader(); alert('Erreur: ' + error.message); }
    }

    var allSheets = []; // Store all sheets for filtering
    var currentFilter = 'all';
    var showAllFiles = false;
    var MAX_FILES = 10;
    var isSearchMode = false;
    var searchTimeout = null;

    // Priority keywords for identifying likely compta files
    var PRIORITY_KEYWORDS = ['compta', 'recette', 'caisse', 'comptabilit√©', 'comptabilite', 'vente', 'recettes', 'depense', 'tresorerie'];

    function isLikelyComptaFile(sheet) {
      var name = sheet.name.toLowerCase();
      // Check if name contains priority keywords
      var hasKeyword = PRIORITY_KEYWORDS.some(function(kw) { return name.includes(kw); });
      // Check if recently modified (within last 30 days)
      var modDate = new Date(sheet.modifiedTime);
      var thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      var isRecent = modDate > thirtyDaysAgo;
      // A file is likely compta if it has keyword AND is recent
      return hasKeyword && isRecent;
    }

    function sortByDate(sheets) {
      return sheets.slice().sort(function(a, b) {
        return new Date(b.modifiedTime) - new Date(a.modifiedTime);
      });
    }

    function showSheetsOverlay(sheets) {
      console.log('[SHEETS] showSheetsOverlay called with', sheets.length, 'sheets');
      // Sort all by date
      allSheets = sortByDate(sheets);
      console.log('[SHEETS] allSheets stored:', allSheets.length);
      currentFilter = 'all';
      showAllFiles = false;
      isSearchMode = false;
      document.getElementById('sheets-search-input').value = '';
      // Reset folder tabs
      document.querySelectorAll('.sheets-folder').forEach(function(f, i) { f.classList.toggle('active', i === 0); });
      // Render with suggested section
      renderSheetsWithSuggested(allSheets);
      document.getElementById('sheets-overlay').classList.add('active');
    }

    function renderSheetsWithSuggested(sheets) {
      // Identify suggested files (likely compta)
      var suggested = sheets.filter(isLikelyComptaFile).slice(0, 3); // Max 3 suggested
      var suggestedIds = suggested.map(function(s) { return s.id; });
      var others = sheets.filter(function(s) { return suggestedIds.indexOf(s.id) === -1; });

      console.log('[SHEETS] Suggested:', suggested.length, 'Others:', others.length);

      // Render suggested section
      var suggestedSection = document.getElementById('sheets-suggested');
      var suggestedGrid = document.getElementById('sheets-suggested-grid');
      if (suggested.length > 0 && !isSearchMode) {
        suggestedGrid.innerHTML = suggested.map(renderSheetCard).join('');
        suggestedSection.style.display = 'block';
      } else {
        suggestedSection.style.display = 'none';
      }

      // Update file count (hidden on mobile)
      document.getElementById('sheets-file-count').textContent = '(' + others.length + ')';

      // Render other files
      renderSheetsList(others);
    }

    function renderSheetCard(sheet) {
      var isExcel = sheet.fileType === 'excel-xlsx' || sheet.fileType === 'excel-xls';
      var iconBg = isExcel ? 'rgba(33, 115, 70, 0.15)' : 'rgba(15, 157, 88, 0.15)';
      var iconColor = isExcel ? '#217346' : '#0f9d58';
      var iconSvg = isExcel
        ? '<svg viewBox="0 0 24 24" fill="' + iconColor + '"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 9h-2v2H9v-2H7v-2h2V7h2v2h2v2zm0 4h-2v2H9v-2H7v-2h2v-2h2v2h2v2zm1-6V3.5L18.5 8H14z"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="' + iconColor + '"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H6v-2h6v2zm4-4H6v-2h10v2zm0-4H6V7h10v2z"/></svg>';
      var typeLabel = isExcel ? ' <span style="font-size:10px;background:rgba(33,115,70,0.2);color:#217346;padding:2px 6px;border-radius:4px;margin-left:6px;">Excel</span>' : '';

      return '<div class="sheet-card" onclick="selectSheet({id:\'' + sheet.id + '\',name:\'' + sheet.name.replace(/'/g, "\\'") + '\',fileType:\'' + (sheet.fileType || 'google-sheet') + '\'})">' +
        '<div class="sheet-card-icon" style="background:' + iconBg + '">' + iconSvg + '</div>' +
        '<div class="sheet-card-info"><h3>' + sheet.name + typeLabel + '</h3><p><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' + formatDate(sheet.modifiedTime) + '</p></div>' +
        '<svg class="sheet-card-arrow" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>';
    }

    function getFilteredSheets() {
      console.log('[SHEETS] getFilteredSheets - currentFilter:', currentFilter, 'allSheets:', allSheets.length);
      var filtered = allSheets;
      if (currentFilter === 'recent') {
        // Already sorted by date, just return all (limit handled by renderSheetsList)
        filtered = allSheets;
      } else if (currentFilter === 'shared') {
        filtered = allSheets.filter(function(sheet) { return sheet.shared === true; });
      }
      console.log('[SHEETS] getFilteredSheets returning:', filtered.length);
      return filtered;
    }

    function renderSheetsList(sheets) {
      console.log('[SHEETS] renderSheetsList called with', sheets.length, 'sheets, showAllFiles:', showAllFiles);
      var grid = document.getElementById('sheets-grid');
      if (sheets.length === 0) {
        grid.innerHTML = '<div class="sheets-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg><h4>Aucun fichier trouve</h4><p>Essayez une autre recherche</p></div>';
        document.getElementById('sheets-suggested').style.display = 'none';
        return;
      }
      // Limit to MAX_FILES unless showAllFiles is true
      var displaySheets = showAllFiles ? sheets : sheets.slice(0, MAX_FILES);
      var hasMore = sheets.length > MAX_FILES && !showAllFiles;
      console.log('[SHEETS] Displaying', displaySheets.length, 'sheets, hasMore:', hasMore);

      var html = displaySheets.map(renderSheetCard).join('');

      if (hasMore) {
        html += '<div onclick="showMoreFiles()" style="text-align: center; padding: 16px; color: rgba(255,255,255,0.5); cursor: pointer; border: 1px dashed rgba(255,255,255,0.15); border-radius: 16px; margin-top: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor=\'rgba(255,107,53,0.4)\';this.style.color=\'#FF8B5E\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.15)\';this.style.color=\'rgba(255,255,255,0.5)\'">Voir ' + (sheets.length - MAX_FILES) + ' fichiers de plus...</div>';
      }
      grid.innerHTML = html;
    }

    function showMoreFiles() {
      showAllFiles = true;
      renderSheetsList(getFilteredSheets());
    }

    function filterSheetsList(query) {
      var q = query.trim();
      showAllFiles = false;

      // Clear any pending search timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
        searchTimeout = null;
      }

      // If empty query, show original list with suggested
      if (!q) {
        isSearchMode = false;
        renderSheetsWithSuggested(allSheets);
        return;
      }

      // Search mode: hide suggested section
      isSearchMode = true;
      document.getElementById('sheets-suggested').style.display = 'none';

      // First: instant local filter for immediate feedback
      var localFiltered = allSheets.filter(function(sheet) {
        return sheet.name.toLowerCase().includes(q.toLowerCase());
      });
      document.getElementById('sheets-file-count').textContent = '(' + localFiltered.length + ')';
      renderSheetsList(localFiltered);

      // Then: debounced API search for more results (after 500ms)
      searchTimeout = setTimeout(async function() {
        try {
          console.log('[SHEETS] API search for:', q);
          var { data: { session } } = await supabaseClient.auth.getSession();
          var response = await fetch(SUPABASE_URL + '/functions/v1/list-google-sheets', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + session.access_token,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ limit: 50, search: q })
          });
          var result = await response.json();
          if (result.success && result.sheets) {
            console.log('[SHEETS] API search returned:', result.sheets.length, 'files');
            // Only update if still in search mode with same query
            var currentQuery = document.getElementById('sheets-search-input').value.trim();
            if (currentQuery === q) {
              var sorted = sortByDate(result.sheets);
              document.getElementById('sheets-file-count').textContent = '(' + sorted.length + ')';
              renderSheetsList(sorted);
            }
          }
        } catch (e) {
          console.error('[SHEETS] API search error:', e);
        }
      }, 500);
    }

    function filterByFolder(folder, element) {
      console.log('[SHEETS] filterByFolder called:', folder);
      // Update active state
      document.querySelectorAll('.sheets-folder').forEach(function(f) { f.classList.remove('active'); });
      element.classList.add('active');
      currentFilter = folder;
      showAllFiles = false;
      isSearchMode = false;
      document.getElementById('sheets-search-input').value = '';
      var filtered = getFilteredSheets();
      console.log('[SHEETS] After filter, rendering', filtered.length, 'sheets');
      // Show suggested only for 'all' filter
      if (folder === 'all') {
        renderSheetsWithSuggested(filtered);
      } else {
        document.getElementById('sheets-suggested').style.display = 'none';
        document.getElementById('sheets-file-count').textContent = '(' + filtered.length + ')';
        renderSheetsList(filtered);
      }
    }

    function showNoSheetsMessage() {
      allSheets = [];
      document.getElementById('sheets-grid').innerHTML = '<div class="sheets-empty"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg><h4>Aucun fichier trouve</h4><p>Cree un Google Sheet et reviens ici</p></div><a href="https://sheets.google.com/create" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #0f9d58, #0a7e3e); padding: 14px 24px; border-radius: 12px; color: white; text-decoration: none; font-weight: 600; margin-top: 16px; justify-content: center; width: 100%;">+ Creer un Google Sheet</a>';
      document.getElementById('sheets-overlay').classList.add('active');
    }
    function closeSheetsOverlay() { document.getElementById('sheets-overlay').classList.remove('active'); }
    async function refreshSheets() {
      // Force refresh from Google API
      console.log('[SHEETS] ====== REFRESH START ======');
      showLoader('Actualisation des fichiers...');
      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        var apiUrl = SUPABASE_URL + '/functions/v1/list-google-sheets';
        console.log('[SHEETS] URL:', apiUrl);
        var response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY,
            'Cache-Control': 'no-cache'
          },
          body: JSON.stringify({ limit: 50 })
        });
        console.log('[SHEETS] Response status:', response.status);
        var result = await response.json();
        console.log('[SHEETS] Refresh response:', result);
        console.log('[SHEETS] Refresh got', result.sheets?.length || 0, 'sheets');
        console.log('[SHEETS] ====== REFRESH END ======');

        hideLoader();
        if (!result.success) throw new Error(result.error);
        if (result.sheets?.length > 0) {
          showSheetsOverlay(result.sheets);
          showToast('Liste actualisee !');
        } else {
          showNoSheetsMessage();
        }
      } catch (error) {
        console.error('[SHEETS] Refresh error:', error);
        hideLoader();
        alert('Erreur: ' + error.message);
      }
    }

    // Variables for verification flow
    var pendingConvertedSheet = null;
    var pendingCompareUrls = { original: '', converted: '' };

    async function selectSheet(sheet) {
      console.log('[COMPTA] üìÑ Sheet s√©lectionn√©:', sheet.name, 'fileType:', sheet.fileType);
      closeSheetsOverlay();

      var { data: { session } } = await supabaseClient.auth.getSession();
      var sheetToUse = { id: sheet.id, name: sheet.name };

      // Check if it's an Excel file that needs conversion
      var isExcel = sheet.fileType === 'excel-xlsx' || sheet.fileType === 'excel-xls';

      if (isExcel) {
        // Show conversion loader with explanation
        showLoader('Fichier Excel detecte !\n\nConversion en Google Sheet...\n(ton fichier original reste intact)');

        try {
          console.log('[COMPTA] üîÑ Converting Excel to Google Sheet...');
          var convertResponse = await fetch(SUPABASE_URL + '/functions/v1/clever-function', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + session.access_token,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ fileId: sheet.id, fileName: sheet.name })
          });

          var convertResult = await convertResponse.json();
          console.log('[COMPTA] Conversion result:', convertResult);

          if (!convertResult.success) throw new Error(convertResult.error || 'Conversion √©chou√©e');

          // Use the converted Google Sheet
          sheetToUse = { id: convertResult.sheet.id, name: convertResult.sheet.name };
          console.log('[COMPTA] ‚úÖ Conversion r√©ussie:', sheetToUse.name);

          hideLoader();

          // Check verification result
          if (convertResult.verification && !convertResult.verification.success) {
            // Show warning modal
            console.log('[COMPTA] ‚ö†Ô∏è Diff√©rences d√©tect√©es:', convertResult.verification.differences);
            pendingConvertedSheet = sheetToUse;
            pendingCompareUrls = {
              original: convertResult.sheet.originalWebViewLink,
              converted: convertResult.sheet.webViewLink
            };
            showVerifyWarning(convertResult.verification.differences);
            return; // Wait for user action
          }

        } catch (error) {
          console.error('[COMPTA] ‚ùå Conversion error:', error);
          hideLoader();
          alert('Erreur de conversion: ' + error.message);
          return;
        }
      }

      // Continue with the Google Sheet (original or converted)
      await loadAndAnalyzeSheet(sheetToUse, session);
    }

    function showVerifyWarning(differences) {
      var diffHtml = '<ul style="margin: 0; padding-left: 20px;">';
      differences.forEach(function(diff) {
        diffHtml += '<li style="margin-bottom: 6px;">' + diff + '</li>';
      });
      diffHtml += '</ul>';
      document.getElementById('verify-differences').innerHTML = diffHtml;
      document.getElementById('verify-overlay').classList.add('active');
    }

    function closeVerifyOverlay() {
      document.getElementById('verify-overlay').classList.remove('active');
      pendingConvertedSheet = null;
      pendingCompareUrls = { original: '', converted: '' };
    }

    function openCompareFiles() {
      // Open both files in new tabs side by side
      if (pendingCompareUrls.original) {
        window.open(pendingCompareUrls.original, '_blank');
      }
      if (pendingCompareUrls.converted) {
        window.open(pendingCompareUrls.converted, '_blank');
      }
    }

    async function continueAfterVerify() {
      closeVerifyOverlay();
      if (!pendingConvertedSheet) return;

      var { data: { session } } = await supabaseClient.auth.getSession();
      showToast('‚ö†Ô∏è V√©rifie que tout est OK dans le fichier converti.');
      await new Promise(function(r) { setTimeout(r, 1000); });
      await loadAndAnalyzeSheet(pendingConvertedSheet, session);
    }

    async function loadAndAnalyzeSheet(sheetToUse, session) {
      // On est d√©j√† dans l'√©tape 3 avec le loading en cours
      try {
        // Refresh session pour avoir un token frais
        console.log('[COMPTA] Original session token preview:', session?.access_token?.substring(0, 30) || 'NONE');
        var { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
        var freshSession = refreshData?.session || session;
        console.log('[COMPTA] Fresh session token preview:', freshSession?.access_token?.substring(0, 30) || 'NONE');
        if (refreshError) {
          console.warn('[COMPTA] Session refresh warning:', refreshError.message);
        } else {
          console.log('[COMPTA] Session refreshed OK');
        }

        // 1. Mettre √† jour google_credentials avec le sheet s√©lectionn√©
        await supabaseClient.from('google_credentials').update({ sheet_id: sheetToUse.id, sheet_name: sheetToUse.name }).eq('user_id', freshSession.user.id);

        // 2. Cr√©er/mettre √† jour user_configs avec le sheet_id
        await supabaseClient.from('user_configs').upsert({
          user_id: freshSession.user.id,
          sheet_id: sheetToUse.id,
          excel_config: {},
          is_active: true
        }, { onConflict: 'user_id' });
        console.log('[COMPTA] ‚úÖ user_configs initialis√© avec sheet_id:', sheetToUse.id);

        // 3. Stocker les infos du sheet
        excelData = { fileName: sheetToUse.name, sheetId: sheetToUse.id, sheetName: sheetToUse.name, webViewLink: sheetToUse.webViewLink };

        // 4. Lancer l'analyse (lecture + d√©tection) - on est d√©j√† √† l'√©tape 3
        await startAnalysisWithSheetRead(sheetToUse.id, freshSession.access_token);
      } catch (error) {
        console.error('[COMPTA] ‚ùå', error);
        showAnalyseError(error.message);
      }
    }

    async function startAnalysisWithSheetRead(sheetId, accessToken) {
      console.log('[ANALYSE] Starting with sheetId:', sheetId);
      console.log('[ANALYSE] Token present:', !!accessToken);

      // Reset
      analyseExchangeCount = 0;
      analyseChatHistory = [];
      pendingQuestions = [];

      // On est d√©j√† √† l'√©tape 3 avec le loading visible
      // S'assurer que le loading est visible et l'√©diteur cach√©
      document.getElementById('config-loading').style.display = 'block';
      document.getElementById('config-editor-main').style.display = 'none';

      isWaitingForAI = true;

      try {
        // Etape 1: Lecture du Google Sheet
        console.log('[ANALYSE] Reading Google Sheet:', sheetId);
        var readResponse = await fetch(SUPABASE_URL + '/functions/v1/read-google-sheet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ sheetId: sheetId })
        });

        var readResult = await readResponse.json();
        console.log('[ANALYSE] Read result:', readResult);
        if (!readResult.success) throw new Error(readResult.error || 'Lecture echouee (pas de detail)');

        console.log('[ANALYSE] Sheet data received:', readResult.excelData?.fileName);

        // DEBUG: Afficher les headers d√©tect√©s pour v√©rifier les lettres de colonnes
        if (readResult.excelData?.sheets?.[0]?.detectedHeaders?.columns) {
          var headers = readResult.excelData.sheets[0].detectedHeaders.columns;
          var importantHeaders = headers.filter(function(h) {
            return /^(CB|ESP|TR|D√©penses|Recettes|Date|Jour)$/i.test(h.name);
          });
          console.log('========================================');
          console.log('[DEBUG] HEADERS D√âTECT√âS PAR read-google-sheet:');
          importantHeaders.forEach(function(h) {
            console.log('  ' + h.name + ' = colonne ' + h.letter);
          });
          var detectedDateCol = readResult.excelData.sheets[0].detectedDateColumn;
          console.log('[DEBUG] COLONNE DATE PR√â-D√âTECT√âE: ' + (detectedDateCol || 'NON D√âTECT√âE'));
          console.log('========================================');
        }

        // Mettre a jour excelData avec les vraies donnees du sheet
        excelData = readResult.excelData;
        excelData.sheetId = sheetId;
        excelData.isGoogleSheet = true;

        // Etape 2: Analyse avec Claude
        var response = await callAPI('analyze');

        var cleanResponse = response.trim();
        if (cleanResponse.includes('```json')) cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            var parsedConfig = JSON.parse(jsonMatch[0]);
            console.log('[ANALYSE] Config detectee:', parsedConfig);

            // DEBUG: Comparer ce que Claude a d√©tect√©
            if (parsedConfig.colonnes_a_remplir) {
              console.log('========================================');
              console.log('[DEBUG] COLONNES D√âTECT√âES PAR CLAUDE:');
              parsedConfig.colonnes_a_remplir.forEach(function(c) {
                console.log('  ' + c.nom + ' = colonne ' + c.colonne);
              });
              console.log('========================================');
            }

            // FIX UNIVERSEL: Trouver la colonne date la plus proche de CB
            if (parsedConfig.colonnes_a_remplir && excelData && excelData.sheets && excelData.sheets[0]) {
              var cbCol = parsedConfig.colonnes_a_remplir.find(function(c) {
                return c.nom && c.nom.toUpperCase() === 'CB';
              });
              if (cbCol && cbCol.colonne) {
                var cbIndex = cbCol.colonne.toUpperCase().charCodeAt(0) - 65;
                var allRows = excelData.sheets[0].allRows || [];

                // Chercher toutes les colonnes avec des jours 1-31
                var dateCandidates = [];
                for (var colIdx = 0; colIdx < 26; colIdx++) {
                  var dayCount = 0;
                  var colLetter = String.fromCharCode(65 + colIdx);
                  allRows.forEach(function(row) {
                    if (row.cells) {
                      var cell = row.cells.find(function(c) { return c.col === colLetter; });
                      if (cell && cell.val) {
                        var num = parseInt(cell.val);
                        if (!isNaN(num) && num >= 1 && num <= 31) dayCount++;
                      }
                    }
                  });
                  if (dayCount >= 8) {
                    dateCandidates.push({
                      letter: colLetter,
                      index: colIdx,
                      distance: Math.abs(colIdx - cbIndex)
                    });
                  }
                }

                if (dateCandidates.length > 0) {
                  console.log('[FIX] Colonnes date candidates:', dateCandidates.map(function(c) {
                    return c.letter + '(dist=' + c.distance + ')';
                  }).join(', '));

                  dateCandidates.sort(function(a, b) { return a.distance - b.distance; });
                  var bestDate = dateCandidates[0].letter;
                  if (parsedConfig.colonne_date !== bestDate) {
                    console.log('[FIX] Colonne date corrig√©e: ' + parsedConfig.colonne_date + ' -> ' + bestDate + ' (plus proche de CB=' + cbCol.colonne + ')');
                    parsedConfig.colonne_date = bestDate;
                  }
                }
              }
            }

            showAnalyseResult(parsedConfig);
          } catch (parseErr) {
            console.error('[ANALYSE] JSON parse error:', parseErr);
            showAnalyseError("Erreur d'analyse. Reessaie ?");
          }
        } else {
          showAnalyseError("Je n'ai pas pu analyser le fichier.");
        }
      } catch (err) {
        console.error('[ANALYSE] Error:', err);
        showAnalyseError("Erreur: " + err.message);
      }
      isWaitingForAI = false;
    }

    async function updateNavBar() {
      var authButtons = document.getElementById('auth-buttons');
      if (!currentUser) { authButtons.innerHTML = '<a href="index.html">Retour</a>'; return; }
      var userName = currentUser.user_metadata?.full_name?.split(' ')[0] || currentUser.user_metadata?.name?.split(' ')[0] || currentUser.email?.split('@')[0] || 'User';
      var userAvatar = currentUser.user_metadata?.avatar_url || 'https://ui-avatars.com/api/?name=' + userName + '&background=FF6B35&color=fff';
      authButtons.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;"><a href="compte.html" id="user-profile-btn" style="display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(255,255,255,0.04); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; text-decoration: none; color: white; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"><img src="' + userAvatar + '" style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,107,53,0.3); box-shadow: 0 0 12px rgba(255,107,53,0.2);"><span style="font-weight: 500; font-size: 14px;">' + userName + '</span></a><button onclick="signOut()" id="logout-btn" style="padding: 10px; background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; color: rgba(255,255,255,0.4); cursor: pointer; transition: all 0.3s ease;" title="D√©connexion"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button></div>';
      // Add hover effects
      var profileBtn = document.getElementById('user-profile-btn');
      var logoutBtn = document.getElementById('logout-btn');
      if (profileBtn) {
        profileBtn.onmouseover = function() { this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,107,53,0.3)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.25), 0 0 20px rgba(255,107,53,0.1)'; };
        profileBtn.onmouseout = function() { this.style.background='rgba(255,255,255,0.04)'; this.style.borderColor='rgba(255,255,255,0.08)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'; };
      }
      if (logoutBtn) {
        logoutBtn.onmouseover = function() { this.style.background='rgba(239,68,68,0.1)'; this.style.borderColor='rgba(239,68,68,0.3)'; this.style.color='#f87171'; this.style.boxShadow='0 4px 12px rgba(239,68,68,0.15)'; };
        logoutBtn.onmouseout = function() { this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.06)'; this.style.color='rgba(255,255,255,0.4)'; this.style.boxShadow='none'; };
      }
    }
    async function signOut() { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

    function setupUploadZone() {
      var uploadZone = document.getElementById('upload-zone');
      var dropArea = document.getElementById('drop-area');
      var fileInput = document.getElementById('file-input');

      // Setup old upload zone if it exists
      if (uploadZone) {
        uploadZone.addEventListener('click', function() { fileInput.click(); });
        uploadZone.addEventListener('dragover', function(e) { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', function() { uploadZone.classList.remove('dragover'); });
        uploadZone.addEventListener('drop', function(e) { e.preventDefault(); uploadZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
      }

      // Setup new drop area (step-choice)
      if (dropArea) {
        dropArea.addEventListener('dragover', function(e) { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('dragover'); });
        dropArea.addEventListener('dragleave', function(e) { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('dragover'); });
        dropArea.addEventListener('drop', function(e) {
          console.log('[DROP] Drop event triggered');
          e.preventDefault();
          e.stopPropagation();
          dropArea.classList.remove('dragover');
          console.log('[DROP] Files count:', e.dataTransfer.files.length);
          if (e.dataTransfer.files.length > 0) {
            console.log('[DROP] Calling handleFile...');
            handleFile(e.dataTransfer.files[0]);
          }
        });
      }

      // Always setup file input listener
      if (fileInput) {
        fileInput.addEventListener('change', function(e) { if (e.target.files[0]) handleFile(e.target.files[0]); });
      }

      document.getElementById('chat-input')?.addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });
      document.getElementById('chat-send-btn')?.addEventListener('click', sendMessage);
    }
    
    function detectHeaderRow(rows) { var bestRow = null, bestScore = 0; rows.forEach(function(row) { if (row.row === '...') return; var score = 0; row.cells.forEach(function(cell) { var val = String(cell.val).toLowerCase(); HEADER_KEYWORDS.forEach(function(kw) { if (val.includes(kw)) score++; }); }); if (score > bestScore) { bestScore = score; bestRow = row; } }); return bestRow; }
    
    async function handleFile(file) {
      console.log('[HANDLE_FILE] START - file:', file.name, 'size:', file.size);
      var ext = '.' + file.name.split('.').pop().toLowerCase();
      console.log('[HANDLE_FILE] Extension:', ext);
      if (!['.xlsx', '.xls', '.csv'].includes(ext)) { alert('Format non support√©'); return; }

      // Store file for potential later upload (after Google auth)
      if (ext !== '.csv') {
        pendingLocalFile = file;
        console.log('[COMPTA] üìÅ Fichier local stock√© pour upload ult√©rieur:', file.name);
      }

      // Si l'utilisateur a acc√®s √† Google Sheets, uploader et convertir directement
      console.log('[HANDLE_FILE] hasGoogleSheetsAccess:', hasGoogleSheetsAccess);
      if (hasGoogleSheetsAccess && ext !== '.csv') {
        console.log('[HANDLE_FILE] Calling handleFileWithUpload...');
        await handleFileWithUpload(file);
        return;
      }

      // Sinon, analyse locale d'abord (on demandera Google √† la validation)
      goToStep(2);
      var reader = new FileReader();
      reader.onload = async function(e) {
        try {
          var data = new Uint8Array(e.target.result);
          var workbook = XLSX.read(data, { type: 'array', cellFormula: true });
          excelData = { fileName: file.name, sheets: [], isGoogleSheet: false };
          workbook.SheetNames.forEach(function(sheetName, sheetIndex) {
            var sheet = workbook.Sheets[sheetName];
            if (!sheet['!ref']) return;
            var range = XLSX.utils.decode_range(sheet['!ref']);
            if (sheetIndex > 0) { excelData.sheets.push({ name: sheetName, allRows: [], rowCount: range.e.r, colCount: range.e.c + 1, formulas: {}, detectedHeaders: null }); return; }
            var allRows = [], maxCol = Math.min(range.e.c, 20);
            var readRow = function(row) { var rowData = []; for (var col = 0; col <= maxCol; col++) { var cellAddress = XLSX.utils.encode_cell({ r: row, c: col }); var cell = sheet[cellAddress]; var colLetter = col < 26 ? String.fromCharCode(65 + col) : 'A' + String.fromCharCode(65 + col - 26); if (cell && cell.v !== undefined && cell.v !== null && cell.v !== '') { rowData.push({ col: colLetter, val: typeof cell.v === 'number' ? (cell.v % 1 === 0 ? cell.v : cell.v.toFixed(2)) : String(cell.v).substring(0, 30) }); } } return rowData; };
            // Lire TOUTES les lignes (jusqu'√† 100 max pour √©viter les fichiers trop gros)
            var maxRows = Math.min(range.e.r, 100);
            for (var row = 0; row <= maxRows; row++) { var rowData = readRow(row); if (rowData.length > 0) allRows.push({ row: row + 1, cells: rowData }); }
            if (range.e.r > 100) { allRows.push({ row: '...', cells: [{ col: '-', val: '(lignes ' + 101 + ' √† ' + (range.e.r + 1) + ' masqu√©es)' }] }); }
            var headerRow = detectHeaderRow(allRows);
            var detectedHeaders = headerRow ? { rowNumber: headerRow.row, columns: headerRow.cells.map(function(c) { return { letter: c.col, name: c.val }; }) } : null;
            // Capturer TOUTES les formules (jusqu'√† 100 max)
            var formulas = {}; var formulaCount = 0;
            for (var cellRef in sheet) { if (cellRef[0] !== '!' && sheet[cellRef].f && formulaCount < 100) { formulas[cellRef] = sheet[cellRef].f; formulaCount++; } }
            excelData.sheets.push({ name: sheetName, allRows: allRows, rowCount: range.e.r, colCount: range.e.c + 1, formulas: formulas, detectedHeaders: detectedHeaders });
          });
          await startAnalysis();
        } catch (err) { console.error(err); showAnalyseError("Erreur de lecture. R√©essaie avec un autre fichier ?"); }
      };
      reader.readAsArrayBuffer(file);
    }

    async function handleFileWithUpload(file) {
      console.log('[UPLOAD] === handleFileWithUpload START ===');
      console.log('[UPLOAD] File:', file.name, 'Size:', file.size, 'bytes');

      // Aller directement √† l'√©tape 3 et utiliser le loading int√©gr√©
      goToStep(3);
      initStep3Loading(file.name, [
        'Lecture du fichier',
        'Upload vers Google Drive',
        'Conversion en Google Sheet',
        'D√©tection des colonnes'
      ]);

      try {
        console.log('[UPLOAD] Getting fresh session...');
        // Force refresh to get a valid token
        var { data: { session }, error: sessionError } = await supabaseClient.auth.refreshSession();
        if (sessionError || !session) {
          console.log('[UPLOAD] Refresh failed, trying getSession...');
          var result = await supabaseClient.auth.getSession();
          session = result.data.session;
        }
        if (!session) throw new Error('Session expir√©e - reconnecte-toi');
        console.log('[UPLOAD] Session OK, token expires:', new Date(session.expires_at * 1000).toLocaleString());

        // √âtape 1: Lire le fichier
        console.log('[UPLOAD] Reading file as ArrayBuffer...');
        var arrayBuffer = await new Promise(function(resolve, reject) {
          var reader = new FileReader();
          reader.onload = function(e) {
            console.log('[UPLOAD] ArrayBuffer read complete, size:', e.target.result.byteLength);
            resolve(e.target.result);
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
        console.log('[UPLOAD] Converting to base64...');
        var base64Content = await arrayBufferToBase64(arrayBuffer);
        console.log('[UPLOAD] Base64 conversion complete');
        console.log('[UPLOAD] File read, size:', base64Content.length, 'chars (base64)');

        // √âtape 2: Upload vers Google Drive
        updateStep3Loading(1);
        var mimeType = file.type || (file.name.endsWith('.xlsx')
          ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
          : 'application/vnd.ms-excel');
        console.log('[UPLOAD] Creating JSON Blob...');
        var jsonBlob = new Blob([
          '{"fileName":', JSON.stringify(file.name),
          ',"fileContent":"', base64Content,
          '","mimeType":', JSON.stringify(mimeType), '}'
        ], { type: 'application/json' });
        console.log('[UPLOAD] Blob created, size:', jsonBlob.size, 'bytes');
        console.log('[UPLOAD] Starting fetch to upload-to-drive...');
        var uploadResponse = await fetch(SUPABASE_URL + '/functions/v1/upload-to-drive', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: jsonBlob
        });
        console.log('[UPLOAD] Fetch complete, status:', uploadResponse.status);

        var uploadResult = await uploadResponse.json();
        console.log('[UPLOAD] Upload result:', uploadResult);

        if (!uploadResult.success) throw new Error(uploadResult.error || 'Upload √©chou√©');

        console.log('[UPLOAD] ‚úÖ File uploaded to Drive:', uploadResult.file.id);

        // √âtape 3: Conversion en Google Sheet
        updateStep3Loading(2);

        var convertResponse = await fetch(SUPABASE_URL + '/functions/v1/clever-function', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            fileId: uploadResult.file.id,
            fileName: uploadResult.file.name
          })
        });

        var convertResult = await convertResponse.json();
        console.log('[UPLOAD] Conversion result:', convertResult);

        if (!convertResult.success) throw new Error(convertResult.error || 'Conversion √©chou√©e');

        var sheetToUse = {
          id: convertResult.sheet.id,
          name: convertResult.sheet.name,
          webViewLink: convertResult.sheet.webViewLink
        };
        console.log('[UPLOAD] ‚úÖ Conversion r√©ussie:', sheetToUse.name, sheetToUse.webViewLink);

        // V√©rifier les diff√©rences de conversion
        if (convertResult.verification && !convertResult.verification.success) {
          console.log('[UPLOAD] ‚ö†Ô∏è Diff√©rences d√©tect√©es:', convertResult.verification.differences);
          pendingConvertedSheet = sheetToUse;
          pendingCompareUrls = {
            original: convertResult.sheet.originalWebViewLink,
            converted: convertResult.sheet.webViewLink
          };
          showVerifyWarning(convertResult.verification.differences);
          return;
        }

        // Conversion termin√©e - passer √† la d√©tection (√©tape 4 du loading)
        updateStep3Loading(3);
        await loadAndAnalyzeSheet(sheetToUse, session);

      } catch (error) {
        console.error('[UPLOAD] ‚ùå Error:', error);
        showAnalyseError(error.message);
      }
    }

    function addBotMessage(text) { var container = document.getElementById('chat-messages'); document.getElementById('typing-indicator')?.remove(); var msgDiv = document.createElement('div'); msgDiv.className = 'chat-msg chat-msg-bot'; msgDiv.innerHTML = '<div class="chat-avatar chat-avatar-bot">i</div><div class="chat-bubble chat-bubble-bot">' + text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + '</div>'; container.appendChild(msgDiv); container.scrollTop = container.scrollHeight; chatHistory.push({ role: 'assistant', content: text }); }
    function addUserMessage(text) { var container = document.getElementById('chat-messages'); var msgDiv = document.createElement('div'); msgDiv.className = 'chat-msg chat-msg-user'; msgDiv.innerHTML = '<div class="chat-avatar chat-avatar-user"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><div class="chat-bubble chat-bubble-user">' + text + '</div>'; container.appendChild(msgDiv); container.scrollTop = container.scrollHeight; chatHistory.push({ role: 'user', content: text }); }
    function showTyping() { var container = document.getElementById('chat-messages'); var typingDiv = document.createElement('div'); typingDiv.className = 'chat-msg chat-msg-bot'; typingDiv.id = 'typing-indicator'; typingDiv.innerHTML = '<div class="chat-avatar chat-avatar-bot">i</div><div class="loading-indicator"><div class="loading-bar-wrapper"><div class="loading-bar-fill"></div></div><div style="margin-left: 8px;"><span style="font-size:13px;color:rgba(255,255,255,0.4)">Analyse...</span></div></div>'; container.appendChild(typingDiv); container.scrollTop = container.scrollHeight; }
    
    async function callAPI(mode) { var response = await fetch(SUPABASE_URL + '/functions/v1/clever-processor', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY, 'apikey': SUPABASE_ANON_KEY }, body: JSON.stringify({ excelData: excelData, chatHistory: chatHistory, mode: mode }) }); var result = await response.json(); if (result.error) throw new Error(result.error); return result.response; }
    
    async function startAnalysis() {
      // Reset
      analyseExchangeCount = 0;
      analyseChatHistory = [];
      pendingQuestions = [];

      // Naviguer vers step-analyse (affiche le loading)
      goToStep(3);

      // S'assurer que le loading est visible et l'√©diteur cach√©
      document.getElementById('config-loading').style.display = 'block';
      document.getElementById('config-editor-main').style.display = 'none';

      isWaitingForAI = true;
      try {
        var response = await callAPI('analyze');

        var cleanResponse = response.trim();
        if (cleanResponse.includes('```json')) cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          try {
            var parsedConfig = JSON.parse(jsonMatch[0]);
            console.log('[COMPTA] Config d√©tect√©e dans startAnalysis:', parsedConfig);
            showAnalyseResult(parsedConfig);
          } catch (parseErr) {
            console.error('[COMPTA] JSON parse error:', parseErr);
            showAnalyseError("Erreur d'analyse. Reessaie ?");
          }
        } else {
          showAnalyseError("Je n'ai pas pu analyser le fichier.");
        }
      } catch (err) {
        console.error(err);
        showAnalyseError("Erreur: " + err.message);
      }
      isWaitingForAI = false;
    }

    function showAnalyseError(message) {
      // Cacher le loading, afficher l'erreur et revenir √† step 2
      document.getElementById('config-loading').style.display = 'none';
      alert('Erreur: ' + message);
      goToStep(2);
    }
    
    async function sendMessage() {
      var input = document.getElementById('chat-input'), text = input.value.trim();
      if (!text || isWaitingForAI) return;
      input.value = '';
      addUserMessage(text);
      showTyping();
      isWaitingForAI = true;
      try {
        var response = await callAPI('chat');
        var cleanResponse = response.trim();
        if (cleanResponse.includes('```json')) cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          var parsedConfig = JSON.parse(jsonMatch[0]);
          console.log('[COMPTA] üîç Config d√©tect√©e, affichage preview:', parsedConfig);
          // Show preview instead of saving directly
          showConfigPreview(parsedConfig);
        } else { addBotMessage(response); }
      } catch (err) { console.error(err); addBotMessage("D√©sol√©, j'ai eu un probl√®me. Tu peux r√©p√©ter ?"); }
      isWaitingForAI = false;
    }

    // ========== ANALYSE FUNCTIONS (Step 3 int√©gr√©) ==========
    var pendingConfig = null;
    var analyseChatHistory = [];
    var analyseExchangeCount = 0;
    var pendingQuestions = [];
    var SCORE_HIGH = 90;
    var SCORE_LOW = 70;
    var MAX_EXCHANGES = 3;

    // Note: askNextQuestion() √©tait utilis√© dans l'ancien flux avec questions.
    // Maintenant on affiche directement l'√©diteur de config.

    function showAnalyseResult(config) {
      pendingConfig = config;
      console.log('[ANALYSE] Showing result, opening config editor:', config);

      // Cacher le loading et afficher directement l'√©diteur de config
      document.getElementById('config-loading').style.display = 'none';
      document.getElementById('config-editor-main').style.display = 'block';

      // Initialiser et ouvrir l'√©diteur
      openConfigEditor();
    }

    // ========== CONFIG EDITOR FUNCTIONS ==========
    var configEditorData = [];
    var availableColumns = []; // Colonnes d√©tect√©es dans le sheet
    var depCombineWithEsp = false;

    function openConfigEditor() {
      console.log('[CONFIG EDITOR] Opening with config:', pendingConfig);

      // R√©initialiser le panel de config (ferm√© par d√©faut)
      configPanelOpen = false;
      var panel = document.getElementById('config-panel');
      var btn = document.getElementById('btn-modify-config');
      if (panel) panel.style.display = 'none';
      if (btn) {
        btn.innerHTML = '<span style="font-size: 18px;">‚öôÔ∏è</span> Modifier';
        btn.style.background = 'rgba(255,255,255,0.04)';
        btn.style.borderColor = 'rgba(255,255,255,0.15)';
        btn.style.color = 'rgba(255,255,255,0.8)';
      }

      // R√©cup√©rer les colonnes disponibles du sheet (filtrer les valeurs num√©riques)
      availableColumns = [];
      if (excelData && excelData.sheets && excelData.sheets[0] && excelData.sheets[0].detectedHeaders) {
        availableColumns = excelData.sheets[0].detectedHeaders.columns
          .filter(function(c) {
            // Filtrer les noms qui sont juste des nombres (ex: "1", "2306.7", "10")
            if (!c.name) return false;
            var name = String(c.name).trim();
            if (name === '') return false;
            // Si c'est un nombre pur, on l'exclut
            if (!isNaN(parseFloat(name)) && isFinite(name)) return false;
            // Si c'est une lettre seule (A, B, C...), on l'exclut aussi
            if (/^[A-Z]$/i.test(name)) return false;
            return true;
          })
          .map(function(c) {
            return { letter: c.letter, name: c.name };
          });
      }
      console.log('[CONFIG EDITOR] Available columns (filtered):', availableColumns);

      // Convertir la config actuelle en donn√©es √©ditables
      configEditorData = [];
      if (pendingConfig && pendingConfig.colonnes_a_remplir) {
        pendingConfig.colonnes_a_remplir.forEach(function(col) {
          var rowData = {
            keyword: col.nom,
            column: col.colonne,
            aliases: col.aliases || []
          };
          // Charger noteColumn si d√©fini
          if (col.noteColumn) {
            rowData.noteColumn = col.noteColumn;
          }
          configEditorData.push(rowData);
        });
      }

      // Charger les r√®gles personnalis√©es existantes
      customRules = [];
      if (pendingConfig && pendingConfig.regles_calcul) {
        customRules = pendingConfig.regles_calcul.map(function(r) {
          return { sources: r.sources || [], operation: r.operation || 'add', target: r.target || '' };
        });
      }

      // Mettre √† jour le nom du fichier Excel
      var filenameEl = document.getElementById('excel-filename');
      if (filenameEl && excelData) {
        filenameEl.textContent = excelData.fileName || excelData.sheetName || 'Fichier.xlsx';
      }

      // Mettre √† jour l'onglet Excel
      var sheetTabEl = document.getElementById('excel-sheet-tab');
      if (sheetTabEl && pendingConfig && pendingConfig.onglet) {
        sheetTabEl.textContent = pendingConfig.onglet;
      }

      // Mettre √† jour le lien vers Google Sheet
      var sheetLink = document.getElementById('open-sheet-link');
      if (sheetLink && excelData && excelData.webViewLink) {
        sheetLink.href = excelData.webViewLink;
        sheetLink.style.display = 'flex';
      } else if (sheetLink) {
        sheetLink.style.display = 'none';
      }

      // Mettre √† jour le jour actuel
      var dayCell = document.getElementById('excel-day-cell');
      if (dayCell) {
        dayCell.textContent = new Date().getDate();
      }

      // V√©rifier si DEP et ESP existent pour afficher la r√®gle sp√©ciale
      checkSpecialRules();

      // Afficher l'indicateur de zone si des colonnes formules d√©tect√©es
      var zoneIndicator = document.getElementById('excel-zone-indicator');
      if (zoneIndicator && pendingConfig && pendingConfig.colonnes_protegees && pendingConfig.colonnes_protegees.length > 0) {
        zoneIndicator.style.display = 'block';
        // Calculer la plage de colonnes manuelles
        var manualCols = configEditorData.map(function(c) { return c.column; }).sort();
        var formulaCols = pendingConfig.colonnes_protegees.sort();
        var zoneDesc = document.querySelector('#excel-zone-indicator .zone-desc');
        if (zoneDesc && manualCols.length > 0) {
          zoneDesc.textContent = 'Colonnes ' + manualCols[0] + ' ‚Üí ' + manualCols[manualCols.length - 1] + ' (zone de saisie)';
        }
      } else if (zoneIndicator) {
        zoneIndicator.style.display = 'none';
      }

      // Construire le tableau Excel
      buildExcelPreview();

      // Afficher les lignes √©ditables
      renderConfigEditorRows();
    }

    function buildExcelPreview() {
      var table = document.getElementById('excel-preview-table');
      var today = new Date().getDate();
      var dateCol = pendingConfig ? pendingConfig.colonne_date : null;
      var headerRow = pendingConfig ? (pendingConfig.ligne_entetes || 4) : 4;
      var dataRow = pendingConfig ? (pendingConfig.premiere_ligne_donnees || 8) : 8;
      var todayRow = dataRow + today - 1;

      // R√©cup√©rer les colonnes utilis√©es par les mots-cl√©s
      var usedColumns = {};
      configEditorData.forEach(function(row) {
        if (row.column) {
          usedColumns[row.column] = row.keyword.toUpperCase();
        }
      });

      // Ajouter la colonne date
      if (dateCol) {
        usedColumns[dateCol] = 'JOUR';
      }

      // Trier les colonnes par ordre alphab√©tique
      var sortedCols = Object.keys(usedColumns).sort();

      // G√©n√©rer le HTML du tableau simplifi√©
      var html = '';

      // THEAD: Noms des colonnes EN GROS + lettres en petit
      html += '<thead>';

      // Ligne unique avec NOM en gros + lettre en petit
      html += '<tr style="background: linear-gradient(to bottom, #2d2d2d, #252526);">';
      html += '<th style="padding: 8px 10px; border: 1px solid #404040; background: #2d2d2d; color: #555; width: 40px; font-size: 10px;">Ligne</th>';
      sortedCols.forEach(function(col) {
        var keyword = usedColumns[col]; // CB, ESP, TR, DEP, JOUR
        var isDateCol = col === dateCol;
        var bgColor = isDateCol ? '#2d2d2d' : 'rgba(34, 197, 94, 0.12)';
        var nameColor = isDateCol ? '#888' : '#22C55E';
        var displayName = keyword.length > 6 ? keyword.substring(0, 6) + '..' : keyword;
        html += '<th style="padding: 8px 6px; border: 1px solid #404040; background: ' + bgColor + '; text-align: center; min-width: 65px;">';
        html += '<div style="font-size: 14px; font-weight: 700; color: ' + nameColor + '; margin-bottom: 2px;">' + displayName + '</div>';
        html += '<div style="font-size: 9px; color: #666; font-weight: 400;">col ' + col + '</div>';
        html += '</th>';
      });
      html += '</tr>';

      html += '</thead>';

      // TBODY - Juste 3 lignes : hier, aujourd'hui, demain
      html += '<tbody>';

      // Ligne d'hier (flout√©e)
      var yesterdayDay = today > 1 ? today - 1 : 31;
      html += '<tr style="background: #1a1a1a; filter: blur(1px); opacity: 0.4;">';
      html += '<td style="padding: 5px 8px; border: 1px solid #333; background: #222; color: #444; text-align: center; font-size: 9px;">' + (todayRow - 1) + '</td>';
      sortedCols.forEach(function(col) {
        var isDateCol = col === dateCol;
        if (isDateCol) {
          html += '<td style="padding: 6px; border: 1px solid #333; color: #444; text-align: center; font-size: 11px;">' + yesterdayDay + '</td>';
        } else {
          var fakeVal = Math.floor(Math.random() * 400 + 100);
          html += '<td style="padding: 6px; border: 1px solid #333; color: #444; text-align: center; font-size: 11px;">' + fakeVal + '</td>';
        }
      });
      html += '</tr>';

      // LIGNE AUJOURD'HUI (mise en √©vidence - la star ‚≠ê)
      html += '<tr style="background: rgba(34, 197, 94, 0.15); box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);">';
      html += '<td style="padding: 8px 10px; border: 2px solid #22C55E; background: rgba(34, 197, 94, 0.25); color: #22C55E; text-align: center; font-size: 12px; font-weight: 700;">' + todayRow + '</td>';
      sortedCols.forEach(function(col) {
        var isDateCol = col === dateCol;
        if (isDateCol) {
          html += '<td style="padding: 10px 8px; border: 2px solid #22C55E; color: #22C55E; text-align: center; font-size: 15px; font-weight: 700;">' + today + '</td>';
        } else {
          // Cellule o√π la valeur sera √©crite
          html += '<td id="excel-cell-' + col + '" style="padding: 10px 8px; border: 2px solid #22C55E; background: rgba(34, 197, 94, 0.1); color: #22C55E; text-align: center; font-size: 16px; font-weight: 800;"></td>';
        }
      });
      html += '</tr>';

      // Ligne de demain (flout√©e)
      var tomorrowDay = today < 31 ? today + 1 : 1;
      html += '<tr style="background: #1a1a1a; filter: blur(1px); opacity: 0.3;">';
      html += '<td style="padding: 5px 8px; border: 1px solid #333; background: #222; color: #333; text-align: center; font-size: 9px;">' + (todayRow + 1) + '</td>';
      sortedCols.forEach(function(col) {
        var isDateCol = col === dateCol;
        if (isDateCol) {
          html += '<td style="padding: 6px; border: 1px solid #333; color: #333; text-align: center; font-size: 11px;">' + tomorrowDay + '</td>';
        } else {
          html += '<td style="padding: 6px; border: 1px solid #333; color: #333; text-align: center; font-size: 11px;">-</td>';
        }
      });
      html += '</tr>';

      html += '</tbody>';

      table.innerHTML = html;

      // Mettre √† jour les valeurs d'aujourd'hui
      updatePreview();
    }

    function scrollExcelToZone() {
      var container = document.getElementById('excel-grid-container');
      if (container) {
        container.scrollLeft = container.scrollWidth;
      }
    }

    function closeConfigEditor() {
      // Retourner √† l'√©tape de choix de fichier
      goToStep(2);
      // R√©initialiser le loading pour la prochaine fois
      document.getElementById('config-loading').style.display = 'block';
      document.getElementById('config-editor-main').style.display = 'none';
      // Fermer le panel de config
      var panel = document.getElementById('config-panel');
      if (panel) panel.style.display = 'none';
    }

    var configPanelOpen = false;
    function toggleConfigPanel() {
      var panel = document.getElementById('config-panel');
      var btn = document.getElementById('btn-modify-config');

      if (!configPanelOpen) {
        // Ouvrir le panel avec animation
        panel.style.display = 'block';
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(-10px)';
        setTimeout(function() {
          panel.style.transition = 'all 0.3s ease';
          panel.style.opacity = '1';
          panel.style.transform = 'translateY(0)';
        }, 10);
        btn.innerHTML = '<span style="font-size: 18px;">‚úï</span> Fermer';
        btn.style.background = 'rgba(255,107,53,0.15)';
        btn.style.borderColor = 'rgba(255,107,53,0.3)';
        btn.style.color = '#FF6B35';
        configPanelOpen = true;
        // Scroll vers le panel
        setTimeout(function() {
          panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else {
        // Fermer le panel
        panel.style.transition = 'all 0.2s ease';
        panel.style.opacity = '0';
        panel.style.transform = 'translateY(-10px)';
        setTimeout(function() {
          panel.style.display = 'none';
        }, 200);
        btn.innerHTML = '<span style="font-size: 18px;">‚öôÔ∏è</span> Modifier';
        btn.style.background = 'rgba(255,255,255,0.04)';
        btn.style.borderColor = 'rgba(255,255,255,0.15)';
        btn.style.color = 'rgba(255,255,255,0.8)';
        configPanelOpen = false;
      }
    }

    function renderConfigEditorRows() {
      var container = document.getElementById('config-editor-rows');
      container.innerHTML = '';

      configEditorData.forEach(function(row, index) {
        // Container pour la ligne + note optionnelle
        var rowHtml = '<div class="keyword-row-container" style="display: flex; flex-direction: column; gap: 6px;">';

        // Ligne principale GLASS: [KEYWORD] ‚Üí [Column]
        rowHtml += '<div class="glass-row" style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: rgba(255,255,255,0.04); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.25s ease;" onmouseover="this.style.background=\'rgba(255,255,255,0.06)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.04)\'">';

        // Input mot-cl√© (glass orange)
        rowHtml += '<input type="text" value="' + row.keyword + '" onchange="updateConfigKeyword(' + index + ', this.value); updatePreview();" style="width: 72px; background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(255,107,53,0.1)); border: 1px solid rgba(255,107,53,0.3); border-radius: 8px; padding: 8px 10px; color: #FF8B5E; font-size: 13px; font-weight: 700; text-align: center; text-transform: uppercase; box-shadow: 0 2px 6px rgba(255,107,53,0.15); transition: all 0.2s;" placeholder="...">';

        // Fl√®che
        rowHtml += '<span style="color: rgba(255,255,255,0.35); font-size: 16px;">‚Üí</span>';

        // Select colonne
        rowHtml += '<select onchange="updateConfigColumn(' + index + ', this.value); updatePreview();" style="flex: 1; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 12px; color: rgba(255,255,255,0.8); font-size: 12px; cursor: pointer;">';
        if (availableColumns.length > 0) {
          availableColumns.forEach(function(col) {
            var selected = col.letter === row.column ? 'selected' : '';
            var displayName = col.name + ' (' + col.letter + ')';
            if (col.name.length > 15) displayName = col.name.substring(0, 15) + '... (' + col.letter + ')';
            rowHtml += '<option value="' + col.letter + '" ' + selected + '>' + displayName + '</option>';
          });
        } else {
          for (var i = 0; i < 26; i++) {
            var letter = String.fromCharCode(65 + i);
            var selected = letter === row.column ? 'selected' : '';
            rowHtml += '<option value="' + letter + '" ' + selected + '>Colonne ' + letter + '</option>';
          }
        }
        rowHtml += '</select>';

        // Bouton + note (si pas encore de note)
        if (!row.noteColumn) {
          rowHtml += '<button onclick="addNoteColumn(' + index + ')" style="padding: 4px 8px; background: transparent; border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px; color: rgba(255,255,255,0.3); cursor: pointer; font-size: 10px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.borderColor=\'rgba(139,92,246,0.5)\';this.style.color=\'#a78bfa\'" onmouseout="this.style.borderColor=\'rgba(255,255,255,0.15)\';this.style.color=\'rgba(255,255,255,0.3)\'" title="Ajouter une colonne pour le texte (ex: justificatif)">+ note</button>';
        }

        // Bouton supprimer
        rowHtml += '<button onclick="removeConfigRow(' + index + '); updatePreview();" style="width: 26px; height: 26px; background: rgba(255,255,255,0.03); border: 1px solid transparent; color: rgba(255,255,255,0.25); cursor: pointer; font-size: 14px; transition: all 0.25s ease; border-radius: 6px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.color=\'#f87171\';this.style.background=\'rgba(239,68,68,0.15)\'" onmouseout="this.style.color=\'rgba(255,255,255,0.25)\';this.style.background=\'rgba(255,255,255,0.03)\'">√ó</button>';

        rowHtml += '</div>';

        // Ligne note (si activ√©e)
        if (row.noteColumn) {
          rowHtml += '<div style="display: flex; align-items: center; gap: 8px; margin-left: 20px; padding: 8px 12px; background: rgba(139,92,246,0.08); border-radius: 10px; border: 1px solid rgba(139,92,246,0.2);">';
          rowHtml += '<span style="color: rgba(139,92,246,0.6); font-size: 11px;">‚îî texte ‚Üí</span>';
          rowHtml += '<select onchange="updateNoteColumn(' + index + ', this.value)" style="flex: 1; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.25); border-radius: 6px; padding: 6px 10px; color: #a78bfa; font-size: 11px; cursor: pointer;">';
          if (availableColumns.length > 0) {
            availableColumns.forEach(function(col) {
              var selected = col.letter === row.noteColumn ? 'selected' : '';
              var displayName = col.name + ' (' + col.letter + ')';
              if (col.name.length > 12) displayName = col.name.substring(0, 12) + '... (' + col.letter + ')';
              rowHtml += '<option value="' + col.letter + '" ' + selected + '>' + displayName + '</option>';
            });
          }
          rowHtml += '</select>';
          rowHtml += '<button onclick="removeNoteColumn(' + index + ')" style="width: 20px; height: 20px; background: transparent; border: none; color: rgba(139,92,246,0.4); cursor: pointer; font-size: 12px;" onmouseover="this.style.color=\'#f87171\'" onmouseout="this.style.color=\'rgba(139,92,246,0.4)\'" title="Supprimer la note">√ó</button>';
          rowHtml += '</div>';
        }

        rowHtml += '</div>';
        container.innerHTML += rowHtml;
      });

      updatePreview();
    }

    function addNoteColumn(index) {
      var defaultCol = availableColumns.length > 0 ? availableColumns[0].letter : 'A';
      configEditorData[index].noteColumn = defaultCol;
      renderConfigEditorRows();
    }

    function updateNoteColumn(index, value) {
      configEditorData[index].noteColumn = value;
    }

    function removeNoteColumn(index) {
      delete configEditorData[index].noteColumn;
      renderConfigEditorRows();
    }

    function updatePreview() {
      // G√©n√©rer le message de pr√©visualisation et les valeurs Excel
      var messageLines = [];
      var excelValues = {}; // colonne -> valeur

      configEditorData.forEach(function(row) {
        if (row.keyword.trim()) {
          var keyword = row.keyword.toUpperCase();
          var sampleValue = keyword === 'CB' ? '1000' : keyword === 'ESP' ? '500' : keyword === 'TR' ? '50' : keyword === 'DEP' ? '100' : keyword === 'RAZ' ? '1500' : '200';
          messageLines.push(keyword + ' ' + sampleValue);

          // Stocker la valeur pour la cellule Excel
          if (row.column) {
            excelValues[row.column] = sampleValue;
          }
        }
      });

      // Mettre √† jour le message Telegram
      var msgEl = document.getElementById('preview-message-content');
      if (msgEl) {
        msgEl.textContent = messageLines.join('\n') || 'CB 1000\nESP 500';
      }

      // Mettre √† jour les cellules Excel avec animation
      Object.keys(excelValues).forEach(function(col) {
        var cell = document.getElementById('excel-cell-' + col);
        if (cell) {
          var oldValue = cell.textContent;
          var newValue = excelValues[col];
          cell.textContent = newValue;
          // Animation flash si la valeur change
          if (oldValue !== newValue) {
            cell.style.background = 'rgba(34, 197, 94, 0.3)';
            cell.style.transition = 'background 0.3s';
            setTimeout(function() {
              cell.style.background = 'transparent';
            }, 300);
          }
        }
      });

      // Mettre √† jour le jour dans la colonne date
      var dateCol = pendingConfig ? pendingConfig.colonne_date : null;
      if (dateCol) {
        var dateCell = document.getElementById('excel-cell-' + dateCol);
        if (dateCell) {
          dateCell.textContent = new Date().getDate();
          dateCell.style.color = '#888';
        }
      }

      // V√©rifier les r√®gles sp√©ciales
      checkSpecialRules();
    }

    // ========== R√àGLES PERSONNALIS√âES ==========
    var customRules = []; // Array de { sources: ['DEP', 'ESP'], operation: 'add', target: 'ESP' }

    function renderCustomRules() {
      var container = document.getElementById('custom-rules-container');
      var noRulesMsg = document.getElementById('no-rules-message');

      if (customRules.length === 0) {
        container.innerHTML = '';
        noRulesMsg.style.display = 'block';
        return;
      }

      noRulesMsg.style.display = 'none';

      // Obtenir la liste des mots-cl√©s disponibles
      var keywords = configEditorData.map(function(c) { return c.keyword.toUpperCase(); }).filter(function(k) { return k; });

      var html = '';
      customRules.forEach(function(rule, index) {
        // Ligne GLASS: [A] + [B] ‚Üí [C]
        html += '<div class="glass-row" style="display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(255,255,255,0.04); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.25s ease;" onmouseover="this.style.background=\'rgba(255,255,255,0.06)\';this.style.transform=\'translateY(-1px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.2)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.04)\';this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 2px 8px rgba(0,0,0,0.15)\'">';

        // Sources (les colonnes √† additionner)
        rule.sources.forEach(function(src, srcIdx) {
          if (srcIdx > 0) {
            html += '<span style="color: rgba(255,255,255,0.4); font-size: 14px; font-weight: 500; text-shadow: 0 0 8px rgba(255,255,255,0.1);">+</span>';
          }
          html += '<select onchange="updateRuleSource(' + index + ', ' + srcIdx + ', this.value)" style="width: 65px; background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 7px 8px; color: rgba(255,255,255,0.85); font-size: 12px; font-weight: 600; text-align: center; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.2s;">';
          keywords.forEach(function(kw) {
            var selected = kw === src ? 'selected' : '';
            html += '<option value="' + kw + '" ' + selected + '>' + kw + '</option>';
          });
          html += '</select>';
        });

        // Bouton ajouter source (glass)
        html += '<button onclick="addRuleSource(' + index + ')" style="width: 22px; height: 22px; background: rgba(255,107,53,0.08); border: 1px solid rgba(255,107,53,0.2); border-radius: 6px; color: rgba(255,107,53,0.6); cursor: pointer; font-size: 13px; transition: all 0.25s ease; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background=\'rgba(255,107,53,0.2)\';this.style.color=\'#FF6B35\';this.style.boxShadow=\'0 2px 8px rgba(255,107,53,0.2)\'" onmouseout="this.style.background=\'rgba(255,107,53,0.08)\';this.style.color=\'rgba(255,107,53,0.6)\';this.style.boxShadow=\'none\'" title="Ajouter">+</button>';

        // Fl√®che avec glow
        html += '<span style="color: rgba(255,255,255,0.35); font-size: 16px; margin: 0 4px; text-shadow: 0 0 10px rgba(255,255,255,0.1);">‚Üí</span>';

        // Target (green glass)
        html += '<select onchange="updateRuleTarget(' + index + ', this.value)" style="width: 65px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.08)); border: 1px solid rgba(34,197,94,0.25); border-radius: 8px; padding: 7px 8px; color: #4ade80; font-size: 12px; font-weight: 600; text-align: center; box-shadow: 0 2px 6px rgba(34,197,94,0.1), inset 0 1px 0 rgba(255,255,255,0.05); transition: all 0.2s;">';
        keywords.forEach(function(kw) {
          var selected = kw === rule.target ? 'selected' : '';
          html += '<option value="' + kw + '" ' + selected + '>' + kw + '</option>';
        });
        html += '</select>';

        // Supprimer (glass hover)
        html += '<button onclick="removeCustomRule(' + index + ')" style="margin-left: auto; width: 26px; height: 26px; background: rgba(255,255,255,0.03); border: 1px solid transparent; color: rgba(255,255,255,0.25); cursor: pointer; font-size: 14px; transition: all 0.25s ease; border-radius: 6px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.color=\'#f87171\';this.style.background=\'rgba(239,68,68,0.15)\';this.style.borderColor=\'rgba(239,68,68,0.3)\';this.style.boxShadow=\'0 2px 8px rgba(239,68,68,0.2)\'" onmouseout="this.style.color=\'rgba(255,255,255,0.25)\';this.style.background=\'rgba(255,255,255,0.03)\';this.style.borderColor=\'transparent\';this.style.boxShadow=\'none\'">√ó</button>';

        html += '</div>';
      });

      container.innerHTML = html;
    }

    function addCustomRule() {
      // Obtenir les 2 premiers mots-cl√©s disponibles
      var keywords = configEditorData.map(function(c) { return c.keyword.toUpperCase(); }).filter(function(k) { return k; });
      if (keywords.length < 2) {
        alert('Tu dois avoir au moins 2 mots-cl√©s configur√©s pour cr√©er une r√®gle.');
        return;
      }

      customRules.push({
        sources: [keywords[0], keywords[1]],
        operation: 'add',
        target: keywords[1]
      });

      renderCustomRules();
    }

    function removeCustomRule(index) {
      customRules.splice(index, 1);
      renderCustomRules();
    }

    function updateRuleSource(ruleIndex, sourceIndex, value) {
      customRules[ruleIndex].sources[sourceIndex] = value;
      renderCustomRules();
    }

    function updateRuleTarget(ruleIndex, value) {
      customRules[ruleIndex].target = value;
      renderCustomRules();
    }

    function addRuleSource(ruleIndex) {
      var keywords = configEditorData.map(function(c) { return c.keyword.toUpperCase(); }).filter(function(k) { return k; });
      if (keywords.length > 0) {
        customRules[ruleIndex].sources.push(keywords[0]);
        renderCustomRules();
      }
    }

    function checkSpecialRules() {
      // Rendu des r√®gles personnalis√©es
      renderCustomRules();
    }

    function updateConfigKeyword(index, value) {
      configEditorData[index].keyword = value;
      renderCustomRules(); // Mettre √† jour les r√®gles si les keywords changent
    }

    function updateConfigColumn(index, value) {
      configEditorData[index].column = value;
      // Reconstruire le tableau Excel pour refl√©ter la nouvelle colonne
      buildExcelPreview();
    }

    function removeConfigRow(index) {
      configEditorData.splice(index, 1);
      renderConfigEditorRows();
      renderCustomRules();
      // Reconstruire le tableau Excel
      buildExcelPreview();
    }

    function addConfigRow() {
      var defaultColumn = availableColumns.length > 0 ? availableColumns[0].letter : 'A';
      configEditorData.push({
        keyword: '',
        column: defaultColumn,
        aliases: []
      });
      renderConfigEditorRows();
      // Reconstruire le tableau Excel
      buildExcelPreview();
    }

    function saveConfigEditor() {
      console.log('[CONFIG EDITOR] Saving config:', configEditorData);

      // Reconstruire colonnes_a_remplir
      var newColonnes = [];
      configEditorData.forEach(function(row) {
        if (row.keyword.trim()) {
          // G√©n√©rer des aliases basiques
          var kw = row.keyword.trim();
          var kwLower = kw.toLowerCase();
          var aliases = [kwLower];

          // Aliases standards
          if (kwLower === 'cb') aliases = ['cb', 'carte', 'carte bancaire', 'card', 'tpe'];
          else if (kwLower === 'esp') aliases = ['esp', 'esp√®ces', 'especes', 'cash', 'liquide'];
          else if (kwLower === 'tr') aliases = ['tr', 'ticket resto', 'ticket restaurant', 'titres resto'];
          else if (kwLower === 'raz' || kwLower === 'recette' || kwLower === 'recettes') aliases = ['raz', 'recette', 'recettes', 'ca', 'ttc', 'ticket z', 'ticketz'];
          else if (kwLower === 'dep' || kwLower === 'd√©penses' || kwLower === 'depenses') aliases = ['dep', 'd√©pense', 'd√©penses', 'depense', 'depenses', 'frais'];

          var colConfig = {
            nom: kw.toUpperCase(),
            colonne: row.column,
            aliases: aliases
          };
          // Ajouter noteColumn si d√©fini
          if (row.noteColumn) {
            colConfig.noteColumn = row.noteColumn;
          }
          newColonnes.push(colConfig);
        }
      });

      // Mettre √† jour pendingConfig
      pendingConfig.colonnes_a_remplir = newColonnes;

      // Sauvegarder les r√®gles personnalis√©es
      if (customRules.length > 0) {
        pendingConfig.regles_calcul = customRules.map(function(rule) {
          return {
            sources: rule.sources,
            operation: rule.operation,
            target: rule.target
          };
        });
      } else {
        delete pendingConfig.regles_calcul;
      }

      console.log('[CONFIG EDITOR] Updated config:', pendingConfig);
      console.log('[CONFIG EDITOR] Custom rules:', customRules);

      // Sauvegarder la config et aller √† l'√©tape Telegram
      saveAndContinue();
    }

    async function saveAndContinue() {
      // Sauvegarder la config dans Supabase
      try {
        showToast('Sauvegarde en cours...');

        var session = (await supabaseClient.auth.getSession()).data.session;
        if (!session) {
          showToast('Session expir√©e, reconnecte-toi');
          return;
        }

        var configToSave = {
          user_id: session.user.id,
          sheet_id: excelData.sheetId,
          excel_config: pendingConfig
        };

        var result = await supabaseClient
          .from('user_configs')
          .upsert(configToSave, { onConflict: 'user_id' });

        if (result.error) throw result.error;

        console.log('[CONFIG] Saved successfully');
        showToast('Configuration sauvegard√©e !');

        // Aller √† l'√©tape Telegram
        goToTelegram();

      } catch (err) {
        console.error('[CONFIG] Save error:', err);
        showToast('Erreur de sauvegarde: ' + err.message);
      }
    }

    function addAnalyseBotMessage(text) {
      var html = '<div style="display: flex; gap: 8px; margin-bottom: 10px;">';
      html += '<div style="width: 24px; height: 24px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 10px; flex-shrink: 0;">i</div>';
      var formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html += '<div style="background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px 14px; font-size: 13px; line-height: 1.5; max-width: 90%;">' + formattedText + '</div>';
      html += '</div>';
      var container = document.getElementById('analyse-chat-messages');
      container.innerHTML += html;
      container.scrollTop = container.scrollHeight;
      analyseChatHistory.push({ role: 'assistant', content: text });
    }

    function addAnalyseUserMessage(text) {
      var html = '<div style="display: flex; gap: 8px; margin-bottom: 10px; flex-direction: row-reverse;">';
      html += '<div style="width: 24px; height: 24px; background: rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0;">üë§</div>';
      html += '<div style="background: rgba(255, 107, 53, 0.15); border-radius: 10px; padding: 10px 14px; font-size: 13px; line-height: 1.5; max-width: 90%;">' + text + '</div>';
      html += '</div>';
      var container = document.getElementById('analyse-chat-messages');
      container.innerHTML += html;
      container.scrollTop = container.scrollHeight;
      analyseChatHistory.push({ role: 'user', content: text });
    }

    async function sendAnalyseMessage() {
      var input = document.getElementById('analyse-chat-input');
      var text = input.value.trim();
      if (!text) return;
      input.value = '';

      addAnalyseUserMessage(text);
      analyseExchangeCount++;

      // Ajouter au chatHistory global pour le contexte
      chatHistory.push({ role: 'user', content: text });

      // Afficher typing
      var typingHtml = '<div id="analyse-typing" style="display: flex; gap: 8px; margin-bottom: 10px;">';
      typingHtml += '<div style="width: 24px; height: 24px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 10px; flex-shrink: 0;">i</div>';
      typingHtml += '<div style="background: rgba(255,255,255,0.04); border-radius: 10px; padding: 10px 14px;"><div class="welcome-dots" style="transform: scale(0.6); margin: -8px;"><div class="welcome-dot"></div><div class="welcome-dot"></div><div class="welcome-dot"></div></div></div>';
      typingHtml += '</div>';
      document.getElementById('analyse-chat-messages').innerHTML += typingHtml;

      try {
        var response = await callAPI('chat');
        // Retirer typing
        var typing = document.getElementById('analyse-typing');
        if (typing) typing.remove();

        var cleanResponse = response.trim();
        if (cleanResponse.includes('```json')) cleanResponse = cleanResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

        chatHistory.push({ role: 'assistant', content: response });

        var jsonMatch = cleanResponse.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          var newConfig = JSON.parse(jsonMatch[0]);
          console.log('[ANALYSE] New config:', newConfig);
          showAnalyseResult(newConfig);
          showToast('Configuration mise a jour !');
        } else {
          addAnalyseBotMessage(response);
          if (analyseExchangeCount >= MAX_EXCHANGES) {
            showAnalyseResult(pendingConfig); // Re-afficher avec options "incertain"
          }
        }
      } catch (err) {
        var typing = document.getElementById('analyse-typing');
        if (typing) typing.remove();
        console.error('[ANALYSE] Error:', err);
        addAnalyseBotMessage("Desole, j'ai eu un probleme. Tu peux reformuler ?");
      }
    }

    function switchToFreshStart() {
      analyseExchangeCount = 0;
      analyseChatHistory = [];
      goToStep(2);
      showToast('Tu peux creer un fichier vierge ci-dessus');
    }

    function forceValidateConfig() {
      // Valider m√™me si score bas
      confirmConfig();
    }

    function goToTelegram() {
      console.log('[COMPTA] üöÄ goToTelegram called');
      console.log('[COMPTA] pendingConfig:', pendingConfig);
      console.log('[COMPTA] excelData:', excelData);
      // Sauvegarder la config et aller √† Telegram
      confirmConfig();
    }

    // G√©rer Enter dans le chat analyse
    document.addEventListener('DOMContentLoaded', function() {
      var analyseInput = document.getElementById('analyse-chat-input');
      if (analyseInput) {
        analyseInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') sendAnalyseMessage();
        });
      }
    });

    // ========== LEGACY FUNCTIONS (pour compatibilit√©) ==========
    function showConfigPreview(config) {
      // Rediriger vers le nouveau flow
      showAnalyseResult(config);
    }

    // ========== SIDEBAR NAVIGATION ==========
    function updateSidebarStep(stepNum) {
      for (var i = 1; i <= 4; i++) {
        var stepEl = document.getElementById('step-nav-' + i);
        if (!stepEl) continue;
        stepEl.classList.remove('completed', 'active', 'upcoming');
        stepEl.removeAttribute('onclick');

        if (i < stepNum) {
          stepEl.classList.add('completed');
          stepEl.querySelector('.step-number').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
          // Step 1 (Connexion Google) n'est pas cliquable une fois compl√©t√©
          if (i > 1) {
            stepEl.onclick = function(s) { return function() { goToStep(s); }; }(i);
            stepEl.style.cursor = 'pointer';
          } else {
            stepEl.style.cursor = 'default';
          }
        } else if (i === stepNum) {
          stepEl.classList.add('active');
          stepEl.querySelector('.step-number').textContent = i;
        } else {
          stepEl.classList.add('upcoming');
          stepEl.querySelector('.step-number').textContent = i;
        }
      }
    }

    function goToStep(stepNum) {
      console.log('[NAV] goToStep', stepNum);

      // Fermer tous les overlays
      document.querySelectorAll('.sheets-overlay').forEach(function(el) { el.classList.remove('active'); });

      document.querySelectorAll('.step-content').forEach(function(el) { el.classList.remove('active'); });

      if (stepNum === 1) {
        // √âtape 1 = Connexion Google
        if (hasGoogleSheetsAccess) {
          document.getElementById('step-choice').classList.add('active');
        } else {
          document.getElementById('step-auth').classList.add('active');
        }
        updateSidebarStep(1);
      } else if (stepNum === 2) {
        // √âtape 2 = Choix du fichier
        document.getElementById('step-choice').classList.add('active');
        updateSidebarStep(2);
      } else if (stepNum === 3) {
        // √âtape 3 = Analyse (page int√©gr√©e)
        document.getElementById('step-analyse').classList.add('active');
        updateSidebarStep(3);
      } else if (stepNum === 4) {
        // √âtape 4 = Telegram
        console.log('[NAV] üîµ Activation step-telegram...');

        // FORCE: Fermer TOUS les loaders et overlays
        document.getElementById('global-loader')?.classList.remove('active');
        document.getElementById('welcome-overlay')?.classList.remove('active');
        document.querySelectorAll('.sheets-overlay').forEach(function(el) { el.classList.remove('active'); });
        console.log('[NAV] üßπ All overlays/loaders cleared');

        var telegramStep = document.getElementById('step-telegram');
        if (telegramStep) {
          telegramStep.classList.add('active');
          telegramStep.style.display = 'block'; // Force display
          console.log('[NAV] ‚úÖ step-telegram activated, display:', telegramStep.style.display);
        } else {
          console.error('[NAV] ‚ùå step-telegram element NOT FOUND!');
        }

        // S'assurer que telegram-initial est visible par d√©faut
        var telegramInitial = document.getElementById('telegram-initial');
        if (telegramInitial) {
          console.log('[NAV] telegram-initial current display:', telegramInitial.style.display);
        }

        updateSidebarStep(4);
        checkExistingTelegramConnection();
      }
    }

    async function confirmConfig() {
      console.log('[COMPTA] üìã confirmConfig called');
      console.log('[COMPTA] üìã pendingConfig:', pendingConfig);
      console.log('[COMPTA] üìã excelData:', excelData);
      console.log('[COMPTA] üìã excelData?.sheetId:', excelData?.sheetId);

      if (!pendingConfig) {
        console.log('[COMPTA] ‚ùå pendingConfig is null, returning');
        alert('Erreur: Configuration non trouv√©e. Veuillez r√©analyser le fichier.');
        return;
      }

      // Si on a d√©j√† un sheetId (Google Sheet s√©lectionn√© ou fichier converti), sauvegarder directement
      if (excelData?.sheetId) {
        console.log('[COMPTA] ‚úÖ sheetId existe:', excelData.sheetId, '- sauvegarde directe');
        await saveConfigAndContinue();
        return;
      }

      // Fichier local pas encore upload√©
      var isLocalFile = !excelData?.isGoogleSheet && !excelData?.sheetId;
      console.log('[COMPTA] isLocalFile:', isLocalFile, 'hasGoogleSheetsAccess:', hasGoogleSheetsAccess, 'pendingLocalFile:', pendingLocalFile);

      if (isLocalFile && !hasGoogleSheetsAccess) {
        // Show the "connect Google" modal
        console.log('[COMPTA] üìã Fichier local sans acc√®s Google - affichage modal');
        document.getElementById('connect-google-overlay').classList.add('active');
        return;
      }

      // If local file with Google access, upload and convert first
      if (isLocalFile && hasGoogleSheetsAccess && pendingLocalFile) {
        console.log('[COMPTA] üì§ Upload et conversion du fichier local...');
        await uploadAndConvertLocalFile();
        return;
      }

      // Fallback - sauvegarder directement
      console.log('[COMPTA] ‚úÖ Appel saveConfigAndContinue (fallback)...');
      await saveConfigAndContinue();
    }

    async function saveConfigAndContinue() {
      // Save config
      var configToSave = {
        user_id: currentUser.id,
        excel_config: pendingConfig,
        sheet_id: excelData?.sheetId || null,
        is_active: true
      };
      console.log('[COMPTA] üíæ Sauvegarde user_configs:', configToSave);
      var { error: saveError } = await supabaseClient.from('user_configs').upsert(configToSave, { onConflict: 'user_id' });
      if (saveError) {
        console.error('[COMPTA] ‚ùå Erreur sauvegarde:', saveError);
        alert('Erreur lors de la sauvegarde. R√©essaie ?');
        return;
      }
      console.log('[COMPTA] ‚úÖ Config sauvegard√©e!');
      finalConfig = pendingConfig;

      // Aller directement √† l'√©tape Telegram
      console.log('[COMPTA] üöÄ Navigation vers step 4 (Telegram)...');
      goToStep(4);
      console.log('[COMPTA] ‚úÖ goToStep(4) completed');
    }

    function closeConnectGoogleOverlay() {
      document.getElementById('connect-google-overlay').classList.remove('active');
    }

    async function connectGoogleAndContinue() {
      // Store config and file content before OAuth redirect (using IndexedDB for large files)
      showLoader('Pr√©paration...');

      try {
        var dataToStore = {
          config: pendingConfig,
          fileName: excelData?.fileName,
          excelData: excelData,
          isEmptyTemplateFlow: isEmptyTemplateFlow // Store flow state
        };

        // Store file as ArrayBuffer (no encoding = fast, IndexedDB handles binary natively)
        if (pendingLocalFile) {
          var arrayBuffer = await new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function(e) { resolve(e.target.result); };
            reader.onerror = reject;
            reader.readAsArrayBuffer(pendingLocalFile);
          });
          dataToStore.fileBuffer = arrayBuffer;
          dataToStore.fileName = pendingLocalFile.name;
          dataToStore.fileMimeType = pendingLocalFile.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
          console.log('[COMPTA] üì¶ File stored in IndexedDB, size:', arrayBuffer.byteLength, 'bytes');
        }

        await storeInDB(dataToStore);
        hideLoader();
        closeConnectGoogleOverlay();
        authorizeGoogleSheets();
      } catch (error) {
        console.error('[COMPTA] Error storing file:', error);
        hideLoader();
        alert('Erreur: ' + error.message);
      }
    }

    async function uploadAndConvertLocalFile() {
      if (!pendingLocalFile) {
        console.error('[COMPTA] No pending local file');
        await saveConfigAndContinue();
        return;
      }

      // Initialiser le loader avec les √©tapes
      initLoader(pendingLocalFile.name, [
        'Lecture du fichier',
        'Upload vers Google Drive',
        'Conversion en Google Sheet',
        'Sauvegarde'
      ]);

      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) throw new Error('Session expir√©e');

        // √âtape 1: Read file and convert to base64
        var arrayBuffer = await new Promise(function(resolve, reject) {
          var reader = new FileReader();
          reader.onload = function(e) { resolve(e.target.result); };
          reader.onerror = reject;
          reader.readAsArrayBuffer(pendingLocalFile);
        });
        var base64Content = await arrayBufferToBase64(arrayBuffer);

        // √âtape 2: Upload to Google Drive
        updateLoaderStep(1);
        var mimeType = pendingLocalFile.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        var jsonBlob = new Blob([
          '{"fileName":', JSON.stringify(pendingLocalFile.name),
          ',"fileContent":"', base64Content,
          '","mimeType":', JSON.stringify(mimeType), '}'
        ], { type: 'application/json' });
        var uploadResponse = await fetch(SUPABASE_URL + '/functions/v1/upload-to-drive', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: jsonBlob
        });

        var uploadResult = await uploadResponse.json();
        if (!uploadResult.success) throw new Error(uploadResult.error || 'Upload echoue');

        console.log('[COMPTA] File uploaded:', uploadResult.file.id);

        // √âtape 3: Convert to Google Sheet
        updateLoaderStep(2);

        var convertResponse = await fetch(SUPABASE_URL + '/functions/v1/clever-function', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            fileId: uploadResult.file.id,
            fileName: uploadResult.file.name
          })
        });

        var convertResult = await convertResponse.json();
        if (!convertResult.success) throw new Error(convertResult.error || 'Conversion √©chou√©e');

        console.log('[COMPTA] ‚úÖ Conversion r√©ussie:', convertResult.sheet.name);

        // √âtape 4: Sauvegarde
        updateLoaderStep(3);

        // Update excelData with the Google Sheet info
        excelData.sheetId = convertResult.sheet.id;
        excelData.sheetName = convertResult.sheet.name;
        excelData.isGoogleSheet = true;

        // Update google_credentials with the sheet
        await supabaseClient.from('google_credentials').update({
          sheet_id: convertResult.sheet.id,
          sheet_name: convertResult.sheet.name
        }).eq('user_id', currentUser.id);

        hideLoader();

        // Clear pending file
        pendingLocalFile = null;

        // Now save the config
        await saveConfigAndContinue();

      } catch (error) {
        console.error('[COMPTA] ‚ùå Error:', error);
        hideLoader();
        alert('Erreur: ' + error.message);
      }
    }

    async function uploadStoredFile(base64Content, fileName, mimeType) {
      // Initialiser le loader avec les √©tapes
      initLoader(fileName, [
        'Upload vers Google Drive',
        'Conversion en Google Sheet',
        'Sauvegarde'
      ]);

      try {
        var { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) throw new Error('Session expir√©e');

        // √âtape 1: Upload to Google Drive
        var finalMimeType = mimeType || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
        var jsonBlob = new Blob([
          '{"fileName":', JSON.stringify(fileName),
          ',"fileContent":"', base64Content,
          '","mimeType":', JSON.stringify(finalMimeType), '}'
        ], { type: 'application/json' });
        var uploadResponse = await fetch(SUPABASE_URL + '/functions/v1/upload-to-drive', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: jsonBlob
        });

        var uploadResult = await uploadResponse.json();
        if (!uploadResult.success) throw new Error(uploadResult.error || 'Upload echoue');

        console.log('[COMPTA] File uploaded:', uploadResult.file.id);

        // √âtape 2: Convert to Google Sheet
        updateLoaderStep(1);

        var convertResponse = await fetch(SUPABASE_URL + '/functions/v1/clever-function', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + session.access_token,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({
            fileId: uploadResult.file.id,
            fileName: uploadResult.file.name
          })
        });

        var convertResult = await convertResponse.json();
        if (!convertResult.success) throw new Error(convertResult.error || 'Conversion √©chou√©e');

        console.log('[COMPTA] ‚úÖ Conversion r√©ussie:', convertResult.sheet.name);

        // √âtape 3: Sauvegarde
        updateLoaderStep(2);

        // Update excelData with the Google Sheet info
        excelData.sheetId = convertResult.sheet.id;
        excelData.sheetName = convertResult.sheet.name;
        excelData.isGoogleSheet = true;

        // Update google_credentials with the sheet
        await supabaseClient.from('google_credentials').update({
          sheet_id: convertResult.sheet.id,
          sheet_name: convertResult.sheet.name
        }).eq('user_id', currentUser.id);

        hideLoader();

        // Now save the config
        await saveConfigAndContinue();

      } catch (error) {
        console.error('[COMPTA] ‚ùå Error:', error);
        hideLoader();
        alert('Erreur: ' + error.message);
      }
    }
    // ========== END CONFIG PREVIEW ==========

    // ========== EMPTY TEMPLATE FLOW ==========
    var isEmptyTemplateFlow = false;

    // Fonctions pour les colonnes interactives du template
    var draggedCol = null;
    var dragGhost = null;
    var dropIndicator = null;
    var dropTargetIndex = -1;

    function dragColStart(e) {
      draggedCol = e.target.closest('.template-col');
      if (!draggedCol) return;

      var colName = draggedCol.querySelector('.col-name').textContent;

      // Cr√©er le ghost (√©l√©ment flottant)
      dragGhost = document.createElement('div');
      dragGhost.className = 'drag-ghost';
      dragGhost.textContent = colName;
      document.body.appendChild(dragGhost);

      // Cr√©er l'indicateur de drop
      dropIndicator = document.createElement('div');
      dropIndicator.className = 'drop-indicator';

      // Cacher l'image de drag par d√©faut
      var emptyImg = new Image();
      emptyImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
      e.dataTransfer.setDragImage(emptyImg, 0, 0);
      e.dataTransfer.effectAllowed = 'move';

      // Activer le mode drag sur le container
      document.getElementById('template-columns').classList.add('drag-active');

      // Ajouter classe dragging apr√®s un d√©lai
      setTimeout(function() {
        if (draggedCol) draggedCol.classList.add('dragging');
      }, 0);

      // Positionner le ghost
      updateGhostPosition(e.clientX, e.clientY);
    }

    function updateGhostPosition(x, y) {
      if (dragGhost) {
        dragGhost.style.left = (x + 12) + 'px';
        dragGhost.style.top = (y - 14) + 'px';
      }
    }

    function dragColOver(e) {
      e.preventDefault();
      updateGhostPosition(e.clientX, e.clientY);

      if (!draggedCol) return;

      var container = document.getElementById('template-columns');
      var cols = Array.from(container.querySelectorAll('.template-col:not(.dragging)'));
      var addBtn = document.getElementById('add-col-btn');
      var addInput = document.getElementById('add-col-input');

      // Trouver la colonne la plus proche (en tenant compte de X et Y pour multi-lignes)
      var closestCol = null;
      var closestDist = Infinity;
      var insertAfter = false;

      for (var i = 0; i < cols.length; i++) {
        var rect = cols[i].getBoundingClientRect();
        var colCenterX = rect.left + rect.width / 2;
        var colCenterY = rect.top + rect.height / 2;

        // Distance au centre de la colonne
        var dist = Math.sqrt(Math.pow(e.clientX - colCenterX, 2) + Math.pow(e.clientY - colCenterY, 2));

        if (dist < closestDist) {
          closestDist = dist;
          closestCol = cols[i];
          // Ins√©rer avant ou apr√®s selon si on est √† gauche ou droite du centre
          insertAfter = e.clientX > colCenterX;
        }
      }

      // D√©terminer l'√©l√©ment avant lequel ins√©rer
      var insertBefore = null;
      var newIndex = -1;

      if (closestCol) {
        if (insertAfter) {
          // Ins√©rer apr√®s closestCol = avant le suivant
          var nextSibling = closestCol.nextElementSibling;
          while (nextSibling && (nextSibling.classList.contains('dragging') || nextSibling === dropIndicator)) {
            nextSibling = nextSibling.nextElementSibling;
          }
          if (nextSibling && nextSibling.classList.contains('template-col')) {
            insertBefore = nextSibling;
            newIndex = cols.indexOf(nextSibling);
          } else {
            // Ins√©rer √† la fin (avant le input ou le bouton +)
            insertBefore = addInput.classList.contains('hidden') ? addBtn : addInput;
            newIndex = cols.length;
          }
        } else {
          // Ins√©rer avant closestCol
          insertBefore = closestCol;
          newIndex = cols.indexOf(closestCol);
        }
      } else {
        // Pas de colonnes, ins√©rer au d√©but
        insertBefore = addInput.classList.contains('hidden') ? addBtn : addInput;
        newIndex = 0;
      }

      // Si l'index a chang√©, d√©placer l'indicateur
      if (newIndex !== dropTargetIndex) {
        dropTargetIndex = newIndex;

        // Retirer l'indicateur s'il existe
        if (dropIndicator.parentNode) {
          dropIndicator.remove();
        }

        // Ins√©rer l'indicateur
        if (insertBefore) {
          container.insertBefore(dropIndicator, insertBefore);
        }
      }
    }

    function dragColEnd(e) {
      var container = document.getElementById('template-columns');
      container.classList.remove('drag-active');

      // Supprimer le ghost
      if (dragGhost) {
        dragGhost.remove();
        dragGhost = null;
      }

      // D√©placer la colonne √† la position de l'indicateur
      if (draggedCol && dropIndicator && dropIndicator.parentNode) {
        container.insertBefore(draggedCol, dropIndicator);
        draggedCol.classList.remove('dragging');
        draggedCol.classList.add('just-dropped');
        var dropped = draggedCol;
        setTimeout(function() {
          dropped.classList.remove('just-dropped');
        }, 350);
      } else if (draggedCol) {
        draggedCol.classList.remove('dragging');
      }

      // Supprimer l'indicateur
      if (dropIndicator && dropIndicator.parentNode) {
        dropIndicator.remove();
      }

      draggedCol = null;
      dropTargetIndex = -1;
    }

    // Suivre la souris m√™me hors du container
    document.addEventListener('dragover', function(e) {
      if (dragGhost) {
        updateGhostPosition(e.clientX, e.clientY);
      }
    });

    function removeTemplateCol(btn) {
      var col = btn.closest('.template-col');
      if (col) {
        col.style.transform = 'scale(0.8)';
        col.style.opacity = '0';
        setTimeout(function() { col.remove(); }, 150);
      }
    }

    function showAddColInput() {
      document.getElementById('add-col-btn').classList.add('hidden');
      document.getElementById('add-col-input').classList.remove('hidden');
      var input = document.getElementById('new-col-name');
      input.value = '';
      input.focus();
    }

    function cancelAddCol() {
      setTimeout(function() {
        document.getElementById('add-col-input').classList.add('hidden');
        document.getElementById('add-col-btn').classList.remove('hidden');
      }, 100);
    }

    function handleNewColKey(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        var name = e.target.value.trim();
        if (name) {
          addTemplateColWithName(name);
        }
        cancelAddCol();
      } else if (e.key === 'Escape') {
        cancelAddCol();
      }
    }

    function addTemplateColWithName(name) {
      var container = document.getElementById('template-columns');
      var addBtn = document.getElementById('add-col-btn');
      var inputDiv = document.getElementById('add-col-input');

      var newCol = document.createElement('span');
      newCol.className = 'template-col just-added group px-3 py-1.5 rounded-lg text-xs bg-white/5 border border-white/10 flex items-center gap-2 hover:border-white/20 cursor-grab active:cursor-grabbing';
      newCol.draggable = true;
      newCol.ondragstart = dragColStart;
      newCol.ondragover = dragColOver;
      newCol.ondragend = dragColEnd;
      newCol.innerHTML = '<svg class="drag-handle opacity-30 group-hover:opacity-60 flex-shrink-0" width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="12" cy="19" r="2"/></svg><span class="col-name" ondblclick="editColName(this)">' + name + '</span><button class="opacity-0 group-hover:opacity-100 transition-opacity text-white/40 hover:text-red-400" onclick="event.stopPropagation(); removeTemplateCol(this)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>';

      // Ins√©rer avant le bouton + (ou l'input s'il est visible)
      var insertBeforeEl = inputDiv.classList.contains('hidden') ? addBtn : inputDiv;
      container.insertBefore(newCol, insertBeforeEl);

      // Remove animation class after it completes
      setTimeout(function() {
        newCol.classList.remove('just-added');
      }, 300);
    }

    function editColName(span) {
      var currentName = span.textContent;
      var col = span.closest('.template-col');

      // Add editing state to parent
      col.classList.add('editing');
      col.draggable = false; // Disable drag while editing

      var input = document.createElement('input');
      input.type = 'text';
      input.value = currentName;
      input.className = 'col-edit-input';
      input.maxLength = 20;
      input.style.cssText = 'background: transparent; border: none; outline: none; color: white; font-size: 12px; width: ' + Math.max(currentName.length * 8, 40) + 'px; min-width: 40px; max-width: 120px; padding: 0; margin: 0; font-family: inherit;';

      // Auto-resize input as user types
      input.oninput = function() {
        input.style.width = Math.max(input.value.length * 8, 40) + 'px';
      };

      input.onblur = function() {
        var newName = input.value.trim() || currentName;
        span.textContent = newName;
        span.style.display = '';
        input.remove();
        col.classList.remove('editing');
        col.draggable = true;
      };

      input.onkeydown = function(e) {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          input.value = currentName;
          input.blur();
        }
      };

      span.style.display = 'none';
      span.parentNode.insertBefore(input, span);
      input.focus();
      input.select();
    }

    function getTemplateColumns() {
      var cols = [];
      document.querySelectorAll('#template-columns .template-col .col-name').forEach(function(span) {
        var text = span.textContent.trim();
        if (text) cols.push(text);
      });
      return cols;
    }

    async function createEmptyTemplate() {
      var { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) throw new Error('Session expir√©e');

      var columns = getTemplateColumns();
      if (columns.length === 0) {
        alert('Ajoute au moins une colonne !');
        return;
      }

      showLoader('Creation du modele vierge...');

      console.log('[COMPTA] Creating template with columns:', columns);

      // Create a new Google Sheet with custom columns
      var response = await fetch(SUPABASE_URL + '/functions/v1/create-template-sheet', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + session.access_token,
          'apikey': SUPABASE_ANON_KEY
        },
        body: JSON.stringify({
          templateType: 'compta',
          year: new Date().getFullYear(),
          customColumns: columns  // Pass user's custom columns
        })
      });

      var result = await response.json();
      if (!result.success) throw new Error(result.error || 'Echec de la creation');

      console.log('[COMPTA] Template created:', result.sheet);

      // Build config dynamically based on user's columns
      var colLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      var colonnesARemplir = [];
      columns.forEach(function(colName, index) {
        var lowerName = colName.toLowerCase();
        // Skip date column (handled separately) and notes (not fillable via bot)
        if (lowerName !== 'date' && lowerName !== 'notes') {
          colonnesARemplir.push({
            nom: colName,
            colonne: colLetters[index],
            aliases: [lowerName, lowerName.replace(/\s+/g, '')]
          });
        }
      });

      var defaultConfig = {
        onglet: 'Recettes ' + new Date().getFullYear(),
        ligne_entetes: 1,
        premiere_ligne_donnees: 2,
        colonne_date: 'A',
        format_date: 'DD/MM/YYYY',
        colonnes_a_remplir: colonnesARemplir
      };

      // Save to database
      var { error: saveError } = await supabaseClient.from('compta_configs').upsert({
        user_id: currentUser.id,
        sheet_id: result.sheet.id,
        sheet_name: result.sheet.name,
        config: defaultConfig,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }, { onConflict: 'user_id' });

      if (saveError) throw saveError;

      hideLoader();
      showToast('Modele cree avec succes !');
      goToStep(4);
    }
    // ========== END EMPTY TEMPLATE FLOW ==========

    async function connectTelegram() {
      var btn = document.getElementById('connect-telegram-btn');
      btn.disabled = true; btn.textContent = 'G√©n√©ration du lien...';
      try {
        var token = crypto.randomUUID(), expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
        var { error } = await supabaseClient.from('connection_tokens').insert({ user_id: currentUser.id, token: token, expires_at: expiresAt.toISOString(), used: false });
        if (error) throw error;
        var telegramLink = 'https://t.me/IArmyBOT?start=' + token;
        document.getElementById('telegram-initial').style.display = 'none';
        document.getElementById('telegram-connecting').style.display = 'block';
        document.getElementById('telegram-link-fallback').href = telegramLink;
        window.open(telegramLink, '_blank');
        startConnectionCheck();
      } catch (err) { alert('Erreur : ' + err.message); btn.disabled = false; btn.textContent = 'Connecter Telegram'; }
    }
    
    function startConnectionCheck() { connectionCheckInterval = setInterval(async function() { try { var { data } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', currentUser.id).maybeSingle(); if (data?.telegram_user_id) { clearInterval(connectionCheckInterval); showTelegramConnected(); } } catch (err) {} }, 3000); }
    function showTelegramConnected() {
      console.log('[TELEGRAM] showTelegramConnected() called');
      var connectingEl = document.getElementById('telegram-connecting');
      var connectedEl = document.getElementById('telegram-connected');
      console.log('[TELEGRAM] telegram-connected element found:', !!connectedEl);
      if (connectingEl) connectingEl.style.display = 'none';
      if (connectedEl) {
        connectedEl.style.display = 'block';
        console.log('[TELEGRAM] ‚úÖ telegram-connected display set to block');
        console.log('[TELEGRAM] Content inside:', connectedEl.innerHTML.substring(0, 100));
      } else {
        console.error('[TELEGRAM] ‚ùå telegram-connected NOT FOUND!');
      }
    }
    async function checkExistingTelegramConnection() {
      console.log('[TELEGRAM] checkExistingTelegramConnection called, currentUser:', currentUser?.id);
      if (!currentUser) {
        console.log('[TELEGRAM] No currentUser, returning');
        return;
      }
      try {
        var { data, error } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', currentUser.id).maybeSingle();
        console.log('[TELEGRAM] Query result - data:', data, 'error:', error);
        if (data?.telegram_user_id) {
          console.log('[TELEGRAM] User already connected! Redirecting to compte.html...');
          // User d√©j√† connect√© ‚Üí redirection directe vers son espace
          showToast('Telegram d√©j√† connect√© ! Redirection...');
          setTimeout(function() {
            window.location.href = 'compte.html';
          }, 1500);
          return;
        } else {
          console.log('[TELEGRAM] No existing connection, telegram-initial should be visible');
        }
      } catch (err) {
        console.error('[TELEGRAM] Error checking connection:', err);
      }
    }

    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[COMPTA] üì± Page charg√©e');
      var urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('code') && urlParams.get('state') === 'sheets_auth') { console.log('[COMPTA] üîÑ Callback OAuth Sheets'); await handleSheetsCallback(); }
      await initComptaPage();
    });
  </script>
</body>
</html>
