<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iArmy - Configuration</title>
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FF6B35'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>i</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { font-family: 'Inter', sans-serif; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(255,107,53,0.3); } 50% { box-shadow: 0 0 15px rgba(255,107,53,0.5); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    .animate-scaleIn { animation: scaleIn 0.3s ease-out forwards; }
    .animate-glow { animation: glow 2s ease-in-out infinite; }
    .animate-pulse { animation: pulse 1s ease-in-out infinite; }
    
    .choice-card { transition: all 0.2s ease; }
    .choice-card:hover { transform: translateY(-2px); border-color: rgba(255,107,53,0.4); }
    
    .excel-viewport { overflow: hidden; position: relative; }
    .excel-content { transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: top left; }
    
    .cell-highlight { background: rgba(255,107,53,0.25) !important; box-shadow: inset 0 0 0 2px #FF6B35 !important; }
    
    .status-line { transition: opacity 0.3s ease; }
  </style>
</head>
<body class="min-h-screen bg-[#0a0a0a] text-white overflow-hidden">
  
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute top-0 left-1/4 w-[400px] h-[400px] bg-[#FF6B35]/8 rounded-full blur-[120px]"></div>
    <div class="absolute bottom-0 right-1/4 w-[300px] h-[300px] bg-[#FF6B35]/5 rounded-full blur-[100px]"></div>
  </div>

  <header class="fixed top-0 left-0 right-0 z-50 px-4 py-2.5 flex items-center justify-between border-b border-white/5 bg-[#0a0a0a]/95 backdrop-blur-xl">
    <a href="index.html" class="flex items-center gap-2">
      <div class="w-8 h-8 bg-gradient-to-br from-[#FF6B35] to-[#ff8f6a] rounded-lg flex items-center justify-center font-black text-sm shadow-lg shadow-[#FF6B35]/20">i</div>
      <span class="font-bold">iArmy</span>
    </a>
    <div id="stepIndicator" class="text-white/30 text-[11px]"></div>
    <div class="w-14"></div>
  </header>

  <main class="pt-[44px] h-screen">
    
    <!-- INTRO -->
    <section id="s-intro" class="h-full flex items-center justify-center p-6">
      <div class="text-center animate-scaleIn">
        <div class="w-16 h-16 bg-gradient-to-br from-[#FF6B35] to-[#ff8f6a] rounded-xl flex items-center justify-center font-black text-2xl shadow-xl shadow-[#FF6B35]/25 mx-auto mb-5">i</div>
        <h1 class="text-2xl font-bold mb-1">C'est parti üöÄ</h1>
        <p class="text-white/40 text-sm">2 minutes</p>
      </div>
    </section>
    
    <!-- CHOICE -->
    <section id="s-choice" class="hidden h-full flex items-center justify-center p-6">
      <div class="max-w-md w-full">
        <div class="text-center mb-6 animate-fadeIn">
          <h2 class="text-lg font-bold mb-1">O√π est ta compta ?</h2>
          <p class="text-white/40 text-xs">On s'adapte</p>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <button onclick="pickSource('file')" class="choice-card bg-white/[0.03] border border-white/10 rounded-lg p-4 text-left animate-fadeIn" style="animation-delay:50ms;opacity:0">
            <div class="w-9 h-9 bg-[#217346]/20 rounded-lg flex items-center justify-center mb-2">
              <svg class="w-4 h-4 text-[#217346]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <h3 class="font-medium text-sm">Fichier Excel</h3>
            <p class="text-white/40 text-[11px]">Sur ton ordi</p>
          </button>
          
          <button onclick="pickSource('google')" class="choice-card bg-white/[0.03] border border-white/10 rounded-lg p-4 text-left animate-fadeIn" style="animation-delay:80ms;opacity:0">
            <div class="w-9 h-9 bg-blue-500/20 rounded-lg flex items-center justify-center mb-2">
              <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="currentColor"><path d="M19.527 5.286l-4.813-4.813A1.636 1.636 0 0013.559 0H5.818C4.815 0 4 .815 4 1.818v20.364C4 23.185 4.815 24 5.818 24h12.364c1.003 0 1.818-.815 1.818-1.818V6.441c0-.433-.172-.849-.473-1.155zM14 2l4 4h-4V2zM6 22V2h6v5a1 1 0 001 1h5v14H6z"/></svg>
            </div>
            <h3 class="font-medium text-sm">Google Sheets</h3>
            <p class="text-white/40 text-[11px]">En ligne</p>
          </button>
        </div>
      </div>
    </section>
    
    <!-- UPLOAD -->
    <section id="s-upload" class="hidden h-full flex items-center justify-center p-6">
      <div class="max-w-sm w-full">
        <div class="text-center mb-5 animate-fadeIn">
          <h2 class="text-lg font-bold mb-1">Envoie ton fichier</h2>
          <p class="text-white/40 text-xs">Je vais le lire</p>
        </div>
        
        <div id="dropzone" class="border-2 border-dashed border-white/20 rounded-lg p-10 text-center cursor-pointer hover:border-[#FF6B35]/40 hover:bg-[#FF6B35]/5 transition-all bg-white/[0.02] animate-fadeIn" style="animation-delay:50ms;opacity:0">
          <input type="file" id="fileIn" accept=".xlsx,.xls,.csv" class="hidden">
          <div class="w-12 h-12 bg-white/5 rounded-lg flex items-center justify-center mx-auto mb-3">
            <svg class="w-6 h-6 text-white/30" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
          </div>
          <p class="text-white/50 text-sm">Glisse ou <span class="text-[#FF6B35]">parcourir</span></p>
        </div>
        
        <p class="text-center text-white/20 text-[9px] mt-3">üîí Fichier priv√©</p>
        <button onclick="go('s-choice')" class="mt-3 text-white/30 hover:text-white/50 text-[11px] mx-auto block">‚Üê Retour</button>
      </div>
    </section>
    
    <!-- GOOGLE -->
    <section id="s-google" class="hidden h-full flex items-center justify-center p-6">
      <div class="max-w-xs w-full text-center animate-fadeIn">
        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        </div>
        <h2 class="text-lg font-bold mb-1">Google Sheets</h2>
        <p class="text-white/40 text-xs mb-5">Connecte ton compte</p>
        
        <button onclick="alert('Connexion Google - √Ä impl√©menter')" class="w-full py-2.5 bg-white hover:bg-white/90 text-gray-800 font-medium rounded-lg text-sm flex items-center justify-center gap-2">
          <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continuer avec Google
        </button>
        
        <button onclick="go('s-choice')" class="mt-3 text-white/30 hover:text-white/50 text-[11px]">‚Üê Retour</button>
      </div>
    </section>
    
    <!-- ANALYSIS -->
    <section id="s-analysis" class="hidden h-full pt-[60px]">
      <div class="h-full grid lg:grid-cols-5 gap-0">
        
        <!-- Excel Panel -->
        <div class="lg:col-span-3 h-full flex flex-col border-r border-white/5">
          <div class="px-3 py-1.5 border-b border-white/5 flex items-center gap-2">
            <div class="w-4 h-4 bg-[#217346] rounded flex items-center justify-center"><span class="text-white font-bold text-[7px]">X</span></div>
            <span id="fileName" class="text-white/50 text-[11px]">fichier.xlsx</span>
          </div>
          
          <div class="flex-1 excel-viewport bg-[#0d0d0d] relative">
            <div id="excelContent" class="excel-content p-3">
              <table id="excelTable" class="border-collapse"></table>
            </div>
          </div>
        </div>
        
        <!-- Chat Panel - Compact -->
        <div class="lg:col-span-2 h-full flex flex-col bg-[#0a0a0a]">
          <div class="bg-gradient-to-r from-[#FF6B35]/10 to-transparent px-3 py-2 border-b border-white/5 flex items-center gap-2">
            <div class="w-6 h-6 bg-gradient-to-br from-[#FF6B35] to-[#ff8f6a] rounded flex items-center justify-center">
              <span class="text-white font-bold text-[9px]">i</span>
            </div>
            <span class="text-white/70 text-xs font-medium">iArmy</span>
          </div>
          
          <!-- Status Area - Compact, no scroll -->
          <div class="flex-1 p-4 flex flex-col justify-center">
            <div id="statusArea" class="text-center">
              <p id="statusLine1" class="text-white/60 text-sm mb-1">Lecture du fichier...</p>
              <p id="statusLine2" class="text-[#FF6B35] text-sm font-medium h-5"></p>
              <p id="statusLine3" class="text-white/40 text-xs mt-2 h-4"></p>
            </div>
            
            <!-- Ticket de caisse - hidden initially -->
            <div id="ticketArea" class="hidden mt-4 bg-white/[0.02] border border-white/10 rounded-lg p-4 max-w-xs mx-auto">
              <p class="text-white/40 text-[10px] mb-2 text-center">üìã Colonnes d√©tect√©es</p>
              <div id="ticketContent" class="font-mono text-xs space-y-1"></div>
            </div>
          </div>
          
          <!-- Bottom action -->
          <div class="p-3 border-t border-white/5">
            <div id="actionArea" class="hidden">
              <button id="confirmBtn" onclick="confirmAnalysis()" class="w-full py-2.5 bg-[#FF6B35] hover:bg-[#ff7a4a] rounded-lg text-white text-sm font-medium animate-glow">
                C'est bon üëç
              </button>
            </div>
          </div>
        </div>
        
      </div>
    </section>
    
    <!-- RECAP -->
    <section id="s-recap" class="hidden h-full flex items-center justify-center p-6 overflow-y-auto">
      <div class="max-w-lg w-full py-6">
        
        <div class="text-center mb-6 animate-fadeIn">
          <h2 class="text-lg font-bold mb-1">Ton process, automatis√©</h2>
          <p class="text-white/40 text-xs">Exactement pareil, mais c'est moi qui bosse</p>
        </div>
        
        <div class="bg-white/[0.02] border border-white/10 rounded-lg p-5 animate-fadeIn" style="animation-delay:80ms;opacity:0">
          
          <p class="text-white/50 text-[10px] mb-2">Chaque soir, tu m'√©cris :</p>
          <div class="bg-[#0088cc]/10 border border-[#0088cc]/20 rounded px-3 py-2 mb-5 inline-block">
            <p id="recapMsg" class="text-white text-sm font-mono">"<span class="text-[#FF6B35]">500</span> esp, <span class="text-[#FF6B35]">100</span> cb"</p>
          </div>
          
          <div class="flex justify-center mb-5">
            <svg class="w-5 h-5 text-white/20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
          </div>
          
          <p class="text-white/50 text-[10px] mb-2">Je remplis ta ligne :</p>
          <div class="overflow-x-auto">
            <table id="recapTable" class="w-full border-collapse text-xs"></table>
          </div>
          
        </div>
        
        <div class="text-center mt-6 animate-fadeIn" style="animation-delay:150ms;opacity:0">
          <button onclick="goAccount()" class="px-6 py-2.5 bg-[#FF6B35] hover:bg-[#ff7a4a] rounded-lg text-white text-sm font-medium animate-glow">
            C'est parfait üëç
          </button>
        </div>
        
      </div>
    </section>
    
    <!-- ACCOUNT -->
    <section id="s-account" class="hidden h-full flex items-center justify-center p-6">
      <div class="max-w-xs w-full">
        
        <div class="text-center mb-4 animate-fadeIn">
          <div class="inline-flex items-center gap-1.5 text-green-400/70 text-[10px] mb-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            Bot configur√©
          </div>
          <h2 class="text-lg font-bold mb-0.5">Cr√©e ton compte</h2>
          <p class="text-white/40 text-[11px]">Derni√®re √©tape</p>
        </div>
        
        <div id="accForm" class="bg-white/[0.03] border border-white/10 rounded-lg p-4 animate-fadeIn" style="animation-delay:50ms;opacity:0">
          <div class="space-y-2.5">
            <div>
              <label class="block text-white/40 text-[9px] mb-1">Email</label>
              <input type="email" id="accEmail" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded text-white text-sm placeholder-white/30 focus:outline-none focus:border-[#FF6B35]/50" placeholder="ton@email.com">
            </div>
            <div>
              <label class="block text-white/40 text-[9px] mb-1">Mot de passe</label>
              <input type="password" id="accPwd" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded text-white text-sm placeholder-white/30 focus:outline-none focus:border-[#FF6B35]/50" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
          </div>
          <button onclick="createAcc()" class="w-full mt-3 py-2 bg-[#FF6B35] hover:bg-[#ff7a4a] rounded text-white text-sm font-medium">Cr√©er</button>
        </div>
      </div>
    </section>
    
    <!-- PAYMENT -->
    <section id="s-payment" class="hidden h-full flex items-center justify-center p-6">
      <div class="max-w-xs w-full">
        
        <div class="text-center mb-3 animate-fadeIn">
          <h2 class="text-lg font-bold mb-0.5">Paiement</h2>
          <p class="text-white/40 text-[11px]">7 jours gratuits</p>
        </div>
        
        <div class="bg-white/[0.03] border border-white/10 rounded-lg p-4 animate-fadeIn" style="animation-delay:50ms;opacity:0">
          <div class="flex justify-between items-center pb-2.5 mb-2.5 border-b border-white/10">
            <p class="text-white text-sm font-medium">Compta Express</p>
            <p class="text-base font-bold text-[#FF6B35]">69‚Ç¨<span class="text-[10px] font-normal text-white/40">/mois</span></p>
          </div>
          
          <div class="space-y-2">
            <input type="text" class="w-full px-2.5 py-1.5 bg-white/5 border border-white/10 rounded text-white text-[11px] placeholder-white/30" placeholder="Num√©ro de carte">
            <div class="grid grid-cols-2 gap-2">
              <input type="text" class="w-full px-2.5 py-1.5 bg-white/5 border border-white/10 rounded text-white text-[11px] placeholder-white/30" placeholder="MM/AA">
              <input type="text" class="w-full px-2.5 py-1.5 bg-white/5 border border-white/10 rounded text-white text-[11px] placeholder-white/30" placeholder="CVC">
            </div>
          </div>
          
          <button onclick="pay()" class="w-full mt-3 py-2 bg-[#FF6B35] hover:bg-[#ff7a4a] rounded text-white text-sm font-medium">D√©marrer l'essai</button>
        </div>
      </div>
    </section>
    
    <!-- DONE -->
    <section id="s-done" class="hidden h-full flex items-center justify-center p-6">
      <div class="text-center animate-scaleIn">
        <div class="w-14 h-14 bg-green-500 rounded-lg flex items-center justify-center mx-auto mb-4">
          <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
        </div>
        <h1 class="text-xl font-bold mb-1">Et voil√† ! üéâ</h1>
        <p class="text-white/40 text-sm mb-5">Ton bot est pr√™t</p>
        
        <div class="flex gap-2 justify-center">
          <a href="https://t.me/iArmyBot" target="_blank" class="px-5 py-2 bg-[#0088cc] hover:bg-[#0099dd] rounded-lg text-white text-sm font-medium flex items-center gap-2">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/></svg>
            Telegram
          </a>
        </div>
      </div>
    </section>

  </main>

  <script>
    var S = {
      file: null,
      data: null,
      foundCols: []
    };
    
    function go(id) {
      document.querySelectorAll('section').forEach(function(s) { s.classList.add('hidden'); });
      document.getElementById(id).classList.remove('hidden');
    }
    
    function setStep(n) {
      document.getElementById('stepIndicator').textContent = '√âtape ' + n + '/4';
    }
    
    // Auto transition from intro
    setTimeout(function() {
      document.getElementById('s-intro').style.opacity = '0';
      document.getElementById('s-intro').style.transition = 'opacity 0.4s';
      setTimeout(function() { go('s-choice'); setStep(1); }, 400);
    }, 1500);
    
    function pickSource(type) {
      if (type === 'file') {
        go('s-upload');
      } else {
        go('s-google');
      }
    }
    
    // File handling
    var dropzone = document.getElementById('dropzone');
    var fileIn = document.getElementById('fileIn');
    
    dropzone.addEventListener('click', function() { fileIn.click(); });
    dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.style.borderColor = '#FF6B35'; });
    dropzone.addEventListener('dragleave', function() { dropzone.style.borderColor = ''; });
    dropzone.addEventListener('drop', function(e) { e.preventDefault(); dropzone.style.borderColor = ''; loadFile(e.dataTransfer.files[0]); });
    fileIn.addEventListener('change', function(e) { loadFile(e.target.files[0]); });
    
    function loadFile(file) {
      if (!file) return;
      S.file = file;
      document.getElementById('fileName').textContent = file.name;
      
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
          var sheet = wb.Sheets[wb.SheetNames[0]];
          var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
          S.data = { rows: rows };
          
          go('s-analysis');
          setStep(2);
          renderExcel();
          startSmoothAnalysis();
        } catch (err) {
          alert('Erreur lecture fichier');
        }
      };
      reader.readAsArrayBuffer(file);
    }
    
    function renderExcel() {
      var table = document.getElementById('excelTable');
      if (!S.data) return;
      
      var html = '';
      S.data.rows.forEach(function(row, ri) {
        html += '<tr>';
        (row || []).forEach(function(cell, ci) {
          var val = cell === '' ? '&nbsp;' : (typeof cell === 'number' ? cell.toLocaleString('fr-FR') : cell);
          html += '<td id="cell-' + ri + '-' + ci + '" class="border border-white/10 px-2 py-1 text-white/70 text-[11px] whitespace-nowrap bg-[#111] min-w-[60px]">' + val + '</td>';
        });
        html += '</tr>';
      });
      table.innerHTML = html;
    }
    
    function zoomTo(row, col, scale) {
      var content = document.getElementById('excelContent');
      var cell = document.getElementById('cell-' + row + '-' + col);
      if (!cell || !content) return;
      
      var viewport = content.parentElement;
      var vpW = viewport.clientWidth;
      var vpH = viewport.clientHeight;
      
      var cellX = cell.offsetLeft + cell.offsetWidth / 2;
      var cellY = cell.offsetTop + cell.offsetHeight / 2;
      
      var translateX = vpW / 2 / scale - cellX;
      var translateY = vpH / 2 / scale - cellY;
      
      content.style.transform = 'scale(' + scale + ') translate(' + translateX + 'px, ' + translateY + 'px)';
    }
    
    function resetZoom() {
      document.getElementById('excelContent').style.transform = 'scale(1) translate(0, 0)';
    }
    
    function highlightCell(row, col) {
      // Clear all highlights
      document.querySelectorAll('.cell-highlight').forEach(function(el) {
        el.classList.remove('cell-highlight');
      });
      // Add new highlight
      var cell = document.getElementById('cell-' + row + '-' + col);
      if (cell) cell.classList.add('cell-highlight');
    }
    
    function setStatus(line1, line2, line3) {
      if (line1 !== null) document.getElementById('statusLine1').textContent = line1;
      if (line2 !== null) document.getElementById('statusLine2').textContent = line2;
      if (line3 !== null) document.getElementById('statusLine3').textContent = line3;
    }
    
    function startSmoothAnalysis() {
      var rows = S.data ? S.data.rows : [];
      var found = [];
      
      // Find all relevant columns
      for (var ri = 0; ri < Math.min(10, rows.length); ri++) {
        var row = rows[ri] || [];
        for (var ci = 0; ci < row.length; ci++) {
          var val = String(row[ci]).toLowerCase().trim();
          if (val.indexOf('esp') >= 0 || val.indexOf('cash') >= 0 || val.indexOf('liquide') >= 0) {
            found.push({ row: ri, col: ci, type: 'Esp√®ces', name: row[ci] });
          }
          if (val.indexOf('cb') >= 0 || val.indexOf('carte') >= 0 || val.indexOf('tpe') >= 0) {
            found.push({ row: ri, col: ci, type: 'CB', name: row[ci] });
          }
          if (val.indexOf('cheque') >= 0 || val.indexOf('ch√®que') >= 0) {
            found.push({ row: ri, col: ci, type: 'Ch√®que', name: row[ci] });
          }
          if (val.indexOf('tr') >= 0 || val.indexOf('ticket') >= 0) {
            found.push({ row: ri, col: ci, type: 'TR', name: row[ci] });
          }
          if (val.indexOf('total') >= 0 || val.indexOf('somme') >= 0 || val === 'tt' || val === 'ca') {
            found.push({ row: ri, col: ci, type: 'Total', name: row[ci] });
          }
        }
      }
      
      // Sort by position (closest first - top-left priority)
      found.sort(function(a, b) {
        return (a.row + a.col) - (b.row + b.col);
      });
      
      // Remove duplicates by type
      var seen = {};
      found = found.filter(function(f) {
        if (seen[f.type]) return false;
        seen[f.type] = true;
        return true;
      });
      
      S.foundCols = found;
      
      // Start smooth animation
      setStatus('Lecture du fichier...', '', '');
      
      var delay = 800;
      var index = 0;
      
      function analyzeNext() {
        if (index >= found.length) {
          // Done - show ticket
          setTimeout(showTicket, 600);
          return;
        }
        
        var item = found[index];
        
        // Update status (replace, don't scroll)
        setStatus('Analyse de...', item.type, 'Colonne ' + String.fromCharCode(65 + item.col));
        
        // Zoom and highlight
        zoomTo(item.row, item.col, 2.5);
        highlightCell(item.row, item.col);
        
        index++;
        setTimeout(analyzeNext, 1500); // Slow, smooth transition
      }
      
      setTimeout(analyzeNext, delay);
    }
    
    function showTicket() {
      resetZoom();
      document.querySelectorAll('.cell-highlight').forEach(function(el) {
        el.classList.remove('cell-highlight');
      });
      
      setStatus('Analyse termin√©e ‚úì', '', '');
      
      // Build ticket
      var ticketArea = document.getElementById('ticketArea');
      var ticketContent = document.getElementById('ticketContent');
      
      var html = '';
      var inputCols = [];
      var autoCol = null;
      
      S.foundCols.forEach(function(col) {
        if (col.type === 'Total') {
          autoCol = col.type;
          html += '<div class="text-white/40">= ' + col.type + ' <span class="text-white/20">(auto)</span></div>';
        } else {
          inputCols.push(col.type);
          html += '<div class="text-[#FF6B35]">+ ' + col.type + '</div>';
        }
      });
      
      if (inputCols.length > 0) {
        html = '<div class="text-white/50 mb-1">Tu renseignes :</div>' + html;
      }
      
      ticketContent.innerHTML = html;
      ticketArea.classList.remove('hidden');
      
      // Show confirm button
      setTimeout(function() {
        document.getElementById('actionArea').classList.remove('hidden');
      }, 500);
    }
    
    function confirmAnalysis() {
      go('s-recap');
      setStep(3);
      buildRecapTable();
    }
    
    function buildRecapTable() {
      var cols = S.foundCols.filter(function(c) { return c.type !== 'Total'; });
      
      // Build message
      var msgParts = [];
      cols.forEach(function(c) {
        var val = c.type === 'Esp√®ces' ? '500' : (c.type === 'CB' ? '100' : '50');
        msgParts.push('<span class="text-[#FF6B35]">' + val + '</span> ' + c.type.toLowerCase().substring(0, 3));
      });
      document.getElementById('recapMsg').innerHTML = '"' + msgParts.join(', ') + '"';
      
      // Build table
      var headers = ['Date'];
      var values = ['08/01'];
      var total = 0;
      
      cols.forEach(function(c) {
        headers.push(c.type);
        var val = c.type === 'Esp√®ces' ? 500 : (c.type === 'CB' ? 100 : 50);
        values.push(val + ' ‚Ç¨');
        total += val;
      });
      
      headers.push('Total');
      values.push(total + ' ‚Ç¨');
      
      var html = '<tr>';
      headers.forEach(function(h) {
        html += '<th class="border border-white/10 px-3 py-1.5 text-left text-white/50 text-[10px] font-medium bg-white/5">' + h + '</th>';
      });
      html += '</tr><tr>';
      values.forEach(function(v, i) {
        var cls = 'border border-white/10 px-3 py-1.5 text-[11px] ';
        if (i === 0) {
          cls += 'text-white/60';
        } else if (i === values.length - 1) {
          cls += 'bg-[#FF6B35]/15 border-[#FF6B35]/30 text-[#FF6B35] font-medium';
        } else {
          cls += 'bg-[#FF6B35]/10 border-[#FF6B35]/20 text-[#FF6B35]';
        }
        html += '<td class="' + cls + '">' + v + '</td>';
      });
      html += '</tr>';
      
      document.getElementById('recapTable').innerHTML = html;
    }
    
    function goAccount() {
      go('s-account');
      setStep(3);
    }
    
    function createAcc() {
      var email = document.getElementById('accEmail').value;
      var pwd = document.getElementById('accPwd').value;
      
      if (!email || !pwd || pwd.length < 6) {
        alert('Email et mot de passe (6 car. min) requis');
        return;
      }
      
      go('s-payment');
      setStep(4);
    }
    
    function pay() {
      go('s-done');
    }
  </script>

</body>
</html>
