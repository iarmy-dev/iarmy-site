<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FF6B35'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>i</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    body { background: #0a0a0a; color: white; min-height: 100vh; }
    
    .logo-i {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
    }
    
    .progress-bar {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #FF6B35, #FF8B5E);
      transition: width 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%);
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(255,107,53,0.3);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.08);
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 500;
      width: 100%;
      transition: all 0.2s;
    }
    
    .input-field {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px 16px;
      color: white;
      font-size: 14px;
      width: 80px;
      text-align: center;
    }
    .input-field:focus { outline: none; border-color: #FF6B35; }
    
    .upload-zone {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 48px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #FF6B35;
      background: rgba(255,107,53,0.05);
    }
    
    .step { display: none; }
    .step.active { display: block; }
    
    .field-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .field-row:last-child { border-bottom: none; }
    
    @keyframes fade-up {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-up { animation: fade-up 0.4s ease-out forwards; }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }
    .spinner.show { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="border-b border-white/10">
    <div class="max-w-2xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2">
        <div class="logo-i">i</div>
        <span class="font-semibold">iArmy</span>
      </a>
      <a href="compte.html" class="text-white/40 hover:text-white text-sm">Annuler</a>
    </div>
  </header>
  
  <!-- Progress -->
  <div class="max-w-lg mx-auto px-6 pt-6">
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width: 33%"></div>
    </div>
    <p class="text-white/30 text-xs mt-2">√âtape <span id="step-num">1</span>/3</p>
  </div>
  
  <!-- Content -->
  <main class="max-w-lg mx-auto px-6 py-12">
    
    <!-- Step 1: Google Sheet -->
    <div class="step active" id="step-1">
      <div class="text-center mb-8 fade-up">
        <span class="text-5xl mb-4 block">üìä</span>
        <h1 class="text-2xl font-bold mb-2">Connecte ton Google Sheet</h1>
        <p class="text-white/50">On va √©crire dedans automatiquement</p>
      </div>
      
      <div class="space-y-4 fade-up">
        <div>
          <label class="block text-white/60 text-sm mb-2">Lien de ton Google Sheet</label>
          <input type="url" id="sheet-url" class="input-field w-full" placeholder="https://docs.google.com/spreadsheets/d/...">
        </div>
        <p class="text-white/30 text-xs">
          ‚ö†Ô∏è Partage ton Sheet avec : <code class="text-orange-400"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ea838b988793aa838b988793c788859ec4838b87c48d998f989c83898f8b8989859f849ec4898587">[email&#160;protected]</a></code> (acc√®s √©diteur)
        </p>
      </div>
      
      <button class="btn-primary mt-8" id="btn-1" onclick="nextStep()">Continuer</button>
      
      <div class="text-center mt-6">
        <button class="text-white/30 text-sm hover:text-white" onclick="skipSheet()">Passer cette √©tape ‚Üí</button>
      </div>
    </div>
    
    <!-- Step 2: Keywords -->
    <div class="step" id="step-2">
      <div class="text-center mb-8 fade-up">
        <h1 class="text-2xl font-bold mb-2">Tes mots-cl√©s</h1>
        <p class="text-white/50">Personnalise comme tu veux</p>
      </div>
      
      <div class="fade-up">
        <div class="field-row">
          <span>üí≥ Carte bleue</span>
          <input type="text" class="input-field keyword" value="cb" data-key="cb">
        </div>
        <div class="field-row">
          <span>üíµ Esp√®ces</span>
          <input type="text" class="input-field keyword" value="esp" data-key="esp">
        </div>
        <div class="field-row">
          <span>üé´ Tickets resto</span>
          <input type="text" class="input-field keyword" value="tr" data-key="tr">
        </div>
        <div class="field-row">
          <span>üìâ D√©penses</span>
          <input type="text" class="input-field keyword" value="dep" data-key="dep">
        </div>
      </div>
      
      <button class="btn-primary mt-8" onclick="nextStep()">Continuer</button>
    </div>
    
    <!-- Step 3: Done -->
    <div class="step" id="step-3">
      <div class="text-center fade-up">
        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold mb-2">C'est pr√™t ! üéâ</h1>
        <p class="text-white/50 mb-8">Ton bot Compta Express est configur√©</p>
        
        <a href="compte.html" class="btn-primary block text-center mb-3">Voir mon compte</a>
        <a href="https://t.me/iArmyBot" target="_blank" class="btn-secondary block text-center">üí¨ Ouvrir Telegram</a>
        
        <p class="text-white/30 text-sm mt-6">
          Envoie <code class="text-orange-400">cb 1200 esp 500</code> pour tester
        </p>
      </div>
    </div>
    
  </main>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    // ===========================================
    // SUPABASE CONFIG
    // ===========================================
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_8mpFx9ubrV29KfKtgAb3eg_dyazidfT';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let USER = null;
    let step = 1;
    let sheetId = null;
    
    // ===========================================
    // INIT
    // ===========================================
    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = 'connexion.html';
        return;
      }
      USER = user;
    }
    init();
    
    // ===========================================
    // NAVIGATION
    // ===========================================
    function nextStep() {
      // Validate current step
      if (step === 1) {
        const sheetUrl = document.getElementById('sheet-url').value;
        if (sheetUrl) {
          // Extract sheet ID from URL
          const match = sheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
          if (match) {
            sheetId = match[1];
          }
        }
      }
      
      document.getElementById('step-' + step).classList.remove('active');
      step++;
      document.getElementById('step-' + step).classList.add('active');
      document.getElementById('progress').style.width = (step * 33) + '%';
      document.getElementById('step-num').textContent = step;
      
      if (step === 3) {
        saveBot();
      }
    }
    
    function skipSheet() {
      sheetId = null;
      nextStep();
    }
    
    // ===========================================
    // SAVE BOT
    // ===========================================
    async function saveBot() {
      // Get keywords
      const keywords = {};
      document.querySelectorAll('.keyword').forEach(input => {
        keywords[input.dataset.key] = input.value;
      });
      
      // Get module from URL
      const urlParams = new URLSearchParams(window.location.search);
      const module = urlParams.get('module') || 'compta';
      
      try {
        const { data: bot, error } = await supabase
          .from('bots')
          .insert({
            user_id: USER.id,
            module: module,
            name: 'Compta Express',
            config: { keywords },
            google_sheet_id: sheetId,
            active: true
          })
          .