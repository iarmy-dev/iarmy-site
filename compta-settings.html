<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©glages Compta - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FF6B35'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>i</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #030303; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #030303 0%, #0a0508 25%, #050808 50%, #080805 75%, #030303 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .orb { position: fixed; border-radius: 50%; filter: blur(100px); animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -250px; right: -150px; opacity: 0.15; }
    .orb-2 { width: 400px; height: 400px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -200px; left: -150px; opacity: 0.12; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
    .logo-i:hover { transform: scale(1.2) rotate(-15deg); box-shadow: 0 12px 40px rgba(255,107,53,0.6); }

    .nav-user-section { display: flex; align-items: center; gap: 12px; }
    .nav-profile { display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; color: white; font-weight: 500; }
    .nav-profile:hover { background: rgba(255,255,255,0.08); }
    .nav-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,107,53,0.3); }

    .page-container { max-width: 640px; margin: 0 auto; padding: 90px 20px 30px; position: relative; z-index: 10; }

    /* Loading */
    .loading-overlay { position: fixed; inset: 0; background: rgba(3,3,3,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .loading-spinner { width: 28px; height: 28px; border: 2px solid rgba(255,107,53,0.2); border-top-color: #FF6B35; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Header page */
    .page-header { text-align: center; margin-bottom: 24px; }
    .page-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; }
    .page-subtitle { font-size: 14px; color: rgba(255,255,255,0.5); }

    /* Preview Card */
    .preview-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 16px; margin-bottom: 20px; }
    .preview-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px 14px; color: white; font-size: 14px; font-family: inherit; margin-bottom: 12px; }
    .preview-input:focus { outline: none; border-color: #FF6B35; }
    .preview-input::placeholder { color: rgba(255,255,255,0.3); }
    .preview-row { display: grid; grid-template-columns: 1fr 1.5fr; gap: 12px; }
    .preview-box { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; min-height: 80px; }
    .preview-label { font-size: 10px; color: rgba(255,255,255,0.4); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .preview-label-icon { font-size: 12px; }
    .tg-bubble { background: #2AABEE; padding: 10px 14px; border-radius: 14px 14px 14px 4px; font-size: 13px; display: inline-block; max-width: 100%; word-break: break-word; }
    .empty-state { color: rgba(255,255,255,0.25); font-size: 12px; }

    /* Mini Excel preview */
    .mini-excel-wrapper { position: relative; }
    .mini-excel-container { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; }
    .mini-excel-container::-webkit-scrollbar { display: none; }
    .mini-excel { background: #1a472a; border-radius: 6px; overflow: hidden; font-size: 11px; display: inline-flex; flex-direction: column; min-width: 100%; }
    .mini-excel-header { display: flex; background: #0f9d58; }
    .mini-excel-header span { min-width: 42px; padding: 4px 6px; text-align: center; font-weight: 600; color: white; border-right: 1px solid rgba(255,255,255,0.2); font-size: 10px; white-space: nowrap; }
    .mini-excel-header span:last-child { border-right: none; }
    .mini-excel-row { display: flex; background: white; }
    .mini-excel-row span { min-width: 42px; max-width: 70px; padding: 5px 6px; text-align: center; color: #333; border-right: 1px solid #e0e0e0; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-excel-row span:last-child { border-right: none; }
    .mini-excel-row span.calculated { background: #e8f5e9; color: #2e7d32; font-weight: 600; }
    .mini-excel-row span.empty { color: #bbb; }
    .excel-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; color: white; font-size: 12px; cursor: pointer; z-index: 5; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; }
    .excel-nav:hover { background: rgba(0,0,0,0.7); }
    .excel-nav.left { left: -8px; }
    .excel-nav.right { right: -8px; }
    .mini-excel-wrapper:hover .excel-nav.visible { opacity: 1; }

    /* Rules detail */
    .preview-rules { margin-top: 10px; padding: 8px 10px; background: rgba(255,107,53,0.08); border-radius: 8px; font-size: 11px; color: rgba(255,255,255,0.6); }
    .preview-rules strong { color: #FF8B5E; }

    /* Section */
    .section { margin-bottom: 24px; }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .section-title { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }
    .section-count { font-size: 12px; color: rgba(255,255,255,0.3); }
    .section-badge { font-size: 10px; padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 6px; color: rgba(255,255,255,0.4); margin-left: 6px; }

    /* Keywords grid - 2 colonnes */
    .kw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kw-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; position: relative; transition: all 0.2s; }
    .kw-card:hover { border-color: rgba(255,255,255,0.12); }
    .kw-card.incomplete { border-color: rgba(239,68,68,0.3); }
    .kw-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .kw-name-input { background: none; border: none; color: white; font-weight: 700; font-size: 16px; width: 60px; font-family: inherit; }
    .kw-name-input:focus { outline: none; }
    .kw-name-input::placeholder { color: rgba(255,255,255,0.25); }
    .kw-del { background: none; border: none; color: rgba(255,255,255,0.2); cursor: pointer; font-size: 14px; padding: 0; line-height: 1; }
    .kw-del:hover { color: #ef4444; }
    .kw-bottom { display: flex; align-items: center; gap: 6px; }
    .kw-arrow { color: rgba(255,255,255,0.2); font-size: 12px; }
    .kw-col-select { background: rgba(255,107,53,0.12); border: 1px solid rgba(255,107,53,0.25); border-radius: 6px; padding: 6px 10px; color: #FF8B5E; font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer; }
    .kw-col-select:focus { outline: none; }
    .kw-col-select.empty { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.06); color: rgba(255,255,255,0.3); }
    .kw-note-select { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 6px; padding: 6px 8px; color: rgba(255,255,255,0.35); font-size: 12px; font-family: inherit; cursor: pointer; }
    .kw-note-select.active { background: rgba(34,197,94,0.1); border-color: rgba(34,197,94,0.25); color: #4ade80; }

    .btn-add { width: 100%; padding: 12px; background: transparent; border: 1px dashed rgba(255,255,255,0.1); border-radius: 10px; color: rgba(255,255,255,0.4); font-size: 13px; cursor: pointer; transition: all 0.2s; font-family: inherit; margin-top: 10px; }
    .btn-add:hover { border-color: #FF6B35; color: #FF8B5E; }

    /* Rules */
    .rule-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    .rule-terms { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
    .rule-select { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 6px 10px; color: white; font-size: 13px; font-family: inherit; cursor: pointer; }
    .rule-select:focus { outline: none; border-color: #FF6B35; }
    .rule-op-select { background: rgba(255,107,53,0.15); border: 1px solid rgba(255,107,53,0.3); border-radius: 6px; padding: 6px 8px; color: #FF8B5E; font-size: 13px; font-weight: 700; font-family: inherit; cursor: pointer; width: 44px; text-align: center; }
    .rule-op-select:focus { outline: none; }
    .rule-bottom { display: flex; align-items: center; gap: 8px; }
    .rule-arrow { color: rgba(255,255,255,0.25); font-size: 12px; }
    .rule-add-term { background: rgba(255,255,255,0.04); border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px; padding: 4px 8px; color: rgba(255,255,255,0.4); font-size: 11px; cursor: pointer; }
    .rule-add-term:hover { border-color: #FF6B35; color: #FF8B5E; }
    .rule-del-term { background: none; border: none; color: rgba(255,255,255,0.2); cursor: pointer; font-size: 11px; padding: 2px 4px; }
    .rule-del-term:hover { color: #ef4444; }

    /* Preview am√©lior√© */
    .preview-result { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.06); }
    .preview-calc { font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 4px; }
    .preview-calc-result { color: #4ade80; font-weight: 600; }

    /* Connexions */
    .conn-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 12px 16px; margin-bottom: 8px; }
    .conn-label { font-size: 14px; }
    .conn-status { font-size: 13px; color: #4ade80; font-weight: 500; }
    .conn-status a { color: inherit; text-decoration: none; }
    .conn-status a:hover { text-decoration: underline; }
    .conn-status.pending { color: rgba(255,255,255,0.3); }

    /* Toggle switch */
    .toggle-active { background: #22C55E !important; }
    .toggle-dot-active { transform: translateX(20px); background: white !important; }

    /* Auto-save indicator */
    .auto-save-indicator { position: fixed; top: 80px; right: 20px; padding: 8px 14px; background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.25); border-radius: 8px; color: #4ade80; font-size: 12px; font-weight: 500; opacity: 0; transform: translateY(-10px); transition: all 0.3s; z-index: 100; display: flex; align-items: center; gap: 6px; }
    .auto-save-indicator.show { opacity: 1; transform: translateY(0); }
    .auto-save-indicator.saving { background: rgba(255,107,53,0.15); border-color: rgba(255,107,53,0.25); color: #FF8B5E; }

    /* Toast */
    .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); padding: 12px 24px; background: #22C55E; border-radius: 12px; color: white; font-size: 14px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 1000; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: #ef4444; }

    footer a { color: rgba(255,255,255,0.4); text-decoration: none; transition: color 0.2s; }
    footer a:hover { color: #FF8B5E; }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-3xl mx-auto px-5 py-4 flex items-center justify-between">
      <a href="compte.html" class="flex items-center gap-3">
        <div class="logo-i">i</div>
        <span class="font-semibold text-lg">iArmy</span>
      </a>
      <div id="auth-section"></div>
    </div>
  </nav>

  <div class="page-container">
    <div class="page-header">
      <div class="page-title">Compta Express</div>
      <div class="page-subtitle">Configure ton robot</div>
    </div>

    <!-- Preview -->
    <div class="preview-card">
      <input type="text" class="preview-input" id="test-input" placeholder="Teste: cb 200 esp 100 tr 50" oninput="updatePreview()">
      <div class="preview-row">
        <div class="preview-box">
          <div class="preview-label"><span class="preview-label-icon">üí¨</span> Telegram</div>
          <div id="preview-tg"><span class="empty-state">Tape un message...</span></div>
        </div>
        <div class="preview-box">
          <div class="preview-label"><span class="preview-label-icon">üìä</span> Google Sheets</div>
          <div id="preview-sheet"><span class="empty-state">Preview Excel...</span></div>
        </div>
      </div>
      <div class="preview-rules" id="preview-rules" style="display: none;"></div>
    </div>

    <!-- Keywords -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Mots-cles</div>
        <span class="section-count" id="kw-count">0</span>
      </div>
      <div class="kw-grid" id="kw-grid"></div>
      <button class="btn-add" onclick="addKw()">+ Ajouter</button>
    </div>

    <!-- Rules -->
    <div class="section">
      <div class="section-header">
        <div class="section-title">Regles<span class="section-badge">optionnel</span></div>
        <span class="section-count" id="rules-count">0</span>
      </div>
      <div id="rules-list"></div>
      <button class="btn-add" onclick="addRule()">+ Ajouter</button>
    </div>

    <!-- Connexions -->
    <div class="section">
      <div class="section-title">Connexions</div>
      <div class="conn-row">
        <span class="conn-label">Google Sheets</span>
        <span class="conn-status pending" id="info-sheet">-</span>
      </div>
      <div class="conn-row">
        <span class="conn-label">Telegram</span>
        <span class="conn-status pending" id="info-tg">-</span>
      </div>
    </div>

    <!-- Export Comptable -->
    <div class="section" id="export-section" style="margin-top: 28px; display: none;">
      <div class="section-header">
        <div class="section-title">Export Comptable</div>
      </div>

      <!-- Export manuel -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
        <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 10px;">Export manuel</div>
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <select id="export-month" style="flex: 1; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px;">
            <option value="01">Janvier</option><option value="02">F√©vrier</option><option value="03">Mars</option>
            <option value="04">Avril</option><option value="05">Mai</option><option value="06">Juin</option>
            <option value="07">Juillet</option><option value="08">Ao√ªt</option><option value="09">Septembre</option>
            <option value="10">Octobre</option><option value="11">Novembre</option><option value="12">D√©cembre</option>
          </select>
          <select id="export-format" style="flex: 1; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px;">
            <option value="csv">CSV</option>
            <option value="xlsx">Excel</option>
          </select>
        </div>
        <button onclick="exportData()" style="width: 100%; padding: 12px; background: rgba(255,107,53,0.12); border: 1px solid rgba(255,107,53,0.2); border-radius: 10px; color: #FF8B5E; font-size: 13px; font-weight: 600; cursor: pointer;">üì• Exporter maintenant</button>
      </div>

      <!-- Envoi automatique -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; margin-bottom: 12px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <div>
            <div style="font-size: 13px; font-weight: 500;">üìß Envoi √† la comptable</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.4);">L'export est envoy√© automatiquement par email</div>
          </div>
          <label style="position: relative; width: 44px; height: 24px;">
            <input type="checkbox" id="auto-export-toggle" onchange="toggleAutoExport()" style="opacity: 0; width: 0; height: 0;">
            <span style="position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.1); border-radius: 12px; transition: 0.3s;"></span>
            <span id="toggle-dot" style="position: absolute; left: 3px; top: 3px; width: 18px; height: 18px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.3s;"></span>
          </label>
        </div>
        <div id="auto-export-settings" style="display: none;">
          <input type="email" id="export-email" placeholder="Email comptable" style="width: 100%; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px; margin-bottom: 8px;" onchange="saveAutoExportSettings()">
          <div style="display: flex; gap: 8px;">
            <select id="auto-export-day" style="flex: 1; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px;" onchange="saveAutoExportSettings()">
              <option value="last">Dernier jour du mois</option>
              <option value="1">1er du mois suivant</option>
              <option value="5">5 du mois suivant</option>
            </select>
            <select id="auto-export-format" style="flex: 1; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px;" onchange="saveAutoExportSettings()">
              <option value="csv">CSV</option>
              <option value="xlsx">Excel</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Rappel -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <div style="font-size: 13px; font-weight: 500;">üîî Rappel d'export</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.4);">Te rappelle de v√©rifier tes donn√©es avant cl√¥ture</div>
          </div>
          <label style="position: relative; width: 44px; height: 24px;">
            <input type="checkbox" id="reminder-toggle" onchange="toggleReminder()" style="opacity: 0; width: 0; height: 0;">
            <span style="position: absolute; cursor: pointer; inset: 0; background: rgba(255,255,255,0.1); border-radius: 12px; transition: 0.3s;"></span>
            <span id="reminder-dot" style="position: absolute; left: 3px; top: 3px; width: 18px; height: 18px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.3s;"></span>
          </label>
        </div>
        <div id="reminder-settings" style="display: none; margin-top: 10px;">
          <select id="reminder-days" style="width: 100%; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; color: white; font-size: 13px;" onchange="saveAutoExportSettings()">
            <option value="3">3 jours avant la fin du mois</option>
            <option value="5">5 jours avant</option>
            <option value="7">7 jours avant</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Lien discret pour nouveau fichier -->
    <div style="text-align: center; margin-top: 40px;">
      <button onclick="resetConfig()" style="background: none; border: none; color: rgba(255,255,255,0.25); font-size: 11px; cursor: pointer; padding: 8px 16px; transition: color 0.2s;" onmouseover="this.style.color='rgba(255,255,255,0.5)'" onmouseout="this.style.color='rgba(255,255,255,0.25)'">‚Üª Nouveau fichier</button>
    </div>
  </div>

  <footer style="padding: 32px 20px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); margin-top: 32px;">
    <div style="display: flex; justify-content: center; gap: 24px; font-size: 14px;">
      <a href="index.html">Accueil</a>
      <a href="compte.html">Compte</a>
      <a href="mailto:contact@iarmy.fr">Contact</a>
    </div>
    <p style="color: rgba(255,255,255,0.25); font-size: 12px; text-align: center; margin-top: 12px;">¬© 2026 iArmy</p>
  </footer>

  <div class="toast" id="toast"></div>
  <div class="auto-save-indicator" id="auto-save-indicator">‚úì Sauvegard√©</div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODY1MTIsImV4cCI6MjA4MzQ2MjUxMn0.1W2OaRb0sApMvrG_28AoV2zUFAzrptzpwbR1c65tOPo';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let config = null, keywords = [], rules = [], sheetHeaders = {}, exportSettings = {};
    const cols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    let autoSaveTimeout = null;

    // Nouveau format r√®gles: { terms: [{name, op}], target }
    // op: '+' ou '-' (premier terme toujours '+')

    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { location.href = 'index.html'; return; }

      const user = session.user;
      const userName = user.user_metadata?.full_name?.split(' ')[0] || user.user_metadata?.name?.split(' ')[0] || user.email?.split('@')[0] || 'User';
      const userAvatar = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${userName}&background=FF6B35&color=fff`;

      document.getElementById('auth-section').innerHTML = `
        <div class="nav-user-section">
          <a href="compte.html" class="nav-profile">
            <img src="${userAvatar}" class="nav-avatar">
            <span>${userName}</span>
          </a>
        </div>
      `;

      await loadConfig(session.user.id);
      document.getElementById('loading').style.display = 'none';
    }

    async function loadConfig(userId) {
      const { data: cfg } = await supabaseClient.from('user_configs').select('sheet_id, excel_config').eq('user_id', userId).single();

      if (!cfg) { window.location.href = 'compta.html'; return; }

      const { data: tg } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', userId).maybeSingle();

      config = cfg;

      if (cfg?.excel_config?.colonnes_detectees) {
        cfg.excel_config.colonnes_detectees.forEach(c => {
          if (c.colonne && c.nom) sheetHeaders[c.colonne] = c.nom;
        });
      }

      keywords = (cfg?.excel_config?.colonnes_a_remplir || []).map(c => ({
        nom: c.nom,
        colonne: c.colonne || '',
        noteColumn: c.noteColumn || '',
        aliases: c.aliases || []
      }));

      // Convertir ancien format r√®gles vers nouveau
      rules = (cfg?.excel_config?.regles_calcul || []).map(r => {
        // Nouveau format avec terms
        if (r.terms && Array.isArray(r.terms)) {
          return { terms: r.terms, target: r.target || '' };
        }
        // Ancien format avec sources array
        if (r.sources && Array.isArray(r.sources)) {
          return {
            terms: r.sources.map((s, idx) => ({ name: s, op: '+' })),
            target: r.target || ''
          };
        }
        return { terms: [{ name: '', op: '+' }], target: '' };
      });

      render();

      const sheetEl = document.getElementById('info-sheet');
      const tgEl = document.getElementById('info-tg');

      if (cfg?.sheet_id) {
        sheetEl.innerHTML = `<a href="https://docs.google.com/spreadsheets/d/${cfg.sheet_id}/edit" target="_blank">Ouvrir</a>`;
        sheetEl.classList.remove('pending');
        document.getElementById('export-section').style.display = 'block';
        document.getElementById('export-month').value = String(new Date().getMonth() + 1).padStart(2, '0');
      }
      if (tg?.telegram_user_id) {
        tgEl.textContent = 'Connect√©';
        tgEl.classList.remove('pending');
      }

      // Charger les settings d'export
      exportSettings = cfg?.excel_config?.export_settings || {};
      loadExportSettings();
    }

    function loadExportSettings() {
      // Envoi automatique
      if (exportSettings.auto_export_enabled) {
        document.getElementById('auto-export-toggle').checked = true;
        document.getElementById('toggle-dot').classList.add('toggle-dot-active');
        document.getElementById('toggle-dot').previousElementSibling.classList.add('toggle-active');
        document.getElementById('auto-export-settings').style.display = 'block';
      }
      if (exportSettings.export_email) {
        document.getElementById('export-email').value = exportSettings.export_email;
      }
      if (exportSettings.auto_export_day) {
        document.getElementById('auto-export-day').value = exportSettings.auto_export_day;
      }
      if (exportSettings.auto_export_format) {
        document.getElementById('auto-export-format').value = exportSettings.auto_export_format;
      }

      // Rappel
      if (exportSettings.reminder_enabled) {
        document.getElementById('reminder-toggle').checked = true;
        document.getElementById('reminder-dot').classList.add('toggle-dot-active');
        document.getElementById('reminder-dot').previousElementSibling.classList.add('toggle-active');
        document.getElementById('reminder-settings').style.display = 'block';
      }
      if (exportSettings.reminder_days) {
        document.getElementById('reminder-days').value = exportSettings.reminder_days;
      }
    }

    function render() {
      renderKw();
      renderRules();
      updatePreview();
      updateCounts();
      updatePlaceholder();
    }

    function updatePlaceholder() {
      // G√©n√©rer un exemple bas√© sur les mots-cl√©s de l'utilisateur et pr√©-remplir le preview
      const validKw = keywords.filter(k => k.nom && k.colonne);
      const input = document.getElementById('test-input');

      if (validKw.length === 0) {
        input.placeholder = 'Teste: cb 200 esp 100';
        return;
      }

      // Cr√©er un exemple avec des montants
      const amounts = [50, 100, 150, 200, 80, 120];
      const example = validKw.slice(0, 5).map((k, i) =>
        `${k.nom.toLowerCase()} ${amounts[i % amounts.length]}`
      ).join(' ');

      input.placeholder = `Teste: ${example}`;

      // Si le champ est vide, pr√©-remplir avec l'exemple pour montrer le preview
      if (!input.value) {
        input.value = example;
        updatePreview();
      }
    }

    function updateCounts() {
      const validKw = keywords.filter(k => k.nom && k.colonne).length;
      const validRules = rules.filter(r => r.terms.some(t => t.name) && r.target).length;
      document.getElementById('kw-count').textContent = validKw;
      document.getElementById('rules-count').textContent = validRules;
    }

    function renderKw() {
      document.getElementById('kw-grid').innerHTML = keywords.map((k, i) => {
        const incomplete = k.nom && !k.colonne;
        const colHeader = k.colonne && sheetHeaders[k.colonne] ? sheetHeaders[k.colonne] : null;
        return `
        <div class="kw-card ${incomplete ? 'incomplete' : ''}">
          <div class="kw-top">
            <input class="kw-name-input" value="${k.nom}" onchange="updKw(${i},'nom',this.value)" placeholder="CB">
            <button class="kw-del" onclick="delKw(${i})">√ó</button>
          </div>
          <div class="kw-bottom">
            <span class="kw-arrow">‚Üí</span>
            <select class="kw-col-select ${!k.colonne?'empty':''}" onchange="updKw(${i},'colonne',this.value)">
              <option value="">Colonne</option>
              ${cols.map(c=>`<option value="${c}" ${k.colonne===c?'selected':''}>${c}${sheetHeaders[c]?' ¬∑ '+sheetHeaders[c]:''}</option>`).join('')}
            </select>
            <select class="kw-note-select ${k.noteColumn?'active':''}" onchange="updKw(${i},'noteColumn',this.value)">
              <option value="">Note</option>
              ${cols.map(c=>`<option value="${c}" ${k.noteColumn===c?'selected':''}>${c}</option>`).join('')}
            </select>
          </div>
          ${colHeader ? `<div style="font-size:10px;color:rgba(255,255,255,0.35);margin-top:6px;">Excel: "${colHeader}"</div>` : ''}
        </div>
      `}).join('');
    }

    function renderRules() {
      const names = keywords.map(k => k.nom).filter(n => n);

      document.getElementById('rules-list').innerHTML = rules.map((r, i) => {
        const termsHtml = r.terms.map((t, j) => {
          const opHtml = j > 0 ? `
            <select class="rule-op-select" onchange="updRuleTerm(${i},${j},'op',this.value)">
              <option value="+" ${t.op === '+' ? 'selected' : ''}>+</option>
              <option value="-" ${t.op === '-' ? 'selected' : ''}>‚àí</option>
            </select>
          ` : '';

          return `
            ${opHtml}
            <select class="rule-select" onchange="updRuleTerm(${i},${j},'name',this.value)">
              <option value="">...</option>
              ${names.map(n => `<option value="${n}" ${t.name === n ? 'selected' : ''}>${n}</option>`).join('')}
            </select>
            ${r.terms.length > 1 ? `<button class="rule-del-term" onclick="delRuleTerm(${i},${j})">√ó</button>` : ''}
          `;
        }).join('');

        return `
          <div class="rule-card">
            <div class="rule-terms">
              ${termsHtml}
              <button class="rule-add-term" onclick="addRuleTerm(${i})">+ terme</button>
            </div>
            <div class="rule-bottom">
              <span class="rule-arrow">=</span>
              <select class="rule-select" onchange="updRuleTarget(${i},this.value)">
                <option value="">r√©sultat</option>
                ${names.map(n => `<option value="${n}" ${r.target === n ? 'selected' : ''}>${n}</option>`).join('')}
              </select>
              <button class="kw-del" onclick="delRule(${i})">√ó</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Keywords
    function addKw() { keywords.push({ nom: '', colonne: '', noteColumn: '', aliases: [] }); render(); scheduleAutoSave(); }
    function updKw(i, f, v) {
      if (f === 'nom') { keywords[i].nom = v.toUpperCase(); keywords[i].aliases = [v.toLowerCase()]; }
      else keywords[i][f] = v;
      render();
      scheduleAutoSave();
    }
    function delKw(i) { keywords.splice(i, 1); render(); scheduleAutoSave(); }

    // Rules
    function addRule() { rules.push({ terms: [{ name: '', op: '+' }], target: '' }); render(); scheduleAutoSave(); }
    function delRule(i) { rules.splice(i, 1); render(); scheduleAutoSave(); }
    function updRuleTerm(ri, ti, field, value) { rules[ri].terms[ti][field] = value; render(); scheduleAutoSave(); }
    function updRuleTarget(ri, value) { rules[ri].target = value; render(); scheduleAutoSave(); }
    function addRuleTerm(ri) { rules[ri].terms.push({ name: '', op: '+' }); render(); scheduleAutoSave(); }
    function delRuleTerm(ri, ti) {
      if (rules[ri].terms.length > 1) {
        rules[ri].terms.splice(ti, 1);
        // S'assurer que le premier terme est toujours '+'
        if (rules[ri].terms.length > 0) rules[ri].terms[0].op = '+';
        render();
        scheduleAutoSave();
      }
    }

    // Auto-save avec debounce
    function scheduleAutoSave() {
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
      const indicator = document.getElementById('auto-save-indicator');
      indicator.textContent = '‚è≥ En cours...';
      indicator.classList.add('show', 'saving');

      autoSaveTimeout = setTimeout(async () => {
        await saveConfig(true);
      }, 1500);
    }

    // Toggle envoi automatique
    function toggleAutoExport() {
      const toggle = document.getElementById('auto-export-toggle');
      const dot = document.getElementById('toggle-dot');
      const settings = document.getElementById('auto-export-settings');

      if (toggle.checked) {
        dot.classList.add('toggle-dot-active');
        dot.previousElementSibling.classList.add('toggle-active');
        settings.style.display = 'block';
      } else {
        dot.classList.remove('toggle-dot-active');
        dot.previousElementSibling.classList.remove('toggle-active');
        settings.style.display = 'none';
      }
      saveAutoExportSettings();
    }

    // Toggle rappel
    function toggleReminder() {
      const toggle = document.getElementById('reminder-toggle');
      const dot = document.getElementById('reminder-dot');
      const settings = document.getElementById('reminder-settings');

      if (toggle.checked) {
        dot.classList.add('toggle-dot-active');
        dot.previousElementSibling.classList.add('toggle-active');
        settings.style.display = 'block';
      } else {
        dot.classList.remove('toggle-dot-active');
        dot.previousElementSibling.classList.remove('toggle-active');
        settings.style.display = 'none';
      }
      saveAutoExportSettings();
    }

    // Sauvegarder les settings d'export
    async function saveAutoExportSettings() {
      exportSettings = {
        auto_export_enabled: document.getElementById('auto-export-toggle').checked,
        export_email: document.getElementById('export-email').value,
        auto_export_day: document.getElementById('auto-export-day').value,
        auto_export_format: document.getElementById('auto-export-format').value,
        reminder_enabled: document.getElementById('reminder-toggle').checked,
        reminder_days: document.getElementById('reminder-days').value
      };
      scheduleAutoSave();
    }

    function updatePreview() {
      const txt = document.getElementById('test-input').value.trim();
      const tgEl = document.getElementById('preview-tg');
      const sheetEl = document.getElementById('preview-sheet');
      const rulesEl = document.getElementById('preview-rules');

      // 1. Afficher bulle Telegram (vide ou avec message)
      if (!txt) {
        tgEl.innerHTML = '<span class="empty-state">Tape un message...</span>';
      } else {
        tgEl.innerHTML = `<div class="tg-bubble">${escapeHtml(txt)}</div>`;
      }

      // 2. V√©rifier si on a des mots-cl√©s configur√©s
      const activeKeywords = keywords.filter(k => k.nom && k.colonne);

      if (activeKeywords.length === 0) {
        sheetEl.innerHTML = '<span class="empty-state">Configure tes mots-cl√©s</span>';
        rulesEl.style.display = 'none';
        return;
      }

      // 3. Parser les valeurs (si texte pr√©sent)
      const parsed = {};
      if (txt) {
        for (const k of keywords) {
          if (!k.nom) continue;
          // Construire liste de tous les termes √† chercher (nom + aliases)
          const termsToSearch = [k.nom.toLowerCase()];
          if (k.aliases && k.aliases.length) {
            k.aliases.forEach(a => { if (a) termsToSearch.push(a.toLowerCase()); });
          }
          // Aliases courants pour les termes comptables
          const commonAliases = {
            'dep': ['d√©pense', 'd√©penses', 'depense', 'depenses', 'd√©p'],
            'esp': ['esp√®ces', 'especes', 'esp√®ce', 'espece', 'cash', 'liquide'],
            'cb': ['carte', 'cartes', 'bancaire', 'tpe', 'visa'],
            'tr': ['ticket', 'tickets', 'resto', 'restaurant', 'titres'],
            'raz': ['recette', 'recettes', 'total', 'ca', 'z']
          };
          const base = k.nom.toLowerCase();
          if (commonAliases[base]) {
            commonAliases[base].forEach(a => termsToSearch.push(a));
          }
          // Chercher chaque terme
          for (const term of termsToSearch) {
            const re = new RegExp(`\\b${term}\\s*:?\\s*([0-9]+(?:[.,][0-9]+)?)`, 'i');
            const m = txt.toLowerCase().match(re);
            if (m) {
              let val = parseFloat(m[1].replace(',', '.'));
              // Limite max 999 999‚Ç¨ pour √©viter les erreurs de saisie
              if (val > 10000) val = 10000;
              parsed[k.nom] = val;
              break;
            }
          }
        }
      }

      // 4. Appliquer les r√®gles
      const result = { ...parsed };
      const calcDetails = [];
      const calculatedFields = new Set();

      for (const r of rules) {
        if (!r.target || !r.terms.some(t => t.name)) continue;

        let calcValue = 0;
        let calcStr = '';
        let hasValue = false;

        for (let i = 0; i < r.terms.length; i++) {
          const t = r.terms[i];
          if (!t.name) continue;

          const val = parsed[t.name] || 0;
          if (val > 0) hasValue = true;

          if (i === 0) {
            calcValue = val;
            calcStr = t.name;
          } else {
            if (t.op === '-') {
              calcValue -= val;
              calcStr += ` ‚àí ${t.name}`;
            } else {
              calcValue += val;
              calcStr += ` + ${t.name}`;
            }
          }
        }

        if (hasValue && r.target) {
          result[r.target] = calcValue;
          calculatedFields.add(r.target);
          calcDetails.push(`<strong>${calcStr} = ${r.target}</strong> (${calcValue}‚Ç¨)`);
        }
      }

      // 5. Calculer TOTAL (somme de toutes les colonnes)
      let total = 0;
      for (const k of activeKeywords) {
        const val = result[k.nom] || 0;
        if (val > 0) {
          total += val;
        }
      }

      // TVA √† 10% (restauration)
      const tva = total > 0 ? Math.round(total * 0.1 * 100) / 100 : 0;

      // 6. Construire le mini Excel avec TOTAL et TVA
      // Header avec colonnes + TOTAL + TVA
      const headerCells = activeKeywords.map(k => `<span>${k.colonne}</span>`).join('') +
        '<span style="background:#1565c0;">TOT</span>' +
        '<span style="background:#7b1fa2;">TVA</span>';

      // Row avec valeurs
      const valueCells = activeKeywords.map(k => {
        const val = result[k.nom];
        const isCalculated = calculatedFields.has(k.nom);
        if (val !== undefined && val !== null && val !== 0) {
          return `<span class="${isCalculated ? 'calculated' : ''}">${formatNumber(val)}${isCalculated ? ' üìê' : ''}</span>`;
        }
        return `<span class="empty">-</span>`;
      }).join('') +
        `<span style="background:#e3f2fd;color:#1565c0;font-weight:600;">${formatNumber(total)}</span>` +
        `<span style="background:#f3e5f5;color:#7b1fa2;font-weight:600;">${formatNumber(tva)}</span>`;

      // Labels sous les colonnes (avec indicateur formule)
      const labelCells = activeKeywords.map(k => {
        const isCalculated = calculatedFields.has(k.nom);
        return `<span style="background:${isCalculated ? '#e8f5e9' : '#f5f5f5'};color:${isCalculated ? '#2e7d32' : '#666'};font-size:9px;">${k.nom}${isCalculated ? ' ∆í' : ''}</span>`;
      }).join('') +
        '<span style="background:#e3f2fd;color:#1565c0;font-size:9px;">TOTAL ∆í</span>' +
        '<span style="background:#f3e5f5;color:#7b1fa2;font-size:9px;">TVA ∆í</span>';

      // Calculer si on a besoin des fl√®ches (plus de 6 colonnes)
      const needsNav = activeKeywords.length > 4;

      sheetEl.innerHTML = `
        <div class="mini-excel-wrapper">
          ${needsNav ? '<button class="excel-nav left" onclick="scrollExcel(-1)">‚Äπ</button>' : ''}
          <div class="mini-excel-container" id="excel-container">
            <div class="mini-excel">
              <div class="mini-excel-header">${headerCells}</div>
              <div class="mini-excel-row">${valueCells}</div>
              <div class="mini-excel-row" style="border-top:1px solid #e0e0e0;">${labelCells}</div>
            </div>
          </div>
          ${needsNav ? '<button class="excel-nav right" onclick="scrollExcel(1)">‚Ä∫</button>' : ''}
        </div>
      `;

      // V√©rifier si scroll n√©cessaire et afficher les fl√®ches
      setTimeout(() => updateExcelNavVisibility(), 50);

      // 7. Afficher les r√®gles appliqu√©es
      if (calcDetails.length > 0) {
        rulesEl.style.display = 'block';
        rulesEl.innerHTML = 'üìê ' + calcDetails.join(' ¬∑ ');
      } else {
        rulesEl.style.display = 'none';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatNumber(n) {
      if (n === undefined || n === null || n === 0) return '-';
      // Limiter √† 10000 et formater sans notation scientifique
      if (n > 10000) n = 10000;
      // Arrondir √† 2 d√©cimales si n√©cessaire
      if (n % 1 !== 0) n = Math.round(n * 100) / 100;
      return n.toLocaleString('fr-FR');
    }

    // Scroll du mini Excel
    function scrollExcel(direction) {
      const container = document.getElementById('excel-container');
      if (!container) return;
      const scrollAmount = 120;
      container.scrollLeft += direction * scrollAmount;
      setTimeout(() => updateExcelNavVisibility(), 100);
    }

    function updateExcelNavVisibility() {
      const container = document.getElementById('excel-container');
      if (!container) return;
      const leftBtn = document.querySelector('.excel-nav.left');
      const rightBtn = document.querySelector('.excel-nav.right');

      const canScroll = container.scrollWidth > container.clientWidth + 5;
      const atStart = container.scrollLeft < 5;
      const atEnd = container.scrollLeft >= container.scrollWidth - container.clientWidth - 5;

      // Fl√®che gauche : visible si pas au d√©but
      if (leftBtn) {
        if (canScroll && !atStart) {
          leftBtn.classList.add('visible');
        } else {
          leftBtn.classList.remove('visible');
        }
      }

      // Fl√®che droite : visible si pas √† la fin et scroll possible
      if (rightBtn) {
        if (canScroll && !atEnd) {
          rightBtn.classList.add('visible');
        } else {
          rightBtn.classList.remove('visible');
        }
      }
    }

    async function saveConfig(silent = false) {
      const indicator = document.getElementById('auto-save-indicator');

      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        if (!silent) toast('Session expir√©e', true);
        return;
      }

      const validKw = keywords.filter(k => k.nom.trim());
      const validRules = rules.filter(r => r.terms.some(t => t.name) && r.target);

      const newCfg = {
        ...(config?.excel_config || {}),
        colonnes_a_remplir: validKw.map(k => ({
          nom: k.nom,
          colonne: k.colonne || null,
          noteColumn: k.noteColumn || null,
          aliases: k.aliases.length ? k.aliases : [k.nom.toLowerCase()]
        })),
        regles_calcul: validRules.map(r => ({
          terms: r.terms.filter(t => t.name),
          target: r.target
        })),
        export_settings: exportSettings
      };

      const { error } = await supabaseClient.from('user_configs').update({
        excel_config: newCfg,
        updated_at: new Date().toISOString()
      }).eq('user_id', session.user.id);

      if (error) {
        if (!silent) toast('Erreur: ' + error.message, true);
        indicator.textContent = '‚úó Erreur';
        indicator.classList.remove('saving');
        setTimeout(() => indicator.classList.remove('show'), 2000);
        return;
      }

      // Mise √† jour du config local
      if (config) config.excel_config = newCfg;

      // Afficher confirmation
      indicator.textContent = '‚úì Sauvegard√©';
      indicator.classList.remove('saving');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }

    function toast(msg, err = false) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show' + (err ? ' error' : '');
      setTimeout(() => t.className = 'toast', 2500);
    }

    function resetConfig() {
      const modal = document.createElement('div');
      modal.id = 'reset-modal';
      modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
          <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; max-width: 320px; text-align: center;">
            <div style="font-size: 32px; margin-bottom: 12px;">üîÑ</div>
            <div style="font-size: 16px; font-weight: 600; color: white; margin-bottom: 8px;">Nouveau fichier ?</div>
            <div style="font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 20px;">Ta config actuelle sera supprim√©e et tu pourras cr√©er un nouveau fichier iArmy.</div>
            <div style="display: flex; gap: 10px;">
              <button onclick="document.getElementById('reset-modal').remove()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 13px; cursor: pointer;">Annuler</button>
              <button onclick="doResetConfig()" style="flex: 1; padding: 12px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; color: #f87171; font-size: 13px; font-weight: 600; cursor: pointer;">Supprimer</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function doResetConfig() {
      document.getElementById('reset-modal')?.remove();
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) return;
      await supabaseClient.from('user_configs').delete().eq('user_id', session.user.id);
      window.location.href = 'compta.html';
    }

    async function exportData() {
      if (!config?.sheet_id) { toast('Aucun fichier configur√©', true); return; }

      const month = document.getElementById('export-month').value;
      const format = document.getElementById('export-format').value;
      const year = new Date().getFullYear();
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      const sheetName = monthNames[parseInt(month) - 1] + ' ' + year;

      toast('Export en cours...');

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const res = await fetch(SUPABASE_URL + '/functions/v1/read-google-sheet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + session.access_token, 'apikey': SUPABASE_ANON_KEY },
          body: JSON.stringify({ sheetId: config.sheet_id, sheetName: sheetName })
        });
        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        const rows = result.data;
        if (format === 'csv') {
          const csv = rows.map(r => r.join(';')).join('\n');
          downloadFile(csv, `compta_${sheetName}.csv`, 'text/csv');
        } else {
          if (typeof XLSX !== 'undefined') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `compta_${sheetName}.xlsx`);
          } else {
            const csv = rows.map(r => r.join(';')).join('\n');
            downloadFile(csv, `compta_${sheetName}.csv`, 'text/csv');
          }
        }
        toast('Export termin√© !');
      } catch (err) {
        toast('Erreur: ' + err.message, true);
      }
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
