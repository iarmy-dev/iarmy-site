<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres Compta - iArmy</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FF6B35'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>i</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Space Grotesk', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #030303; color: white; min-height: 100vh; overflow-x: hidden; }
    .bg-gradient-animate { background: linear-gradient(135deg, #030303 0%, #0a0508 25%, #050808 50%, #080805 75%, #030303 100%); background-size: 400% 400%; animation: gradientShift 20s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .orb { position: fixed; border-radius: 50%; filter: blur(100px); animation: float 15s ease-in-out infinite; pointer-events: none; z-index: 0; }
    .orb-1 { width: 500px; height: 500px; background: linear-gradient(135deg, #FF6B35, #FF8B5E); top: -250px; right: -150px; opacity: 0.18; }
    .orb-2 { width: 400px; height: 400px; background: linear-gradient(135deg, #6B35FF, #8B5EFF); bottom: -200px; left: -150px; opacity: 0.18; animation-delay: -7s; }
    @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

    .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }

    .logo-i { width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35 0%, #FF8B5E 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
    .logo-i:hover { transform: scale(1.2) rotate(-15deg); box-shadow: 0 12px 40px rgba(255,107,53,0.6); }
    .nav-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,107,53,0.3); }

    .container { max-width: 600px; margin: 0 auto; padding: 90px 20px 40px; position: relative; z-index: 10; }

    /* Section titles */
    .section-title { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.4); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }

    /* Preview compact */
    .preview-box { background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(255,107,53,0.03) 100%); border: 1px solid rgba(255,107,53,0.2); border-radius: 16px; padding: 16px; margin-bottom: 24px; }
    .preview-input { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px 14px; color: white; font-size: 14px; font-family: inherit; margin-bottom: 12px; }
    .preview-input:focus { outline: none; border-color: #FF6B35; }
    .preview-input::placeholder { color: rgba(255,255,255,0.25); }
    .preview-result { display: flex; gap: 10px; }
    .preview-half { flex: 1; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; min-height: 50px; }
    .preview-label { font-size: 9px; color: rgba(255,255,255,0.35); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .tg-msg { background: #2AABEE; padding: 6px 10px; border-radius: 10px 10px 10px 2px; font-size: 12px; display: inline-block; }
    .sheet-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
    .sheet-col { background: rgba(255,107,53,0.25); color: #FF8B5E; padding: 2px 6px; border-radius: 4px; font-weight: 600; font-size: 10px; }
    .sheet-val { color: #4ADE80; font-weight: 500; }
    .empty-text { color: rgba(255,255,255,0.2); font-size: 11px; }

    /* Keyword chips - GRID of small squares */
    .kw-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-bottom: 12px; }
    .kw-chip { background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 12px 10px; text-align: center; position: relative; transition: all 0.2s; aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; }
    .kw-chip:hover { border-color: rgba(255,107,53,0.4); background: linear-gradient(135deg, rgba(255,107,53,0.1) 0%, rgba(255,107,53,0.03) 100%); }
    .kw-chip.active { border-color: rgba(255,107,53,0.5); background: linear-gradient(135deg, rgba(255,107,53,0.15) 0%, rgba(255,107,53,0.05) 100%); }
    .kw-name-input { background: none; border: none; color: white; font-weight: 600; font-size: 14px; width: 100%; text-align: center; font-family: inherit; }
    .kw-name-input:focus { outline: none; }
    .kw-name-input::placeholder { color: rgba(255,255,255,0.25); }
    .kw-col-select { background: rgba(255,107,53,0.2); border: none; border-radius: 6px; padding: 4px 8px; color: #FF8B5E; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; text-align: center; }
    .kw-col-select:focus { outline: none; }
    .kw-col-select.empty { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.3); }
    .kw-del { position: absolute; top: 4px; right: 4px; background: none; border: none; color: rgba(255,255,255,0.15); cursor: pointer; font-size: 12px; padding: 2px 4px; opacity: 0; transition: all 0.2s; }
    .kw-chip:hover .kw-del { opacity: 1; }
    .kw-del:hover { color: #ef4444; }
    .kw-note-btn { font-size: 10px; opacity: 0.4; cursor: pointer; }
    .kw-note-btn.active { opacity: 1; color: #4ADE80; }

    .kw-add { background: transparent; border: 1px dashed rgba(255,255,255,0.15); border-radius: 14px; padding: 12px; text-align: center; color: rgba(255,255,255,0.3); font-size: 20px; cursor: pointer; transition: all 0.2s; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; }
    .kw-add:hover { border-color: #FF6B35; color: #FF8B5E; }

    /* Rules compact */
    .rules-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .rule-chip { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 10px 12px; flex-wrap: wrap; }
    .rule-select { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 6px 10px; color: white; font-size: 12px; cursor: pointer; font-family: inherit; }
    .rule-select:focus { outline: none; border-color: #FF6B35; }
    .rule-op { color: #FF6B35; font-weight: 700; font-size: 14px; }
    .rule-arrow { color: rgba(255,255,255,0.25); font-size: 12px; }
    .rule-del { background: none; border: none; color: rgba(255,255,255,0.2); cursor: pointer; font-size: 14px; margin-left: auto; }
    .rule-del:hover { color: #ef4444; }
    .btn-add-rule { background: transparent; border: 1px dashed rgba(255,255,255,0.12); border-radius: 10px; padding: 10px; color: rgba(255,255,255,0.3); font-size: 12px; cursor: pointer; transition: all 0.2s; font-family: inherit; width: 100%; }
    .btn-add-rule:hover { border-color: #FF6B35; color: #FF8B5E; }

    /* Connexions compact */
    .conn-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; margin-bottom: 8px; }
    .conn-label { color: rgba(255,255,255,0.5); font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .conn-value { color: #4ADE80; font-size: 12px; font-weight: 500; }
    .conn-value a { color: inherit; text-decoration: none; }
    .conn-value a:hover { text-decoration: underline; }

    /* Save */
    .btn-save { width: 100%; padding: 14px; background: linear-gradient(135deg, #22C55E, #16A34A); border: none; border-radius: 14px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; margin-top: 20px; }
    .btn-save:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(34,197,94,0.3); }

    /* Toast */
    .toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%) translateY(-20px); padding: 10px 20px; background: #22C55E; border-radius: 10px; color: white; font-size: 13px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 1000; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.error { background: #ef4444; }

    footer a { color: rgba(255,255,255,0.4); text-decoration: none; transition: color 0.2s; }
    footer a:hover { color: #FF8B5E; }

    @media (max-width: 400px) { .kw-grid { grid-template-columns: repeat(3, 1fr); } }
  </style>
</head>
<body class="bg-gradient-animate">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <nav class="glass fixed top-0 left-0 right-0 z-50">
    <div class="max-w-xl mx-auto px-5 py-3 flex items-center justify-between">
      <a href="compte.html" class="flex items-center gap-2 text-sm text-white/50 hover:text-white transition-colors">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Retour
      </a>
      <a href="index.html" class="flex items-center gap-2">
        <div class="logo-i">i</div>
        <span class="font-semibold">iArmy</span>
      </a>
      <a href="compte.html">
        <img src="" class="nav-avatar" id="nav-avatar" alt="">
      </a>
    </div>
  </nav>

  <div class="container">
    <!-- Preview -->
    <div class="preview-box">
      <input type="text" class="preview-input" id="test-input" placeholder="üß™ Teste : cb 1200 esp 800" oninput="updatePreview()">
      <div class="preview-result">
        <div class="preview-half">
          <div class="preview-label">üì± Telegram</div>
          <div id="preview-tg"><span class="empty-text">...</span></div>
        </div>
        <div class="preview-half">
          <div class="preview-label">üìä Sheets</div>
          <div id="preview-sheet"><span class="empty-text">...</span></div>
        </div>
      </div>
    </div>

    <!-- Keywords -->
    <div class="section-title">üè∑Ô∏è Mots-cl√©s</div>
    <div class="kw-grid" id="kw-grid"></div>

    <!-- Rules -->
    <div class="section-title" style="margin-top: 24px;">üîó R√®gles <span style="font-size: 9px; padding: 2px 6px; background: rgba(255,255,255,0.05); border-radius: 4px; color: rgba(255,255,255,0.25); text-transform: none; letter-spacing: 0; margin-left: 6px;">optionnel</span></div>
    <div class="rules-list" id="rules-list"></div>
    <button class="btn-add-rule" onclick="addRule()">+ R√®gle</button>

    <!-- Connexions -->
    <div class="section-title" style="margin-top: 24px;">üîå Connexions</div>
    <div class="conn-row">
      <span class="conn-label">üìä Sheets</span>
      <span class="conn-value" id="info-sheet">-</span>
    </div>
    <div class="conn-row">
      <span class="conn-label">üì± Telegram</span>
      <span class="conn-value" id="info-tg">-</span>
    </div>

    <button class="btn-save" onclick="saveConfig()">üíæ Sauvegarder</button>
  </div>

  <footer style="padding: 30px 20px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); margin-top: 30px;">
    <div style="display: flex; justify-content: center; gap: 20px; font-size: 13px;">
      <a href="index.html">Accueil</a>
      <a href="compte.html">Compte</a>
      <a href="mailto:contact@iarmy.fr">Contact</a>
    </div>
    <p style="color: rgba(255,255,255,0.25); font-size: 11px; text-align: center; margin-top: 12px;">¬© 2026 iArmy</p>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL = 'https://byqfnpdcnifauhwgetcq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5cWZucGRjbmlmYXVod2dldGNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODY1MTIsImV4cCI6MjA4MzQ2MjUxMn0.1W2OaRb0sApMvrG_28AoV2zUFAzrptzpwbR1c65tOPo';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let config = null, keywords = [], rules = [];
    const cols = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) { location.href = 'index.html'; return; }
      const avatar = session.user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${session.user.email}&background=FF6B35&color=fff`;
      document.getElementById('nav-avatar').src = avatar;
      await loadConfig(session.user.id);
    }

    async function loadConfig(userId) {
      const { data: cfg } = await supabaseClient.from('user_configs').select('sheet_id, excel_config').eq('user_id', userId).single();
      const { data: tg } = await supabaseClient.from('telegram_links').select('telegram_user_id').eq('user_id', userId).maybeSingle();

      config = cfg;
      keywords = (cfg?.excel_config?.colonnes_a_remplir || []).map(c => ({ nom: c.nom, colonne: c.colonne || '', noteColumn: c.noteColumn || '', aliases: c.aliases || [] }));
      rules = (cfg?.excel_config?.regles_calcul || []).map(r => ({ sources: r.sources || [], target: r.target || '' }));

      render();
      if (cfg?.sheet_id) document.getElementById('info-sheet').innerHTML = `<a href="https://docs.google.com/spreadsheets/d/${cfg.sheet_id}/edit" target="_blank">Ouvrir ‚Üó</a>`;
      if (tg?.telegram_user_id) document.getElementById('info-tg').textContent = '‚úì Connect√©';
    }

    function render() { renderKw(); renderRules(); updatePreview(); }

    function renderKw() {
      const grid = document.getElementById('kw-grid');
      grid.innerHTML = keywords.map((k, i) => `
        <div class="kw-chip ${k.colonne ? 'active' : ''}">
          <button class="kw-del" onclick="delKw(${i})">√ó</button>
          <input class="kw-name-input" value="${k.nom}" onchange="updKw(${i},'nom',this.value)" placeholder="...">
          <select class="kw-col-select ${!k.colonne?'empty':''}" onchange="updKw(${i},'colonne',this.value)">
            <option value="">Col</option>
            ${cols.map(c=>`<option value="${c}" ${k.colonne===c?'selected':''}>${c}</option>`).join('')}
          </select>
          <span class="kw-note-btn ${k.noteColumn?'active':''}" onclick="toggleNote(${i})" title="Colonne note">${k.noteColumn ? 'üìù'+k.noteColumn : 'üìù'}</span>
        </div>
      `).join('') + `<button class="kw-add" onclick="addKw()">+</button>`;
    }

    function renderRules() {
      const names = keywords.map(k=>k.nom).filter(n=>n);
      document.getElementById('rules-list').innerHTML = rules.map((r,i) => `
        <div class="rule-chip">
          <select class="rule-select" onchange="rules[${i}].sources[0]=this.value;updatePreview()">
            <option value="">...</option>
            ${names.map(n=>`<option value="${n}" ${r.sources[0]===n?'selected':''}>${n}</option>`).join('')}
          </select>
          <span class="rule-op">+</span>
          <select class="rule-select" onchange="rules[${i}].sources[1]=this.value;updatePreview()">
            <option value="">...</option>
            ${names.map(n=>`<option value="${n}" ${r.sources[1]===n?'selected':''}>${n}</option>`).join('')}
          </select>
          <span class="rule-arrow">‚Üí</span>
          <select class="rule-select" onchange="rules[${i}].target=this.value;updatePreview()">
            <option value="">...</option>
            ${names.map(n=>`<option value="${n}" ${r.target===n?'selected':''}>${n}</option>`).join('')}
          </select>
          <button class="rule-del" onclick="rules.splice(${i},1);render()">√ó</button>
        </div>
      `).join('');
    }

    function addKw() { keywords.push({nom:'',colonne:'',noteColumn:'',aliases:[]}); render(); }
    function updKw(i,f,v) {
      if(f==='nom') { keywords[i].nom=v.toUpperCase(); keywords[i].aliases=[v.toLowerCase()]; }
      else keywords[i][f]=v;
      render();
    }
    function delKw(i) { keywords.splice(i,1); render(); }
    function addRule() { rules.push({sources:['',''],target:''}); render(); }

    function toggleNote(i) {
      const current = keywords[i].noteColumn;
      if (current) {
        keywords[i].noteColumn = '';
      } else {
        const col = prompt('Colonne pour les notes (ex: K):');
        if (col && /^[A-Z]$/i.test(col.trim())) {
          keywords[i].noteColumn = col.trim().toUpperCase();
        }
      }
      render();
    }

    function updatePreview() {
      const txt = document.getElementById('test-input').value.trim();
      const tgEl = document.getElementById('preview-tg');
      const shEl = document.getElementById('preview-sheet');

      if (!txt) {
        tgEl.innerHTML = '<span class="empty-text">...</span>';
        shEl.innerHTML = '<span class="empty-text">...</span>';
        return;
      }

      tgEl.innerHTML = `<div class="tg-msg">${txt}</div>`;

      const parsed = {};
      for (const k of keywords) {
        if (!k.nom) continue;
        const re = new RegExp(`\\b${k.nom.toLowerCase()}\\s*:?\\s*([0-9]+(?:[.,][0-9]+)?)`, 'i');
        const m = txt.toLowerCase().match(re);
        if (m) parsed[k.nom] = parseFloat(m[1].replace(',','.'));
      }
      for (const r of rules) {
        if (r.sources[0] && r.sources[1] && r.target) {
          const sum = (parsed[r.sources[0]]||0) + (parsed[r.sources[1]]||0);
          if (sum > 0) parsed[r.target] = sum;
        }
      }

      const rows = keywords.filter(k => k.nom && k.colonne && parsed[k.nom] > 0)
        .map(k => `<div class="sheet-item"><span class="sheet-col">${k.colonne}</span><span class="sheet-val">${parsed[k.nom].toFixed(0)}‚Ç¨</span></div>`);
      shEl.innerHTML = rows.length ? rows.join('') : '<span class="empty-text">-</span>';
    }

    async function saveConfig() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) return;

      const validKw = keywords.filter(k => k.nom.trim());
      const validRules = rules.filter(r => r.sources[0] && r.sources[1] && r.target);

      const newCfg = {
        ...(config?.excel_config || {}),
        colonnes_a_remplir: validKw.map(k => ({ nom: k.nom, colonne: k.colonne||null, noteColumn: k.noteColumn||null, aliases: k.aliases.length ? k.aliases : [k.nom.toLowerCase()] })),
        regles_calcul: validRules.map(r => ({ sources: r.sources, operation: 'add', target: r.target }))
      };

      const { error } = await supabaseClient.from('user_configs').update({ excel_config: newCfg, updated_at: new Date().toISOString() }).eq('user_id', session.user.id);

      if (error) { toast('Erreur: ' + error.message, true); return; }
      toast('‚úì Sauvegard√© !');
    }

    function toast(msg, err=false) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show' + (err?' error':'');
      setTimeout(() => t.className = 'toast', 2500);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
